<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#000000">
    <title>Orbit Pro | Solar OS V84</title>
    
    <!-- Preconnect for speed -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://dhtbiggamuwoqurguhib.supabase.co">
    <!-- Fonts with font-display:swap -->
    <link href="https://fonts.googleapis.com/css2?family=Syne:wght@700;800&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
    <!-- Font Awesome - defer via preload -->
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"></noscript>
    <!-- Critical scripts - supabase loads first -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Cropper CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <!-- Non-critical scripts deferred -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js" defer></script>

    <style>
        :root {
            --gold: #FFD700;
            --gold-dim: rgba(255, 215, 0, 0.15);
            --gold-bright: rgba(255,215,0,0.9);
            --bg: #080808;
            --surface: #111111;
            --surface-light: #181818;
            --border: rgba(255,255,255,0.07);
            --text: #F2F2F2;
            --text-sec: #707070;
            --msg-own: #FFD700;
            --msg-own-text: #000;
            --msg-other: #1C1C1C;
            --online: #00E676;
            --offline: #FF4444;
            --away: #FFAA00;
            --radius: 18px;
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
            --select-bg: rgba(255,215,0,0.08);
        }
        .light-mode {
            --bg: #F0F0F0;
            --surface: #FFFFFF;
            --surface-light: #F5F5F5;
            --border: rgba(0,0,0,0.09);
            --text: #0A0A0A;
            --text-sec: #666;
            --msg-own: #FFB800;
            --msg-own-text: #000;
            --msg-other: #E0E0E0;
        }

        *{box-sizing:border-box;-webkit-tap-highlight-color:transparent;outline:none;user-select:none;-webkit-user-drag:none;}
        html,body{margin:0;padding:0;width:100%;height:100%;background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;overflow:hidden;touch-action:pan-y;transition:background .3s,color .3s;}

        .hide{display:none!important;}
        .flex{display:flex;}
        .flex-col{flex-direction:column;}
        .center{align-items:center;justify-content:center;}
        .btn-reset{border:none;background:none;padding:0;margin:0;cursor:pointer;color:inherit;}
        .touch-fix{touch-action:manipulation;}

        #app-viewport{width:100%;height:100%;position:relative;overflow:hidden;background:var(--bg);}
        @media(min-width:768px){
            body{display:flex;align-items:center;justify-content:center;background:#000;}
            #app-viewport{width:420px;height:860px;max-height:95vh;border-radius:28px;box-shadow:0 0 80px rgba(255,215,0,0.08),0 30px 80px rgba(0,0,0,0.8);border:1px solid var(--border);}
        }

        .screen{position:absolute;inset:0;display:flex;flex-direction:column;background:var(--bg);transform:translateX(100%);transition:transform .32s cubic-bezier(.25,.8,.25,1);z-index:10;}
        .screen.active{transform:translateX(0);z-index:20;}
        .screen.z-top{z-index:50;}

        /* AUTH */
        .auth-wrap{padding:48px 32px;text-align:center;display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;}
        .brand-ring{width:80px;height:80px;margin:0 auto 24px;animation:pulse-brand 2.4s ease-in-out infinite;display:flex;align-items:center;justify-content:center;}
        @keyframes pulse-brand{0%,100%{transform:scale(1);filter:drop-shadow(0 0 12px rgba(255,215,0,0.55));}50%{transform:scale(1.06);filter:drop-shadow(0 0 28px rgba(255,215,0,0.8));}}
        .brand-name{font-family:'Syne',sans-serif;font-weight:800;font-size:32px;letter-spacing:-1px;margin-bottom:4px;}
        .brand-sub{font-size:11px;color:var(--text-sec);letter-spacing:2px;font-weight:600;margin-bottom:36px;}
        .input-box{width:100%;padding:15px 16px;background:var(--surface);border:1.5px solid var(--border);border-radius:14px;color:var(--text);margin-bottom:12px;font-size:15px;font-family:'DM Sans',sans-serif;transition:border-color .2s;}
        .input-box:focus{border-color:var(--gold);}
        .btn-primary{width:100%;padding:16px;background:var(--gold);color:#000;font-weight:700;border-radius:14px;font-size:15px;font-family:'Syne',sans-serif;letter-spacing:.5px;border:none;cursor:pointer;transition:opacity .2s,transform .1s;}
        .btn-primary:active{opacity:.85;transform:scale(.98);}
        .password-container{position:relative;width:100%;}
        .password-toggle{position:absolute;right:14px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--text-sec);cursor:pointer;font-size:15px;padding:4px;}
        .auth-opts{margin-top:16px;display:flex;justify-content:space-between;align-items:center;font-size:12px;}
        .auth-link{color:var(--gold);text-decoration:none;font-weight:600;}

        /* DASHBOARD */
        .dash-nav{padding:calc(14px + var(--safe-top)) 20px 10px;display:flex;justify-content:space-between;align-items:center;}
        .dash-title{font-family:'Syne',sans-serif;font-weight:800;font-size:26px;letter-spacing:-0.5px;}
        .user-chip{display:flex;align-items:center;gap:10px;background:var(--surface);padding:6px 14px 6px 6px;border-radius:30px;border:1px solid var(--border);cursor:pointer;}
        .av-sm{width:30px;height:30px;background:linear-gradient(135deg,#2a2a2a,#111);border-radius:50%;color:var(--gold);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:12px;font-family:'Syne',sans-serif;position:relative;}
        .av-dot{position:absolute;bottom:0;right:0;width:9px;height:9px;background:var(--online);border-radius:50%;border:2px solid var(--bg);}
        .online-pill{display:flex;align-items:center;gap:5px;font-size:10px;color:var(--online);padding:4px 10px;background:rgba(0,230,118,0.08);border-radius:20px;font-weight:600;}
        .online-pill i{font-size:7px;}

        .search-row{padding:8px 20px;}
        .search-inner{width:100%;background:var(--surface);border:1px solid var(--border);padding:11px 14px;border-radius:12px;display:flex;align-items:center;gap:10px;}
        .search-inner input{background:transparent;border:none;color:var(--text);width:100%;font-size:14px;font-family:'DM Sans',sans-serif;}
        .search-inner input::placeholder{color:var(--text-sec);}

        .dash-tabs{display:flex;padding:0 20px;gap:6px;border-bottom:1px solid var(--border);overflow-x:auto;scrollbar-width:none;}
        .dash-tabs::-webkit-scrollbar{display:none;}
        .tab-btn{padding:10px 0;min-width:56px;background:none;border:none;color:var(--text-sec);font-size:12px;font-weight:600;border-bottom:2px solid transparent;cursor:pointer;white-space:nowrap;font-family:'DM Sans',sans-serif;transition:color .2s;}
        .tab-btn.active{color:var(--gold);border-bottom-color:var(--gold);}

        .contact-list{padding:0 10px;overflow-y:auto;flex:1;scroll-behavior:smooth;}
        .contact-item{display:flex;align-items:center;gap:14px;padding:12px;border-radius:16px;transition:background .15s;cursor:pointer;position:relative;}
        .contact-item:active{background:var(--surface);}
        .c-av{width:50px;height:50px;border-radius:50%;background:#1a1a1a;position:relative;border:1px solid var(--border);flex-shrink:0;overflow:hidden;}
        .c-av img{width:100%;height:100%;border-radius:50%;object-fit:cover;}
        .c-av-inner{width:100%;height:100%;display:flex;align-items:center;justify-content:center;border-radius:50%;background:#1e1e1e;color:var(--gold);font-weight:700;font-size:18px;font-family:'Syne',sans-serif;}
        .c-status-dot{position:absolute;bottom:1px;right:1px;width:13px;height:13px;border:2.5px solid var(--bg);border-radius:50%;}
        .c-status-dot.online{background:var(--online);}
        .c-status-dot.offline{background:var(--offline);}
        .c-info{flex:1;overflow:hidden;}
        .c-name{font-weight:600;font-size:15px;margin-bottom:2px;}
        .c-last{font-size:12px;color:var(--text-sec);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
        .c-meta{display:flex;flex-direction:column;align-items:flex-end;gap:5px;}
        .c-time{font-size:10px;color:var(--text-sec);}
        .unread-badge{background:var(--gold);color:#000;font-size:10px;font-weight:800;padding:2px 7px;border-radius:20px;font-family:'Syne',sans-serif;}

        /* MODAL */
        .modal-overlay{position:absolute;inset:0;background:rgba(0,0,0,.85);z-index:200;display:none;align-items:center;justify-content:center;backdrop-filter:blur(4px);}
        .modal-overlay.active{display:flex;}
        .modal-box{background:var(--surface);width:90%;max-width:360px;border-radius:20px;padding:24px;border:1px solid var(--border);}
        .modal-title{font-family:'Syne',sans-serif;font-weight:700;font-size:18px;margin-bottom:16px;}
        .modal-input{width:100%;padding:13px 14px;background:var(--surface-light);border:1.5px solid var(--border);border-radius:12px;color:var(--text);margin-bottom:14px;font-size:14px;font-family:'DM Sans',sans-serif;}
        .modal-input:focus{border-color:var(--gold);}
        .modal-btns{display:flex;gap:10px;}
        .modal-btn{flex:1;padding:13px;border-radius:12px;border:none;font-weight:700;cursor:pointer;font-size:14px;font-family:'Syne',sans-serif;}
        .modal-btn.cancel{background:var(--surface-light);color:var(--text);}
        .modal-btn.create{background:var(--gold);color:#000;}

        /* NOTES */
        .note-card{background:var(--surface);border-radius:14px;padding:16px;margin-bottom:10px;border-left:3px solid var(--gold);position:relative;}
        .note-title{font-weight:700;margin-bottom:5px;font-size:14px;font-family:'Syne',sans-serif;}
        .note-body{color:var(--text-sec);font-size:13px;white-space:pre-wrap;word-break:break-word;}
        .note-actions{position:absolute;top:12px;right:12px;display:flex;gap:8px;}
        .note-btn{width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.4);color:var(--gold);border:none;cursor:pointer;font-size:12px;}
        .note-date{font-size:10px;color:var(--text-sec);margin-top:8px;}

        .app-footer{text-align:center;padding:16px;font-size:10px;color:var(--text-sec);border-top:1px solid var(--border);margin-top:auto;}

        /* CHAT */
        .chat-header{padding:calc(12px + var(--safe-top)) 16px 12px;background:var(--bg);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:14px;z-index:20;flex-shrink:0;}
        .chat-name{font-family:'Syne',sans-serif;font-weight:700;font-size:16px;}
        .chat-status{font-size:11px;color:var(--gold);}
        .chat-info{flex:1;}

        .chat-feed{flex:1;overflow-y:auto;padding:14px;display:flex;flex-direction:column;gap:3px;min-height:0;scroll-behavior:smooth;}
        .chat-feed::-webkit-scrollbar{width:3px;}
        .chat-feed::-webkit-scrollbar-thumb{background:rgba(255,215,0,0.2);border-radius:2px;}

        /* MESSAGES */
        .msg-row{display:flex;width:100%;margin-bottom:2px;position:relative;transition:transform .2s,background .2s;flex-direction:column;}
        .msg-row.own{align-items:flex-end;}
        .msg-row.other{align-items:flex-start;}
        .msg-row.swiping{transform:translateX(55px);}
        .msg-row.selected{background:var(--select-bg);border-radius:10px;}
        .msg-row.selected::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;background:var(--gold);border-radius:3px;}
        .msg-bubble{max-width:76%;padding:9px 13px;border-radius:14px;position:relative;font-size:14px;line-height:1.5;word-wrap:break-word;}
        .msg-row.own .msg-bubble{background:var(--msg-own);color:var(--msg-own-text);border-bottom-right-radius:3px;}
        .msg-row.other .msg-bubble{background:var(--msg-other);color:var(--text);border-bottom-left-radius:3px;}
        .msg-row.sending .msg-bubble{opacity:.65;}
        .msg-row.failed .msg-bubble{border:1px solid #ff4444;opacity:.55;}
        .msg-row.pinned{border-left:3px solid var(--gold);padding-left:8px;}

        .msg-checkbox{position:absolute;left:5px;top:50%;transform:translateY(-50%);width:20px;height:20px;border:2px solid var(--gold);border-radius:5px;background:rgba(0,0,0,.5);display:none;cursor:pointer;z-index:2;}
        .msg-row.select-mode .msg-checkbox{display:flex;align-items:center;justify-content:center;}
        .msg-row.select-mode.own .msg-checkbox{left:auto;right:5px;}
        .msg-checkbox.checked{background:var(--gold);}
        .msg-checkbox.checked::after{content:'✓';color:#000;font-size:12px;font-weight:bold;}

        .msg-meta{display:flex;align-items:center;justify-content:flex-end;gap:4px;font-size:9px;margin-top:4px;opacity:.65;}
        .msg-row.own .msg-meta{color:rgba(0,0,0,.5);}
        .tick-icon{font-size:10px;}
        .tick-read{color:#007AFF;}
        .tick-dlvd{color:rgba(0,0,0,.4);}
        .msg-loader{display:inline-block;width:11px;height:11px;border:2px solid rgba(0,0,0,.1);border-radius:50%;border-top-color:#000;animation:spin 1s linear infinite;margin-left:4px;}
        @keyframes spin{to{transform:rotate(360deg)}}

        /* FOOTER */
        .chat-footer{padding:10px;background:var(--surface-light);display:flex;flex-direction:column;gap:8px;border-top:1px solid var(--border);padding-bottom:calc(10px + var(--safe-bottom));flex-shrink:0;}
        .chat-footer-row{display:flex;align-items:center;gap:10px;}
        .input-wrapper{flex:1;background:var(--surface);border-radius:22px;border:1px solid var(--border);display:flex;align-items:center;padding:9px 14px;min-height:42px;}
        .msg-input{background:transparent;border:none;color:var(--text);width:100%;max-height:100px;font-family:'DM Sans',sans-serif;font-size:15px;resize:none;padding:0;margin:0;line-height:1.4;}
        .msg-input::placeholder{color:var(--text-sec);}
        .footer-btn{width:42px;height:42px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px;color:var(--gold);transition:.2s;border:none;background:none;cursor:pointer;flex-shrink:0;}
        .footer-btn:active{background:rgba(255,255,255,.08);transform:scale(.9);}
        .send-gold{background:var(--gold);color:#000;}
        .send-gold:active{opacity:.85;transform:scale(.92);}

        /* MEDIA PREVIEW */
        .media-preview-strip{display:flex;gap:8px;overflow-x:auto;padding:4px 4px 6px;scrollbar-width:none;flex-wrap:nowrap;align-items:flex-end;}
        .media-preview-strip::-webkit-scrollbar{display:none;}
        .media-thumb{position:relative;width:72px;height:72px;border-radius:12px;overflow:hidden;border:2px solid var(--border);flex-shrink:0;background:#111;}
        .media-thumb img,.media-thumb video{width:100%;height:100%;object-fit:cover;}
        .media-thumb .play-over{position:absolute;inset:0;background:rgba(0,0,0,.4);display:flex;align-items:center;justify-content:center;color:#fff;font-size:18px;}
        .remove-mb{position:absolute;top:3px;right:3px;background:rgba(220,0,0,.9);color:#fff;border:none;width:18px;height:18px;border-radius:50%;font-size:9px;display:flex;align-items:center;justify-content:center;cursor:pointer;z-index:2;}

        /* SELECTION TOOLBAR */
        .sel-toolbar{position:absolute;bottom:0;left:0;right:0;background:var(--surface-light);border-top:1px solid var(--border);padding:12px;display:flex;justify-content:space-around;align-items:center;transform:translateY(100%);transition:transform .3s;z-index:100;}
        .sel-toolbar.active{transform:translateY(0);}
        .sel-count{color:var(--gold);font-weight:700;font-size:14px;font-family:'Syne',sans-serif;}
        .sel-btn{background:none;border:none;color:var(--gold);font-size:18px;cursor:pointer;padding:8px 14px;border-radius:10px;}
        .sel-btn:active{background:rgba(255,215,0,.1);}

        /* REPLY BAR */
        .reply-bar{background:var(--surface);padding:8px 14px;border-top:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;border-left:3px solid var(--gold);flex-shrink:0;}
        .reply-content{flex:1;font-size:12px;overflow:hidden;}
        .reply-title{color:var(--gold);font-weight:700;margin-bottom:2px;}
        .reply-txt{color:var(--text-sec);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
        .reply-context{background:rgba(0,0,0,.12);border-left:2px solid var(--gold);padding:4px 8px;border-radius:5px;margin-bottom:5px;font-size:11px;cursor:pointer;}
        .reply-author{color:var(--gold);font-weight:700;margin-bottom:1px;}
        .reply-preview{color:rgba(0,0,0,.5);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
        .msg-row.other .reply-preview{color:#aaa;}

        /* MEDIA SHEET */
        .media-sheet{position:absolute;inset:0;background:rgba(0,0,0,.65);z-index:100;display:none;align-items:flex-end;}
        .media-sheet.active{display:flex;animation:fadeIn .2s;}
        .sheet-box{width:100%;background:#171717;border-radius:24px 24px 0 0;padding:20px;border-top:1px solid var(--border);transform:translateY(100%);transition:transform .3s cubic-bezier(.2,.8,.2,1);}
        .media-sheet.active .sheet-box{transform:translateY(0);}
        .sheet-handle{width:40px;height:5px;background:rgba(255,255,255,.15);border-radius:5px;margin:0 auto 20px;}
        .media-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-bottom:18px;}
        .media-opt{display:flex;flex-direction:column;align-items:center;gap:8px;cursor:pointer;}
        .m-icon{width:52px;height:52px;border-radius:18px;display:flex;align-items:center;justify-content:center;font-size:20px;color:#fff;box-shadow:0 4px 14px rgba(0,0,0,.3);}
        .media-opt span{font-size:11px;opacity:.7;font-weight:600;}
        .btn-cancel{width:100%;padding:15px;background:rgba(255,255,255,.07);border:none;border-radius:14px;color:#fff;font-weight:700;font-size:15px;cursor:pointer;font-family:'Syne',sans-serif;}

        /* IMAGE EDITOR */
        .fullscreen-modal{position:absolute;inset:0;background:#000;z-index:200;display:flex;flex-direction:column;}
        .editor-header{padding:calc(12px + var(--safe-top)) 20px 12px;display:flex;justify-content:space-between;align-items:center;background:rgba(0,0,0,.8);flex-shrink:0;}
        .btn-icon{width:40px;height:40px;display:flex;align-items:center;justify-content:center;background:none;border:none;color:#fff;font-size:20px;cursor:pointer;}
        .btn-text-gold{color:var(--gold);background:none;border:none;font-weight:700;font-size:16px;cursor:pointer;font-family:'Syne',sans-serif;}
        .editor-canvas{flex:1;background:#111;position:relative;display:flex;align-items:center;justify-content:center;overflow:hidden;min-height:0;}
        .editor-canvas img{max-width:100%;max-height:100%;}
        .editor-tools{padding:14px;background:#111;display:flex;flex-direction:column;gap:10px;flex-shrink:0;}
        .tool-label{font-size:10px;color:#888;font-weight:700;letter-spacing:.8px;}
        .tools-row{display:flex;gap:8px;flex-wrap:wrap;}
        .etool{background:#222;border:1px solid var(--border);color:#fff;padding:8px 12px;border-radius:9px;font-size:12px;display:flex;align-items:center;gap:5px;cursor:pointer;font-family:'DM Sans',sans-serif;}
        .etool:active{background:var(--gold);color:#000;}
        .filter-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;}
        .filter-item{aspect-ratio:1;border-radius:9px;overflow:hidden;border:2px solid transparent;cursor:pointer;position:relative;background:#222;display:flex;align-items:center;justify-content:center;}
        .filter-item.active{border-color:var(--gold);}
        .filter-label{font-size:9px;color:#fff;text-align:center;position:absolute;bottom:3px;left:0;right:0;text-shadow:0 1px 3px #000;}
        .swatch{width:100%;height:100%;}
        .sw-normal{background:linear-gradient(135deg,#444,#222);}
        .sw-bw{background:linear-gradient(135deg,#888,#333);filter:grayscale(100%);}
        .sw-vintage{background:linear-gradient(135deg,#8B6914,#5C3D0E);}
        .sw-bright{background:linear-gradient(135deg,#fff,#ccc);}
        .sw-contrast{background:linear-gradient(135deg,#fff 0%,#000 100%);}
        .sw-vivid{background:linear-gradient(135deg,#ff6b6b,#4ecdc4);}
        .discard-btn{position:absolute;bottom:12px;left:12px;background:rgba(255,0,0,.8);color:#fff;border:none;padding:8px 14px;border-radius:20px;font-size:12px;cursor:pointer;z-index:10;display:flex;align-items:center;gap:5px;font-family:'DM Sans',sans-serif;font-weight:600;}

        /* VIDEO PREVIEW */
        .video-modal{position:absolute;inset:0;background:#000;z-index:200;display:flex;flex-direction:column;}
        .video-body{flex:1;display:flex;align-items:center;justify-content:center;padding:12px;min-height:0;}
        .video-body video{max-width:100%;max-height:100%;border-radius:10px;}

        /* UPLOAD OVERLAY */
        .upload-screen{position:absolute;inset:0;background:rgba(0,0,0,.92);z-index:300;display:flex;flex-direction:column;align-items:center;justify-content:center;backdrop-filter:blur(8px);}
        .upload-ring{position:relative;width:120px;height:120px;}
        .progress-ring__circle{stroke-dasharray:326;stroke-dashoffset:326;transition:stroke-dashoffset .15s linear;transform:rotate(-90deg);transform-origin:50% 50%;}
        .upload-pct{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:22px;font-family:'Syne',sans-serif;color:var(--gold);}
        .upload-label{margin-top:18px;font-weight:700;color:#fff;font-size:15px;font-family:'Syne',sans-serif;}
        .upload-sub{margin-top:5px;font-size:12px;color:var(--text-sec);}
        .upload-file-lbl{text-align:center;margin-top:6px;font-size:12px;color:#aaa;max-width:240px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;padding:0 12px;}

        /* CTX MENU */
        .ctx-overlay{position:fixed;inset:0;z-index:500;background:rgba(0,0,0,.12);display:none;}
        .ctx-overlay.active{display:block;}
        .ctx-menu{position:absolute;background:rgba(18,18,18,.97);backdrop-filter:blur(24px);width:220px;border-radius:18px;overflow:hidden;box-shadow:0 12px 50px rgba(0,0,0,.75);border:1px solid var(--border);transform:scale(.88);opacity:0;transition:.2s cubic-bezier(.2,.8,.2,1);z-index:1000;pointer-events:none;}
        .ctx-menu.active{transform:scale(1);opacity:1;pointer-events:auto;}
        .ctx-item{padding:13px 16px;color:#fff;font-size:14px;border-bottom:1px solid rgba(255,255,255,.05);display:flex;gap:12px;align-items:center;cursor:pointer;font-family:'DM Sans',sans-serif;}
        .ctx-item:last-child{border-bottom:none;}
        .ctx-item:active{background:rgba(255,255,255,.08);}
        .ctx-item.del{color:#ff4444;}
        .ctx-divider{height:1px;background:rgba(255,255,255,.08);margin:3px 0;}

        /* DATE BADGE */
        .date-badge{text-align:center;margin:14px 0;position:sticky;top:0;z-index:5;}
        .date-badge span{background:rgba(28,28,28,.88);backdrop-filter:blur(4px);color:#888;padding:4px 12px;border-radius:20px;font-size:10px;font-weight:700;border:1px solid var(--border);}

        /* MEDIA IN MSG */
        .image-grid{display:grid;gap:3px;margin-bottom:4px;}
        .image-grid.g1{grid-template-columns:1fr;}
        .image-grid.g2{grid-template-columns:repeat(2,1fr);}
        .image-grid.g3{grid-template-columns:repeat(2,1fr);grid-template-rows:repeat(2,1fr);}
        .image-grid.g3 .gi:first-child{grid-column:1/span 2;}
        .image-grid.g4{grid-template-columns:repeat(2,1fr);grid-template-rows:repeat(2,1fr);}
        .gi{width:100%;height:150px;object-fit:cover;border-radius:8px;cursor:pointer;background:#000;display:block;}
        .gi-more{position:relative;cursor:pointer;overflow:hidden;border-radius:8px;height:150px;}
        .gi-more img{width:100%;height:100%;object-fit:cover;}
        .gi-more-over{position:absolute;inset:0;background:rgba(0,0,0,.68);color:#fff;display:flex;align-items:center;justify-content:center;font-size:26px;font-weight:800;font-family:'Syne',sans-serif;}
        .single-img{max-width:210px;border-radius:10px;display:block;cursor:pointer;margin-bottom:4px;}
        .msg-video{max-width:210px;border-radius:10px;display:block;cursor:pointer;margin-bottom:4px;background:#000;}
        .doc-card{background:rgba(0,0,0,.2);padding:10px;border-radius:10px;display:flex;align-items:center;gap:10px;cursor:pointer;}
        .doc-card:active{background:rgba(0,0,0,.3);}
        .doc-icon{font-size:26px;color:#FF3B30;}
        .doc-name{font-weight:600;font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
        .doc-sub{font-size:10px;color:#aaa;}

        /* TYPING INDICATOR */
        .typing-indicator{display:none;align-items:center;gap:8px;padding:8px 14px;color:var(--text-sec);font-size:12px;}
        .typing-indicator.show{display:flex;}
        .typing-dots{display:flex;gap:4px;align-items:center;}
        .typing-dots span{width:6px;height:6px;background:var(--gold);border-radius:50%;animation:typing-bounce 1.2s infinite;}
        .typing-dots span:nth-child(2){animation-delay:.2s;}
        .typing-dots span:nth-child(3){animation-delay:.4s;}
        @keyframes typing-bounce{0%,80%,100%{transform:scale(0.8);opacity:0.5;}40%{transform:scale(1);opacity:1;}}

        /* REACTION BUTTON */
        .msg-reactions{display:flex;flex-wrap:wrap;gap:4px;margin-top:-6px;margin-bottom:4px;padding:0 4px;}
        .msg-row.own .msg-reactions{justify-content:flex-end;}
        .msg-row.other .msg-reactions{justify-content:flex-start;}
        .reaction-pill{background:var(--surface);border:1.5px solid rgba(255,215,0,0.25);border-radius:20px;padding:3px 8px;font-size:13px;cursor:pointer;display:inline-flex;align-items:center;gap:4px;transition:.15s;box-shadow:0 1px 4px rgba(0,0,0,0.3);}
        .reaction-pill:active{transform:scale(0.94);background:rgba(255,215,0,0.12);}
        .reaction-pill.reacted-me{border-color:var(--gold);background:rgba(255,215,0,0.12);}
        .reaction-pill .r-count{font-size:11px;color:var(--text-sec);font-weight:600;}
        .reaction-picker{position:absolute;background:rgba(18,18,18,.98);border:1px solid var(--border);border-radius:16px;padding:6px 10px;display:flex;gap:6px;z-index:600;box-shadow:0 8px 32px rgba(0,0,0,.6);backdrop-filter:blur(12px);}
        .reaction-picker span{font-size:20px;cursor:pointer;padding:4px;border-radius:8px;transition:.15s;}
        .reaction-picker span:active{background:rgba(255,255,255,.1);transform:scale(1.2);}

        /* SWIPE */
        .swipe-indicator{position:absolute;left:-55px;top:50%;transform:translateY(-50%);color:var(--gold);font-size:22px;width:46px;text-align:center;opacity:0;transition:opacity .2s;}
        .msg-row.swiping .swipe-indicator{opacity:1;}
        .delete-modal{position:absolute;inset:0;background:rgba(0,0,0,.82);z-index:700;display:none;align-items:center;justify-content:center;}
        .delete-modal.active{display:flex;}
        .delete-box{background:var(--surface);width:82%;max-width:300px;border-radius:18px;padding:22px;text-align:center;border:1px solid var(--border);}
        .delete-title{font-weight:700;margin-bottom:8px;font-family:'Syne',sans-serif;}
        .delete-desc{color:#aaa;font-size:13px;margin-bottom:20px;}
        .delete-btns{display:flex;gap:10px;flex-wrap:wrap;}
        .del-btn{flex:1;min-width:75px;padding:12px;border-radius:11px;border:none;font-weight:700;cursor:pointer;font-size:13px;font-family:'DM Sans',sans-serif;}
        .del-btn.cancel{background:#2a2a2a;color:#fff;}
        .del-btn.for-me{background:#ff4444;color:#fff;}
        .del-btn.for-all{background:#ff8800;color:#fff;}

        /* PIN */
        .pin-modal{position:absolute;inset:0;background:rgba(0,0,0,.82);z-index:800;display:none;align-items:center;justify-content:center;}
        .pin-modal.active{display:flex;}
        .pin-box{background:var(--surface);width:82%;max-width:300px;border-radius:18px;padding:22px;text-align:center;border:1px solid var(--border);}
        .pin-btns{display:flex;gap:10px;}
        .pin-btn{flex:1;padding:12px;border-radius:11px;border:none;font-weight:700;cursor:pointer;font-size:14px;font-family:'Syne',sans-serif;}
        .pin-btn.cancel{background:#2a2a2a;color:#fff;}
        .pin-btn.pin{background:var(--gold);color:#000;}

        /* LIGHTBOX */
        .lightbox{position:absolute;inset:0;background:#000;z-index:1000;display:none;flex-direction:column;}
        .lightbox.active{display:flex;}
        .lb-header{padding:calc(12px + var(--safe-top)) 16px 10px;display:flex;justify-content:space-between;align-items:center;flex-shrink:0;}
        .lb-body{flex:1;display:flex;align-items:center;justify-content:center;padding:10px;min-height:0;position:relative;}
        .lb-body img,.lb-body video{max-width:100%;max-height:100%;border-radius:6px;}
        .lb-actions{padding:16px;display:flex;justify-content:center;gap:20px;flex-shrink:0;}
        .lb-btn{width:46px;height:46px;border-radius:50%;background:#1a1a1a;border:1px solid var(--border);color:#fff;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:16px;}
        .lb-btn:active{background:var(--gold);color:#000;}

        /* TOAST */
        .toast{position:absolute;bottom:85px;left:50%;transform:translateX(-50%) translateY(120px);background:#ff4444;color:#fff;padding:11px 22px;border-radius:12px;font-size:13px;font-weight:700;z-index:600;transition:transform .3s cubic-bezier(.2,.8,.2,1);white-space:nowrap;font-family:'DM Sans',sans-serif;}
        .toast.show{transform:translateX(-50%) translateY(0);}
        .toast.success{background:#34C759;}

        /* LOADER */
        .loader{border:3px solid rgba(255,255,255,.08);border-top:3px solid var(--gold);border-radius:50%;width:26px;height:26px;animation:spin 1s linear infinite;margin:20px auto;}

        @keyframes fadeIn{from{opacity:0;}to{opacity:1;}}

        /* SECURE */
        .secure-item{display:flex;align-items:center;gap:14px;padding:12px;border-radius:16px;cursor:pointer;border:1px solid var(--gold-dim);background:var(--surface);margin-bottom:8px;}
        .secure-av{width:50px;height:50px;border-radius:50%;background:linear-gradient(135deg,#1a2a3a,#0a1a2a);display:flex;align-items:center;justify-content:center;color:var(--gold);font-size:20px;border:2px solid var(--gold-dim);}
        .secure-name{font-weight:700;font-size:14px;color:var(--gold);font-family:'Syne',sans-serif;}
        .secure-desc{font-size:11px;color:var(--text-sec);}
        .enc-badge{font-size:9px;color:var(--online);padding:2px 8px;background:rgba(0,230,118,0.1);border-radius:10px;font-weight:700;}

        /* SEND BTN BADGE */
        .file-badge{position:absolute;top:-5px;right:-5px;background:#ff4444;color:#fff;border-radius:50%;width:18px;height:18px;display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:800;}
        #send-btn{position:relative;}

        /* DOC PREVIEW CARD in footer strip */
        .doc-preview-card{display:flex;align-items:center;gap:10px;background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:10px 12px;min-width:220px;max-width:280px;position:relative;flex-shrink:0;}
        .doc-prev-icon{width:44px;height:44px;border-radius:10px;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
        .doc-prev-info{flex:1;overflow:hidden;}
        .doc-prev-name{font-size:12px;font-weight:600;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
        .doc-prev-meta{font-size:10px;color:var(--text-sec);margin-top:2px;}
        .remove-mb-doc{position:absolute;top:5px;right:5px;background:rgba(220,0,0,.9);color:#fff;border:none;width:18px;height:18px;border-radius:50%;font-size:9px;display:flex;align-items:center;justify-content:center;cursor:pointer;z-index:2;}

        /* GROUP ACTIONS */
        .group-actions{margin-left:auto;display:flex;gap:8px;}
        .group-del-btn{background:none;border:none;color:#ff4444;font-size:16px;cursor:pointer;padding:5px;border-radius:50%;}
        .group-del-btn:active{background:rgba(255,68,68,.15);}
        .group-edit-btn{background:none;border:none;color:var(--gold);font-size:15px;cursor:pointer;padding:5px;border-radius:50%;}
        .group-edit-btn:active{background:rgba(255,215,0,.15);}
        .group-dp-img{width:100%;height:100%;object-fit:cover;border-radius:50%;}
        
        /* PIN badge */
        .pin-badge{color:var(--gold);font-size:10px;margin-left:3px;}

        /* PROFILE SETUP */
        .profile-setup-wrap{padding:40px 28px;display:flex;flex-direction:column;align-items:center;height:100%;overflow-y:auto;}
        .profile-setup-wrap h2{font-family:'Syne',sans-serif;font-size:22px;font-weight:800;margin:0 0 6px;}
        .profile-setup-wrap p{font-size:13px;color:var(--text-sec);margin:0 0 28px;text-align:center;}
        .dp-picker{width:90px;height:90px;border-radius:50%;background:var(--surface);border:2.5px dashed var(--gold);display:flex;align-items:center;justify-content:center;cursor:pointer;overflow:hidden;margin-bottom:24px;position:relative;}
        .dp-picker img{width:100%;height:100%;object-fit:cover;border-radius:50%;}
        .dp-picker-overlay{position:absolute;inset:0;background:rgba(0,0,0,.35);border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-size:20px;}
        .dp-hint{font-size:10px;color:var(--text-sec);margin-top:-16px;margin-bottom:20px;}

        /* PUSH NOTIF BANNER (in-app) */
        .notif-banner{position:absolute;top:calc(10px + var(--safe-top));left:50%;transform:translateX(-50%) translateY(-120%);background:rgba(20,20,20,.96);backdrop-filter:blur(14px);border:1px solid var(--border);border-radius:16px;padding:12px 16px;width:88%;max-width:340px;display:flex;align-items:center;gap:12px;z-index:2000;transition:transform .35s cubic-bezier(.2,.8,.2,1);box-shadow:0 8px 32px rgba(0,0,0,.5);}
        .notif-banner.show{transform:translateX(-50%) translateY(0);}
        .notif-banner-av{width:36px;height:36px;border-radius:50%;background:var(--gold);color:#000;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:14px;font-family:'Syne',sans-serif;flex-shrink:0;overflow:hidden;}
        .notif-banner-av img{width:100%;height:100%;object-fit:cover;}
        .notif-banner-body{flex:1;overflow:hidden;}
        .notif-banner-title{font-size:12px;font-weight:700;color:var(--gold);font-family:'Syne',sans-serif;margin-bottom:2px;}
        .notif-banner-msg{font-size:12px;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
        .notif-banner-app{font-size:9px;color:var(--text-sec);margin-bottom:1px;}

        /* Empty state */
        .empty-state{text-align:center;padding:40px 20px;color:var(--text-sec);}
        .empty-state i{font-size:40px;margin-bottom:14px;opacity:.25;display:block;}
    </style>
</head>
<body>
<div id="app-viewport">

    <!-- AUTH -->
    <div id="screen-auth" class="screen active flex center">
        <div class="auth-wrap">
            <div class="brand-ring">
                <svg width="80" height="80" viewBox="0 0 80 80" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <!-- Outer ring -->
                  <circle cx="40" cy="40" r="36" stroke="#FFD700" stroke-width="2.5" fill="none" opacity="0.35"/>
                  <!-- Middle orbit ring tilted -->
                  <ellipse cx="40" cy="40" rx="36" ry="14" stroke="#FFD700" stroke-width="2" fill="none" transform="rotate(-25 40 40)" opacity="0.65"/>
                  <!-- Inner orbit ring tilted other way -->
                  <ellipse cx="40" cy="40" rx="36" ry="14" stroke="#FFD700" stroke-width="1.5" fill="none" transform="rotate(25 40 40)" opacity="0.4"/>
                  <!-- Center sun core -->
                  <circle cx="40" cy="40" r="10" fill="#FFD700"/>
                  <circle cx="40" cy="40" r="6" fill="#000"/>
                  <!-- Orbiting dot -->
                  <circle cx="67" cy="36" r="4" fill="#FFD700"/>
                  <!-- Small orbit dot -->
                  <circle cx="14" cy="48" r="2.5" fill="#FFD700" opacity="0.7"/>
                </svg>
            </div>
            <h1 class="brand-name">Orbit</h1>
            <p class="brand-sub">SOLAR OS · CONNECT</p>
            <div class="password-container">
                <input type="email" id="auth-email" class="input-box" placeholder="Access ID (Email)">
            </div>
            <div class="password-container">
                <input type="password" id="auth-pass" class="input-box" placeholder="Passkey">
                <button class="password-toggle touch-fix" id="toggle-password"><i class="fa-solid fa-eye"></i></button>
            </div>
            <button class="btn-primary touch-fix" id="auth-btn">INITIALIZE</button>
            <div class="auth-opts">
                <a href="#" class="auth-link" id="reset-link">Reset Password</a>
                <label style="color:var(--text-sec);font-size:12px;">
                    <input type="checkbox" id="remember-me" checked> Remember me
                </label>
            </div>
            <p id="auth-err" style="color:#ff4444;font-size:12px;margin-top:14px;display:none;"></p>
        </div>
    </div>

    <!-- PROFILE SETUP (new users) -->
    <div id="screen-profile-setup" class="screen flex center">
        <div class="profile-setup-wrap">
            <!-- Orbit logo -->
            <svg width="52" height="52" viewBox="0 0 80 80" fill="none" style="margin-bottom:18px;" xmlns="http://www.w3.org/2000/svg">
              <circle cx="40" cy="40" r="36" stroke="#FFD700" stroke-width="2.5" fill="none" opacity="0.35"/>
              <ellipse cx="40" cy="40" rx="36" ry="14" stroke="#FFD700" stroke-width="2" fill="none" transform="rotate(-25 40 40)" opacity="0.65"/>
              <ellipse cx="40" cy="40" rx="36" ry="14" stroke="#FFD700" stroke-width="1.5" fill="none" transform="rotate(25 40 40)" opacity="0.4"/>
              <circle cx="40" cy="40" r="10" fill="#FFD700"/>
              <circle cx="40" cy="40" r="6" fill="#000"/>
              <circle cx="67" cy="36" r="4" fill="#FFD700"/>
              <circle cx="14" cy="48" r="2.5" fill="#FFD700" opacity="0.7"/>
            </svg>
            <h2>Set Up Your Profile</h2>
            <p>Choose a display photo and enter your name so everyone on Orbit knows who you are.</p>
            <!-- DP Picker -->
            <div class="dp-picker touch-fix" id="setup-dp-picker">
                <img id="setup-dp-preview" src="" alt="" style="display:none;">
                <div class="dp-picker-overlay" id="setup-dp-overlay"><i class="fa-solid fa-camera"></i></div>
            </div>
            <div class="dp-hint">Tap to add photo</div>
            <input type="file" id="setup-dp-input" accept="image/*" hidden>
            <input type="text" id="setup-first-name" class="input-box" placeholder="First Name" style="user-select:text;">
            <input type="text" id="setup-last-name" class="input-box" placeholder="Last Name (optional)" style="user-select:text;">
            <button class="btn-primary touch-fix" id="setup-save-btn" style="margin-top:8px;">CONTINUE TO ORBIT</button>
            <button style="background:none;border:none;color:var(--text-sec);font-size:12px;margin-top:14px;cursor:pointer;" id="setup-skip-btn">Skip for now</button>
        </div>
    </div>

    <!-- DASHBOARD -->
    <div id="screen-dash" class="screen">
        <div class="dash-nav">
            <div style="display:flex;align-items:center;gap:10px;">
                <svg width="28" height="28" viewBox="0 0 80 80" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <circle cx="40" cy="40" r="36" stroke="#FFD700" stroke-width="3" fill="none" opacity="0.4"/>
                  <ellipse cx="40" cy="40" rx="36" ry="14" stroke="#FFD700" stroke-width="2.5" fill="none" transform="rotate(-25 40 40)" opacity="0.7"/>
                  <circle cx="40" cy="40" r="10" fill="#FFD700"/>
                  <circle cx="40" cy="40" r="6" fill="#000"/>
                  <circle cx="67" cy="36" r="4" fill="#FFD700"/>
                </svg>
                <div>
                    <div class="dash-title">Orbit</div>
                    <div style="font-size:10px;color:var(--text-sec);">Connect &amp; Communicate</div>
                </div>
            </div>
            <div style="display:flex;align-items:center;gap:10px;">
                <button class="btn-reset touch-fix" id="theme-toggle" style="font-size:16px;color:var(--gold);"><i class="fa-solid fa-moon"></i></button>
                <div class="user-chip touch-fix" id="user-chip" onclick="openProfileModal()">
                    <div class="av-sm" id="dash-av">U<div class="av-dot"></div></div>
                    <span style="font-size:12px;font-weight:600;" id="dash-id">User</span>
                    <div class="online-pill" id="online-pill"><i class="fa-solid fa-circle"></i><span id="online-count">0</span></div>
                </div>
            </div>
        </div>
        <div class="search-row">
            <div class="search-inner">
                <i class="fa-solid fa-magnifying-glass" style="color:var(--text-sec);"></i>
                <input type="text" placeholder="Search..." id="search-input">
                <i class="fa-solid fa-plus-circle touch-fix" style="color:var(--gold);font-size:20px;cursor:pointer;" id="new-room-btn"></i>
            </div>
        </div>
        <div class="dash-tabs">
            <button class="tab-btn active" data-tab="chats">Chats</button>
            <button class="tab-btn" data-tab="secure"><i class="fa-solid fa-lock"></i> Secure</button>
            <button class="tab-btn" data-tab="friends">Friends</button>
            <button class="tab-btn" data-tab="groups">Groups</button>
            <button class="tab-btn" data-tab="global">Global</button>
            <button class="tab-btn" data-tab="notes">Notes</button>
        </div>
        <div class="contact-list" id="tab-chats"><div style="padding:12px 18px 5px;font-size:12px;color:var(--text-sec);font-weight:700;letter-spacing:.5px;">RECENT</div><div id="chats-list"></div></div>
        <div class="contact-list hide" id="tab-secure"><div style="padding:12px 18px 5px;display:flex;justify-content:space-between;align-items:center;"><span style="font-size:12px;color:var(--text-sec);font-weight:700;letter-spacing:.5px;">SECURE CHATS</span><button class="touch-fix" style="background:var(--gold);color:#000;border:none;padding:5px 12px;border-radius:15px;font-size:11px;font-weight:700;cursor:pointer;font-family:'Syne',sans-serif;" id="new-secure-btn"><i class="fa-solid fa-lock"></i> New</button></div><div id="secure-list" style="padding:10px;"></div></div>
        <div class="contact-list hide" id="tab-friends"><div style="padding:12px 18px 5px;display:flex;justify-content:space-between;align-items:center;"><span style="font-size:12px;color:var(--text-sec);font-weight:700;letter-spacing:.5px;">FRIENDS</span><button class="touch-fix" style="background:var(--gold);color:#000;border:none;padding:5px 12px;border-radius:15px;font-size:11px;font-weight:700;cursor:pointer;font-family:'Syne',sans-serif;" id="add-friend-btn"><i class="fa-solid fa-user-plus"></i> Add</button></div><div id="friends-list"></div></div>
        <div class="contact-list hide" id="tab-groups"><div style="padding:12px 18px 5px;display:flex;justify-content:space-between;align-items:center;"><span style="font-size:12px;color:var(--text-sec);font-weight:700;letter-spacing:.5px;">GROUPS</span><button class="touch-fix" style="background:var(--gold);color:#000;border:none;padding:5px 12px;border-radius:15px;font-size:11px;font-weight:700;cursor:pointer;font-family:'Syne',sans-serif;" id="new-group-btn"><i class="fa-solid fa-users"></i> New</button></div><div id="groups-list"></div></div>
        <div class="contact-list hide" id="tab-global"><div style="padding:12px 18px 5px;display:flex;justify-content:space-between;align-items:center;"><span style="font-size:12px;color:var(--text-sec);font-weight:700;letter-spacing:.5px;">GLOBAL</span><div class="online-pill" id="global-pill"><i class="fa-solid fa-circle"></i><span id="global-count">0</span> online</div></div><div id="global-list"></div></div>
        <div class="contact-list hide" id="tab-notes"><div style="padding:12px 18px 5px;display:flex;justify-content:space-between;align-items:center;"><span style="font-size:12px;color:var(--text-sec);font-weight:700;letter-spacing:.5px;">NOTES</span><button class="touch-fix" style="background:var(--gold);color:#000;border:none;padding:5px 12px;border-radius:15px;font-size:11px;font-weight:700;cursor:pointer;font-family:'Syne',sans-serif;" id="new-note-btn"><i class="fa-solid fa-plus"></i> New</button></div><div id="notes-list" style="padding:10px;"></div></div>
        <div class="app-footer">Orbit · Solar OS · Connect &amp; Communicate<br>Developed by <strong style="color:var(--gold);">Rivaldo Rodrigues</strong></div>
    </div>

    <!-- CHAT -->
    <div id="screen-chat" class="screen z-top">
        <div class="chat-header">
            <button class="btn-reset touch-fix" id="back-btn"><i class="fa-solid fa-arrow-left" style="font-size:18px;"></i></button>
            <div class="chat-info">
                <div class="chat-name" id="chat-title">Room</div>
                <div class="chat-status" id="chat-status">Connected</div>
            </div>
            <div style="display:flex;gap:10px;">
                <button class="btn-reset touch-fix" id="sel-toggle-btn" style="font-size:16px;color:var(--gold);display:none;"><i class="fa-solid fa-check-double"></i></button>
                <button class="btn-reset touch-fix" id="fav-btn" style="font-size:16px;color:var(--gold);"><i class="fa-regular fa-star"></i></button>
                <button class="btn-reset touch-fix" id="group-info-btn" style="font-size:16px;color:var(--gold);display:none;"><i class="fa-solid fa-info-circle"></i></button>
            </div>
        </div>
        <div class="chat-feed" id="chat-feed"></div>
        <button id="scroll-bottom-btn" style="position:absolute;right:14px;bottom:130px;background:var(--surface);border:1px solid var(--border);color:var(--gold);width:38px;height:38px;border-radius:50%;display:none;align-items:center;justify-content:center;font-size:16px;cursor:pointer;box-shadow:0 4px 16px rgba(0,0,0,0.4);z-index:50;" class="touch-fix" onclick="scrollBottom()"><i class="fa-solid fa-chevron-down"></i></button>
        <div class="typing-indicator" id="typing-indicator">
            <div class="typing-dots"><span></span><span></span><span></span></div>
            <span id="typing-name">Someone is typing...</span>
        </div>
        <div class="sel-toolbar" id="sel-toolbar">
            <div class="sel-count" id="sel-count">0 selected</div>
            <button class="sel-btn touch-fix" id="dl-selected"><i class="fa-solid fa-download"></i></button>
            <button class="sel-btn touch-fix" id="del-selected"><i class="fa-solid fa-trash"></i></button>
            <button class="sel-btn touch-fix" id="clear-sel"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div id="reply-bar" class="reply-bar hide">
            <div class="reply-content">
                <div class="reply-title" id="reply-user">Replying to User</div>
                <div class="reply-txt" id="reply-txt">Message...</div>
            </div>
            <button class="btn-icon touch-fix" id="cancel-reply"><i class="fa-solid fa-xmark" style="color:#fff;"></i></button>
        </div>
        <div class="chat-footer">
            <div class="media-preview-strip hide" id="media-preview-strip"></div>
            <div class="chat-footer-row">
                <button class="footer-btn touch-fix" id="media-picker-btn"><i class="fa-solid fa-plus"></i></button>
                <div class="input-wrapper">
                    <textarea id="msg-input" class="msg-input" rows="1" placeholder="Message..."></textarea>
                </div>
                <button class="footer-btn send-gold touch-fix" id="send-btn">
                    <i class="fa-solid fa-paper-plane" style="font-size:14px;"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- MODALS -->
    <div id="modal-room" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-title" id="modal-room-title">Create New Room</div>
            <input type="text" id="room-name-in" class="modal-input" placeholder="Room name">
            <input type="text" id="room-topic-in" class="modal-input" placeholder="Topic (optional)">
            <div class="modal-btns">
                <button class="modal-btn cancel touch-fix" id="close-room-modal">Cancel</button>
                <button class="modal-btn create touch-fix" id="create-room-btn">Create</button>
            </div>
        </div>
    </div>
    <div id="modal-friend" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-title">Add Friend</div>
            <input type="email" id="friend-email-in" class="modal-input" placeholder="Friend's email">
            <div class="modal-btns">
                <button class="modal-btn cancel touch-fix" id="close-friend-modal">Cancel</button>
                <button class="modal-btn create touch-fix" id="send-friend-btn">Send Request</button>
            </div>
        </div>
    </div>
    <div id="modal-note" class="modal-overlay">
        <div class="modal-box" style="max-width:400px;">
            <div class="modal-title" id="note-modal-title">New Note</div>
            <input type="text" id="note-title-in" class="modal-input" placeholder="Note title">
            <textarea id="note-content-in" class="modal-input" placeholder="Note content..." rows="7" style="resize:vertical;min-height:110px;"></textarea>
            <div class="modal-btns">
                <button class="modal-btn cancel touch-fix" id="close-note-modal">Cancel</button>
                <button class="modal-btn create touch-fix" id="save-note-btn">Save</button>
            </div>
        </div>
    </div>
    <div id="modal-reset" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-title">Reset Password</div>
            <input type="email" id="reset-email-in" class="modal-input" placeholder="Your email">
            <div class="modal-btns">
                <button class="modal-btn cancel touch-fix" id="close-reset-modal">Cancel</button>
                <button class="modal-btn create touch-fix" id="reset-btn">Send Link</button>
            </div>
        </div>
    </div>
    <div id="modal-group-info" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-title">Group Options</div>
            <p style="color:var(--text-sec);font-size:14px;margin-bottom:16px;">Manage this group.</p>
            <div class="modal-btns" style="flex-direction:column;gap:10px;">
                <button class="modal-btn create touch-fix" id="rename-group-btn" style="background:var(--gold);color:#000;"><i class="fa-solid fa-pen"></i> Rename Group</button>
                <button class="modal-btn create touch-fix" id="change-dp-btn" style="background:#5856D6;color:#fff;"><i class="fa-solid fa-image"></i> Change Group Photo</button>
                <button class="modal-btn create touch-fix" style="background:#ff4444;color:#fff;" id="delete-group-btn"><i class="fa-solid fa-trash"></i> Delete Group</button>
                <button class="modal-btn cancel touch-fix" id="close-group-info">Cancel</button>
            </div>
        </div>
    </div>

    <!-- GROUP RENAME MODAL -->
    <div id="modal-group-rename" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-title">Rename Group</div>
            <input type="text" id="group-rename-in" class="modal-input" placeholder="New group name">
            <div class="modal-btns">
                <button class="modal-btn cancel touch-fix" id="close-group-rename">Cancel</button>
                <button class="modal-btn create touch-fix" id="save-group-rename">Save</button>
            </div>
        </div>
    </div>

    <!-- GROUP DP CROP MODAL -->
    <div id="modal-group-dp" class="fullscreen-modal hide" style="z-index:300;">
        <div class="editor-header">
            <button class="btn-icon touch-fix" id="cancel-group-dp"><i class="fa-solid fa-xmark"></i></button>
            <span style="font-weight:700;color:#fff;font-family:'Syne',sans-serif;">Group Photo</span>
            <button class="btn-text-gold touch-fix" id="save-group-dp">Save</button>
        </div>
        <div class="editor-canvas"><img id="group-dp-img" src="" alt="Group DP"></div>
        <div class="editor-tools">
            <div class="tool-label">ADJUST</div>
            <div class="tools-row">
                <button class="etool touch-fix" id="gdp-crop-free"><i class="fa-solid fa-crop"></i> Free</button>
                <button class="etool touch-fix" id="gdp-crop-square"><i class="fa-solid fa-square"></i> Square</button>
                <button class="etool touch-fix" id="gdp-crop-circle" style="border-color:var(--gold);"><i class="fa-solid fa-circle"></i> Circle</button>
                <button class="etool touch-fix" id="gdp-rot-left"><i class="fa-solid fa-rotate-left"></i></button>
                <button class="etool touch-fix" id="gdp-rot-right"><i class="fa-solid fa-rotate-right"></i></button>
            </div>
        </div>
    </div>
    <input type="file" id="inp-group-dp" accept="image/*" hidden>

    <!-- MEDIA SHEET -->
    <div id="sheet-media" class="media-sheet">
        <div class="sheet-box">
            <div class="sheet-handle"></div>
            <div class="media-grid">
                <div class="media-opt touch-fix" data-media="gallery"><div class="m-icon" style="background:#007AFF;"><i class="fa-solid fa-images"></i></div><span>Gallery</span></div>
                <div class="media-opt touch-fix" data-media="camera"><div class="m-icon" style="background:#FF3B30;"><i class="fa-solid fa-camera"></i></div><span>Camera</span></div>
                <div class="media-opt touch-fix" data-media="video"><div class="m-icon" style="background:#34C759;"><i class="fa-solid fa-video"></i></div><span>Video</span></div>
                <div class="media-opt touch-fix" data-media="video-record"><div class="m-icon" style="background:#FF2D55;"><i class="fa-solid fa-circle-dot"></i></div><span>Record</span></div>
                <div class="media-opt touch-fix" data-media="document"><div class="m-icon" style="background:#5856D6;"><i class="fa-solid fa-file-pdf"></i></div><span>Document</span></div>
            </div>
            <button class="btn-cancel touch-fix" id="close-media-sheet">Cancel</button>
        </div>
    </div>

    <!-- IMAGE EDITOR -->
    <div id="modal-editor" class="fullscreen-modal hide">
        <div class="editor-header">
            <button class="btn-icon touch-fix" id="cancel-editor"><i class="fa-solid fa-xmark"></i></button>
            <span style="font-weight:700;color:#fff;font-family:'Syne',sans-serif;">Edit Image</span>
            <button class="btn-text-gold touch-fix" id="finish-editing">Send</button>
        </div>
        <div class="editor-canvas"><img id="img-to-edit" src="" alt="edit"></div>
        <div class="editor-tools">
            <div class="tool-label">EDIT</div>
            <div class="tools-row">
                <button class="etool touch-fix" id="crop-btn"><i class="fa-solid fa-crop"></i> Crop</button>
                <button class="etool touch-fix" id="rot-left"><i class="fa-solid fa-rotate-left"></i></button>
                <button class="etool touch-fix" id="rot-right"><i class="fa-solid fa-rotate-right"></i></button>
                <button class="etool touch-fix" id="flip-h"><i class="fa-solid fa-left-right"></i></button>
            </div>
            <div class="tool-label" style="margin-top:4px;">FILTERS</div>
            <div class="filter-grid">
                <div class="filter-item active touch-fix" data-filter="normal"><div class="swatch sw-normal"></div><div class="filter-label">Normal</div></div>
                <div class="filter-item touch-fix" data-filter="grayscale"><div class="swatch sw-bw"></div><div class="filter-label">B&W</div></div>
                <div class="filter-item touch-fix" data-filter="sepia"><div class="swatch sw-vintage"></div><div class="filter-label">Vintage</div></div>
                <div class="filter-item touch-fix" data-filter="brightness"><div class="swatch sw-bright"></div><div class="filter-label">Bright</div></div>
                <div class="filter-item touch-fix" data-filter="contrast"><div class="swatch sw-contrast"></div><div class="filter-label">Contrast</div></div>
                <div class="filter-item touch-fix" data-filter="saturate"><div class="swatch sw-vivid"></div><div class="filter-label">Vivid</div></div>
            </div>
        </div>
        <button class="discard-btn touch-fix" id="discard-editor"><i class="fa-solid fa-trash"></i> Discard</button>
    </div>

    <!-- VIDEO PREVIEW -->
    <div id="modal-video" class="video-modal hide">
        <div class="editor-header">
            <button class="btn-icon touch-fix" id="cancel-video"><i class="fa-solid fa-xmark"></i></button>
            <span style="font-weight:700;color:#fff;font-family:'Syne',sans-serif;">Video Preview</span>
            <button class="btn-text-gold touch-fix" id="send-video">Send</button>
        </div>
        <div class="video-body"><video id="video-preview" controls playsinline></video></div>
    </div>

    <!-- UPLOAD OVERLAY -->
    <div id="upload-overlay" class="upload-screen hide">
        <div class="upload-ring">
            <svg class="progress-ring" width="120" height="120">
                <circle class="progress-ring__circle" stroke="var(--gold)" stroke-width="4" fill="transparent" r="52" cx="60" cy="60"/>
            </svg>
            <div class="upload-pct" id="upload-pct">0%</div>
        </div>
        <div class="upload-label">Uploading...</div>
        <div class="upload-file-lbl" id="upload-file-lbl">file</div>
        <button class="touch-fix" style="margin-top:24px;background:#222;color:#fff;border:none;padding:10px 22px;border-radius:22px;cursor:pointer;font-size:13px;font-family:'DM Sans',sans-serif;" id="cancel-upload"><i class="fa-solid fa-xmark"></i> Cancel</button>
    </div>

    <!-- CTX MENU -->
    <div id="ctx-overlay" class="ctx-overlay"></div>
    <div id="ctx-menu" class="ctx-menu">
        <div class="ctx-item touch-fix" data-action="react"><i class="fa-solid fa-face-smile"></i> React</div>
        <div class="ctx-item touch-fix" data-action="reply"><i class="fa-solid fa-reply"></i> Reply</div>
        <div class="ctx-item touch-fix" data-action="copy"><i class="fa-solid fa-copy"></i> Copy Text</div>
        <div class="ctx-divider"></div>
        <div class="ctx-item touch-fix" data-action="pin"><i class="fa-solid fa-thumbtack"></i> Pin</div>
        <div class="ctx-item touch-fix" data-action="download"><i class="fa-solid fa-download"></i> Download</div>
        <div class="ctx-divider"></div>
        <div class="ctx-item del touch-fix" data-action="del-me"><i class="fa-solid fa-user-xmark"></i> Delete for Me</div>
        <div class="ctx-item del touch-fix" data-action="del-all"><i class="fa-solid fa-trash-can"></i> Delete for Everyone</div>
        <div class="ctx-divider"></div>
        <div class="ctx-item touch-fix" data-action="cancel"><i class="fa-solid fa-xmark"></i> Cancel</div>
    </div>

    <!-- DELETE MODAL -->
    <div id="modal-delete" class="delete-modal">
        <div class="delete-box">
            <div class="delete-title">Delete Message</div>
            <div class="delete-desc">Choose how to delete this message.</div>
            <div class="delete-btns">
                <button class="del-btn cancel touch-fix" id="cancel-delete">Cancel</button>
                <button class="del-btn for-me touch-fix" id="delete-for-me">For Me</button>
                <button class="del-btn for-all touch-fix" id="delete-for-all">For All</button>
            </div>
        </div>
    </div>

    <!-- PIN MODAL -->
    <div id="modal-pin" class="pin-modal">
        <div class="pin-box">
            <div class="delete-title">Pin Message</div>
            <div class="delete-desc" style="margin-bottom:16px;">Pin this message to the top?</div>
            <div class="pin-btns">
                <button class="pin-btn cancel touch-fix" id="cancel-pin">Cancel</button>
                <button class="pin-btn pin touch-fix" id="do-pin">Pin</button>
            </div>
        </div>
    </div>

    <!-- LIGHTBOX -->
    <div id="lightbox" class="lightbox">
        <div class="lb-header">
            <button class="btn-icon touch-fix" id="close-lb"><i class="fa-solid fa-xmark"></i></button>
            <span style="color:#fff;font-weight:600;font-size:14px;" id="lb-title">Media</span>
            <button class="btn-icon touch-fix" id="dl-lb"><i class="fa-solid fa-download"></i></button>
        </div>
        <div class="lb-body">
            <img id="lb-img" src="" alt="" style="display:none;">
            <video id="lb-video" controls playsinline style="display:none;"></video>
        </div>
        <div class="lb-actions" id="lb-actions">
            <button class="lb-btn touch-fix" id="lb-prev" style="display:none;"><i class="fa-solid fa-chevron-left"></i></button>
            <button class="lb-btn touch-fix" id="lb-next" style="display:none;"><i class="fa-solid fa-chevron-right"></i></button>
        </div>
    </div>

    <!-- HIDDEN FILE INPUTS -->
    <input type="file" id="inp-gallery" accept="image/*" multiple hidden>
    <input type="file" id="inp-camera" accept="image/*" capture="environment" hidden>
    <input type="file" id="inp-video" accept="video/*,video/mp4,video/webm,video/quicktime,video/3gpp,video/avi" hidden>
    <input type="file" id="inp-video-record" accept="video/*" capture="environment" hidden>
    <input type="file" id="inp-document" accept=".pdf,.doc,.docx,.txt,.rtf,.zip,.xls,.xlsx,.ppt,.pptx,.csv,.odt" multiple hidden>

    <!-- PDF VIEWER MODAL -->
    <div id="pdf-viewer-modal" style="position:absolute;inset:0;background:#1a1a1a;z-index:1500;display:none;flex-direction:column;">
        <div style="padding:calc(12px + var(--safe-top)) 16px 10px;display:flex;justify-content:space-between;align-items:center;background:#111;border-bottom:1px solid rgba(255,255,255,0.08);flex-shrink:0;">
            <button onclick="closePdfViewer()" style="background:none;border:none;color:#fff;font-size:20px;cursor:pointer;padding:4px 8px;"><i class="fa-solid fa-xmark"></i></button>
            <span id="pdf-viewer-title" style="color:#fff;font-weight:600;font-size:14px;font-family:'Syne',sans-serif;flex:1;text-align:center;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;margin:0 10px;">Document</span>
            <button id="pdf-dl-btn" style="background:none;border:none;color:var(--gold);font-size:18px;cursor:pointer;padding:4px 8px;"><i class="fa-solid fa-download"></i></button>
        </div>
        <div style="flex:1;overflow:auto;display:flex;flex-direction:column;align-items:center;padding:12px;gap:8px;" id="pdf-pages-container">
            <div style="color:#888;padding:40px;text-align:center;" id="pdf-loading"><div class="loader"></div><div style="margin-top:12px;font-size:13px;">Loading document...</div></div>
        </div>
    </div>

    <!-- IN-APP NOTIFICATION BANNER -->
    <div id="notif-banner" class="notif-banner">
        <div class="notif-banner-av" id="notif-av">O</div>
        <div class="notif-banner-body">
            <div class="notif-banner-app">Orbit</div>
            <div class="notif-banner-title" id="notif-title">New Message</div>
            <div class="notif-banner-msg" id="notif-msg">You have a new message</div>
        </div>
    </div>

    <!-- PROFILE EDIT MODAL (from dashboard) -->
    <div id="modal-profile" class="modal-overlay">
        <div class="modal-box" style="max-width:340px;">
            <div class="modal-title">Edit Profile</div>
            <div style="display:flex;flex-direction:column;align-items:center;margin-bottom:18px;">
                <div class="dp-picker touch-fix" id="profile-dp-picker" style="width:72px;height:72px;margin-bottom:10px;">
                    <img id="profile-dp-preview" src="" alt="" style="display:none;">
                    <div class="dp-picker-overlay" id="profile-dp-overlay"><i class="fa-solid fa-camera"></i></div>
                </div>
            </div>
            <input type="file" id="profile-dp-input" accept="image/*" hidden>
            <input type="text" id="profile-first-name" class="modal-input" placeholder="First Name" style="user-select:text;">
            <input type="text" id="profile-last-name" class="modal-input" placeholder="Last Name (optional)" style="user-select:text;">
            <div class="modal-btns">
                <button class="modal-btn cancel touch-fix" id="close-profile-modal">Cancel</button>
                <button class="modal-btn create touch-fix" id="save-profile-btn">Save</button>
            </div>
        </div>
    </div>

    <!-- REACTION PICKER -->
    <div id="reaction-picker" class="reaction-picker" style="display:none;">
        <span data-emoji="👍">👍</span>
        <span data-emoji="❤️">❤️</span>
        <span data-emoji="😂">😂</span>
        <span data-emoji="😮">😮</span>
        <span data-emoji="😢">😢</span>
        <span data-emoji="🔥">🔥</span>
    </div>

    <!-- TOAST -->
    <div id="toast" class="toast"></div>
</div>

<script>
// ===================== CONFIG =====================
const SB_URL = "https://dhtbiggamuwoqurguhib.supabase.co";
const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRodGJpZ2dhbXV3b3F1cmd1aGliIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxNzY2MzksImV4cCI6MjA3ODc1MjYzOX0.-utin9W_-hSeijdHwcVSjft9biB5DSXrNOmuz5kCPlE";
const sb = supabase.createClient(SB_URL, SB_KEY);

// ===================== STATE =====================
let currentUser = null;
let currentRoom = null;
let isPersonalChat = false;
let activeSubscriptions = [];
let messageCache = new Map();
let globalUsersCache = new Map();
let notesCache = new Map();
let pinnedMessages = new Map();
let selectedMessages = new Set();
let isSelectMode = false;
let replyToMsg = null;
let selectedMsg = null;
let selectedFiles = [];
let editingFileIndex = null;
let cropper = null;
let currentFilter = 'normal';
let uploadCanceled = false;
let deleteMessageId = null;
let editingNoteId = null;
let videoFile = null;
let favorites = JSON.parse(localStorage.getItem('orbit_favorites') || '[]');
let presenceInterval = null;
let localCounter = 0;
let toastTimer = null;
let swipeStartX = 0, swipeStartY = 0, swipeEl = null;
const SWIPE_THRESHOLD = 55;
let lbImages = [], lbIndex = 0;
let hasMoreMessages = true;
let oldestMsgDate = null;
let loadingMore = false;
let uploadInProgress = false; // prevent multiple simultaneous uploads
let userProfile = null; // { first_name, last_name, dp_url }
let notifBannerTimer = null;

// ===================== INIT =====================
document.addEventListener('DOMContentLoaded', init);

async function init() {
    setupListeners();
    initTheme();
    checkSession();
    requestNotifPerms();
    // Verify storage bucket exists (optional)
    await checkStorageBucket();
}

let storageAvailable = null; // null=unchecked, true=ok, false=unavailable

async function checkStorageBucket() {
    // V83: Non-blocking storage check — detect once, cache result
    try {
        const { data, error } = await sb.storage.from('chat-assets').list('_test', { limit: 1 });
        if (error && (error.message.includes('not found') || error.message.includes('400') || error.statusCode === 400)) {
            storageAvailable = false;
            console.warn('⚠️ Supabase Storage bucket "chat-assets" not found.');
            console.warn('📌 To fix: Supabase Dashboard → Storage → New Bucket → Name: "chat-assets" → Make Public → Save');
            console.log('ℹ️ Using base64 fallback — images only (videos limited to 15MB).');
        } else {
            storageAvailable = true;
            console.log('✅ Supabase Storage "chat-assets" ready');
        }
    } catch(e) {
        storageAvailable = false;
        console.warn('ℹ️ Storage unavailable, using base64 mode:', e.message);
    }
}

function requestNotifPerms() {
    if (!('Notification' in window)) return;
    if (Notification.permission === 'default') {
        // Delay request to avoid blocking load
        setTimeout(() => {
            Notification.requestPermission().then(perm => {
                if (perm === 'granted') {
                    console.log('✅ Notifications granted');
                    registerServiceWorker();
                }
            });
        }, 3000);
    } else if (Notification.permission === 'granted') {
        registerServiceWorker();
    }
}

async function registerServiceWorker() {
    if (!('serviceWorker' in navigator)) return;
    try {
        // Use a dedicated SW file if available, otherwise skip (blob: URLs are not supported as SW scripts)
        const swUrl = '/sw.js';
        // Test if SW file exists
        const resp = await fetch(swUrl, { method: 'HEAD' }).catch(() => null);
        if (!resp || !resp.ok) {
            console.log('ℹ️ No SW file at /sw.js — push notifications via SW skipped (normal for localhost)');
            return;
        }
        const reg = await navigator.serviceWorker.register(swUrl, { scope: '/' });
        console.log('✅ Service Worker registered for notifications');
        window._swRegistration = reg;
    } catch(e) {
        console.log('ℹ️ SW registration skipped:', e.message);
    }
}

function showNotif(title, body, senderInfo) {
    // Always show in-app banner
    showNotifBanner(title, body, senderInfo);
    // Native notification when page not visible
    if ('Notification' in window && Notification.permission === 'granted' && document.visibilityState !== 'visible') {
        try {
            // Try SW notification first (works on mobile)
            if (window._swRegistration?.active) {
                window._swRegistration.showNotification(`Orbit — ${title}`, {
                    body,
                    icon: senderInfo?.dpUrl || undefined,
                    tag: 'orbit-msg',
                    renotify: true,
                    vibrate: [200, 100, 200],
                    badge: undefined
                }).catch(() => {
                    // Fallback to regular notification
                    new Notification(`Orbit — ${title}`, { body, icon: senderInfo?.dpUrl || undefined, tag: 'orbit-msg' });
                });
            } else {
                new Notification(`Orbit — ${title}`, {
                    body,
                    icon: senderInfo?.dpUrl || undefined,
                    tag: 'orbit-msg',
                    renotify: true
                });
            }
        } catch(e) {
            console.warn('Notification failed:', e);
        }
    }
    // Vibrate on mobile regardless
    if ('vibrate' in navigator) {
        navigator.vibrate([100, 50, 100]);
    }
}

function showNotifBanner(title, body, senderInfo) {
    const banner = document.getElementById('notif-banner');
    const avEl = document.getElementById('notif-av');
    document.getElementById('notif-title').innerText = title;
    document.getElementById('notif-msg').innerText = body;
    // Set avatar
    if (senderInfo?.dpUrl) {
        avEl.innerHTML = `<img src="${senderInfo.dpUrl}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">`;
    } else {
        const initials = (title[0] || 'O').toUpperCase();
        avEl.innerHTML = initials;
        avEl.style.background = 'var(--gold)';
        avEl.style.color = '#000';
    }
    banner.classList.add('show');
    if (notifBannerTimer) clearTimeout(notifBannerTimer);
    notifBannerTimer = setTimeout(hideNotifBanner, 4000);
}

function hideNotifBanner() {
    document.getElementById('notif-banner').classList.remove('show');
}

// ===================== LISTENERS =====================
function setupListeners() {
    // Auth
    document.getElementById('toggle-password').addEventListener('click', togglePass);
    document.getElementById('auth-btn').addEventListener('click', handleAuth);
    document.getElementById('reset-link').addEventListener('click', () => document.getElementById('modal-reset').classList.add('active'));
    document.getElementById('close-reset-modal').addEventListener('click', () => document.getElementById('modal-reset').classList.remove('active'));
    document.getElementById('reset-btn').addEventListener('click', resetPassword);

    // Theme
    document.getElementById('theme-toggle').addEventListener('click', toggleTheme);

    // Dashboard
    document.getElementById('new-room-btn').addEventListener('click', showRoomModal);
    document.getElementById('close-room-modal').addEventListener('click', () => document.getElementById('modal-room').classList.remove('active'));
    document.getElementById('create-room-btn').addEventListener('click', createRoom);
    document.getElementById('new-secure-btn').addEventListener('click', createSecureChat);
    document.getElementById('add-friend-btn').addEventListener('click', () => document.getElementById('modal-friend').classList.add('active'));
    document.getElementById('close-friend-modal').addEventListener('click', () => document.getElementById('modal-friend').classList.remove('active'));
    document.getElementById('send-friend-btn').addEventListener('click', sendFriendRequest);
    document.getElementById('new-group-btn').addEventListener('click', showRoomModal);
    document.getElementById('new-note-btn').addEventListener('click', newNote);
    document.getElementById('close-note-modal').addEventListener('click', () => { document.getElementById('modal-note').classList.remove('active'); editingNoteId = null; });
    document.getElementById('save-note-btn').addEventListener('click', saveNote);

    // Tabs
    document.querySelectorAll('.tab-btn').forEach(b => b.addEventListener('click', e => switchTab(e.target.closest('.tab-btn').dataset.tab)));

    // Chat header
    document.getElementById('back-btn').addEventListener('click', navBack);
    document.getElementById('sel-toggle-btn').addEventListener('click', toggleSelectMode);
    document.getElementById('fav-btn').addEventListener('click', toggleFav);
    document.getElementById('group-info-btn').addEventListener('click', () => {
        groupSettingsRoomId = currentRoom;
        document.getElementById('modal-group-info').classList.add('active');
    });
    document.getElementById('close-group-info').addEventListener('click', () => document.getElementById('modal-group-info').classList.remove('active'));
    document.getElementById('delete-group-btn').addEventListener('click', deleteGroup);
    document.getElementById('rename-group-btn').addEventListener('click', () => {
        document.getElementById('modal-group-info').classList.remove('active');
        document.getElementById('group-rename-in').value = document.getElementById('chat-title').innerText;
        document.getElementById('modal-group-rename').classList.add('active');
    });
    document.getElementById('change-dp-btn').addEventListener('click', () => {
        document.getElementById('modal-group-info').classList.remove('active');
        openGroupDpPicker();
    });
    document.getElementById('close-group-rename').addEventListener('click', () => document.getElementById('modal-group-rename').classList.remove('active'));
    document.getElementById('save-group-rename').addEventListener('click', renameGroup);
    document.getElementById('cancel-group-dp').addEventListener('click', cancelGroupDp);
    document.getElementById('save-group-dp').addEventListener('click', saveGroupDp);
    document.getElementById('inp-group-dp').addEventListener('change', handleGroupDpFile);
    document.getElementById('gdp-crop-free').addEventListener('click', () => { if(groupDpCropper) groupDpCropper.setAspectRatio(NaN); });
    document.getElementById('gdp-crop-square').addEventListener('click', () => { if(groupDpCropper) groupDpCropper.setAspectRatio(1); });
    document.getElementById('gdp-crop-circle').addEventListener('click', () => { if(groupDpCropper) groupDpCropper.setAspectRatio(1); });
    document.getElementById('gdp-rot-left').addEventListener('click', () => groupDpCropper?.rotate(-90));
    document.getElementById('gdp-rot-right').addEventListener('click', () => groupDpCropper?.rotate(90));

    // Selection
    document.getElementById('dl-selected').addEventListener('click', downloadSelected);
    document.getElementById('del-selected').addEventListener('click', deleteSelected);
    document.getElementById('clear-sel').addEventListener('click', clearSel);

    // Reply
    document.getElementById('cancel-reply').addEventListener('click', cancelReply);

    // Footer
    document.getElementById('media-picker-btn').addEventListener('click', openMediaPicker);
    document.getElementById('close-media-sheet').addEventListener('click', closeMediaSheet);
    document.getElementById('send-btn').addEventListener('click', debounce(sendMessage, 400));
    document.getElementById('msg-input').addEventListener('input', function() { autoResize.call(this); broadcastTyping(); });
    document.getElementById('msg-input').addEventListener('keydown', handleKeyDown);

    // Media options
    document.querySelectorAll('.media-opt').forEach(o => o.addEventListener('click', e => triggerFile(e.currentTarget.dataset.media)));

    // File inputs
    document.getElementById('inp-gallery').addEventListener('change', handleGallery);
    document.getElementById('inp-camera').addEventListener('change', handleCamera);
    document.getElementById('inp-video').addEventListener('change', handleVideo);
    document.getElementById('inp-video-record').addEventListener('change', handleVideo);
    document.getElementById('inp-document').addEventListener('change', handleDocument);

    // Editor
    document.getElementById('cancel-editor').addEventListener('click', cancelEditor);
    document.getElementById('discard-editor').addEventListener('click', cancelEditor);
    document.getElementById('finish-editing').addEventListener('click', finishEditing);
    document.getElementById('crop-btn').addEventListener('click', () => cropper?.setDragMode('crop'));
    document.getElementById('rot-left').addEventListener('click', () => cropper?.rotate(-90));
    document.getElementById('rot-right').addEventListener('click', () => cropper?.rotate(90));
    document.getElementById('flip-h').addEventListener('click', () => { if (cropper) { const d = cropper.getData(); cropper.scaleX(d.scaleX === -1 ? 1 : -1); } });
    document.querySelectorAll('.filter-item').forEach(el => el.addEventListener('click', e => applyFilter(e.currentTarget.dataset.filter, e.currentTarget)));

    // Video preview
    document.getElementById('cancel-video').addEventListener('click', cancelVideoPreview);
    document.getElementById('send-video').addEventListener('click', sendVideoFile);

    // Upload
    document.getElementById('cancel-upload').addEventListener('click', () => { uploadCanceled = true; hideUploadOverlay(); clearMediaPreview(); });

    // Context menu
    document.getElementById('ctx-overlay').addEventListener('click', closeCtx);
    document.querySelectorAll('.ctx-item').forEach(i => i.addEventListener('click', e => handleCtx(e.currentTarget.dataset.action)));

    // Delete modal
    document.getElementById('cancel-delete').addEventListener('click', hideDeleteModal);
    document.getElementById('delete-for-me').addEventListener('click', deleteForMe);
    document.getElementById('delete-for-all').addEventListener('click', deleteForAll);

    // Pin modal
    document.getElementById('cancel-pin').addEventListener('click', () => document.getElementById('modal-pin').classList.remove('active'));
    document.getElementById('do-pin').addEventListener('click', pinMessage);

    // Lightbox
    document.getElementById('close-lb').addEventListener('click', closeLightbox);
    document.getElementById('dl-lb').addEventListener('click', downloadLb);
    document.getElementById('lb-prev').addEventListener('click', prevLbImg);
    document.getElementById('lb-next').addEventListener('click', nextLbImg);

    // Modal overlay close
    document.querySelectorAll('.modal-overlay').forEach(m => m.addEventListener('click', e => { if (e.target === m) m.classList.remove('active'); }));
    document.getElementById('sheet-media').addEventListener('click', e => { if (e.target === e.currentTarget) closeMediaSheet(); });

    // Remember me
    const rem = localStorage.getItem('orbit_remember_email');
    if (rem) { document.getElementById('auth-email').value = rem; document.getElementById('remember-me').checked = true; }

    // Infinite scroll
    document.getElementById('chat-feed').addEventListener('scroll', onFeedScroll);

    // Profile setup screen
    document.getElementById('setup-dp-picker').addEventListener('click', () => document.getElementById('setup-dp-input').click());
    document.getElementById('setup-dp-input').addEventListener('change', handleSetupDpFile);
    document.getElementById('setup-save-btn').addEventListener('click', saveProfileSetup);
    document.getElementById('setup-skip-btn').addEventListener('click', skipProfileSetup);

    // Profile edit modal
    document.getElementById('profile-dp-picker').addEventListener('click', () => document.getElementById('profile-dp-input').click());
    document.getElementById('profile-dp-input').addEventListener('change', handleProfileDpFile);
    document.getElementById('save-profile-btn').addEventListener('click', saveProfileEdit);
    document.getElementById('close-profile-modal').addEventListener('click', () => document.getElementById('modal-profile').classList.remove('active'));

    // Reaction picker
    document.querySelectorAll('#reaction-picker span').forEach(s => s.addEventListener('click', e => { e.stopPropagation(); sendReaction(s.dataset.emoji); }));

    // Search
    document.getElementById('search-input').addEventListener('input', debounce(e => {
        const q = e.target.value.trim().toLowerCase();
        const activeTab = document.querySelector('.tab-btn.active')?.dataset?.tab;
        if (!activeTab) return;
        const listId = activeTab === 'chats' ? 'chats-list' : 
                       activeTab === 'groups' ? 'groups-list' : 
                       activeTab === 'global' ? 'global-list' : 
                       activeTab === 'friends' ? 'friends-list' : null;
        if (!listId) return;
        const items = document.querySelectorAll(`#${listId} .contact-item, #${listId} .secure-item`);
        items.forEach(item => {
            const nameEl = item.querySelector('.c-name, .secure-name');
            const visible = !q || (nameEl && nameEl.innerText.toLowerCase().includes(q));
            item.style.display = visible ? '' : 'none';
        });
    }, 200));

    // Notif banner click to dismiss
    document.getElementById('notif-banner').addEventListener('click', hideNotifBanner);
}

// ===================== AUTH =====================
function togglePass() {
    const p = document.getElementById('auth-pass');
    const i = document.querySelector('#toggle-password i');
    p.type = p.type === 'password' ? 'text' : 'password';
    i.className = p.type === 'password' ? 'fa-solid fa-eye' : 'fa-solid fa-eye-slash';
}

async function checkSession() {
    try {
        // getSession() uses localStorage cache — instant, no network needed
        const { data: { session } } = await sb.auth.getSession();
        if (session) { currentUser = session.user; await initApp(); }
        // Listen for auth state changes (handles token refresh etc)
        sb.auth.onAuthStateChange((event, sess) => {
            if (event === 'SIGNED_IN' && sess && !currentUser) {
                currentUser = sess.user;
                initApp();
            } else if (event === 'SIGNED_OUT') {
                currentUser = null;
                document.getElementById('screen-dash').classList.remove('active');
                document.getElementById('screen-auth').classList.add('active');
            }
        });
    } catch (e) {}
}

async function handleAuth() {
    const email = document.getElementById('auth-email').value.trim();
    const pass = document.getElementById('auth-pass').value;
    const rem = document.getElementById('remember-me').checked;
    const err = document.getElementById('auth-err');
    if (!email || !pass) { err.innerText = 'Enter email and password'; err.style.display = 'block'; return; }
    try {
        let { data, error } = await sb.auth.signInWithPassword({ email, password: pass });
        if (error) {
            const up = await sb.auth.signUp({ email, password: pass });
            if (up.error) { err.innerText = up.error.message; err.style.display = 'block'; return; }
            data = up.data;
            showToast('Account created!', 'success');
        }
        currentUser = data.user;
        rem ? localStorage.setItem('orbit_remember_email', email) : localStorage.removeItem('orbit_remember_email');
        await initApp();
    } catch (e) { err.innerText = 'Network error'; err.style.display = 'block'; }
}

async function resetPassword() {
    const email = document.getElementById('reset-email-in').value.trim();
    if (!email) { showToast('Enter email'); return; }
    try {
        await sb.auth.resetPasswordForEmail(email, { redirectTo: window.location.origin });
        document.getElementById('modal-reset').classList.remove('active');
        showToast('Reset link sent!', 'success');
    } catch (e) { showToast('Failed to send'); }
}

// ===================== APP INIT =====================
async function initApp() {
    // 1. Load profile from localStorage cache INSTANTLY (no DB wait)
    const cached = localStorage.getItem('orbit_profile_' + currentUser.id);
    if (cached) { try { userProfile = JSON.parse(cached); } catch(e) {} }
    
    updateDashHeader();
    document.getElementById('screen-auth').classList.remove('active');
    
    // 2. If no cached profile, do full async load
    if (!userProfile) {
        await loadUserProfile();
        const isNewUser = !userProfile?.first_name;
        if (isNewUser) {
            document.getElementById('screen-profile-setup').classList.add('active');
            return;
        }
    }
    finishAppInit();
    
    // 3. Refresh profile from DB in background (non-blocking)
    loadUserProfile().then(() => updateDashHeader()).catch(() => {});
}

async function finishAppInit() {
    updateDashHeader();
    document.getElementById('screen-dash').classList.add('active');
    // Load all tab data in parallel (non-blocking)
    Promise.all([
        loadChats(),
        loadGroups(),
        updatePresence(true).catch(() => {}),
        setupGlobalRealtime()
    ]).catch(() => {});
    startPresence();
}

async function updatePresence(online) {
    try {
        const displayName = userProfile ? ((userProfile.first_name || '') + (userProfile.last_name ? ' ' + userProfile.last_name : '')).trim() : '';
        await sb.from('user_presence').upsert({
            user_id: currentUser.id,
            email: currentUser.email,
            display_name: displayName || currentUser.email.split('@')[0],
            dp_url: userProfile?.dp_url || null,
            is_online: online,
            last_seen: new Date().toISOString(),
            updated_at: new Date().toISOString()
        });
    } catch (e) {}
}

function startPresence() {
    if (presenceInterval) clearInterval(presenceInterval);
    presenceInterval = setInterval(() => updatePresence(true), 30000);
    document.addEventListener('visibilitychange', () => updatePresence(!document.hidden));
    window.addEventListener('beforeunload', () => updatePresence(false));
}

// ===================== PROFILE =====================
async function loadUserProfile() {
    // Try supabase user_profiles table first, fallback to localStorage
    try {
        const { data } = await sb.from('user_profiles').select('*').eq('user_id', currentUser.id).single();
        if (data) { userProfile = data; localStorage.setItem('orbit_profile_' + currentUser.id, JSON.stringify(data)); return; }
    } catch(e) {}
    const cached = localStorage.getItem('orbit_profile_' + currentUser.id);
    if (cached) { userProfile = JSON.parse(cached); }
}

async function saveProfileToDB(profile) {
    try {
        await sb.from('user_profiles').upsert({ ...profile, user_id: currentUser.id, updated_at: new Date().toISOString() });
    } catch(e) { console.warn('user_profiles table may not exist yet — using localStorage only'); }
    userProfile = profile;
    localStorage.setItem('orbit_profile_' + currentUser.id, JSON.stringify(profile));
}

function updateDashHeader() {
    const av = document.getElementById('dash-av');
    const idEl = document.getElementById('dash-id');
    if (userProfile?.dp_url) {
        av.innerHTML = `<img src="${userProfile.dp_url}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;"><div class="av-dot"></div>`;
    } else {
        const initials = userProfile?.first_name ? (userProfile.first_name[0] + (userProfile.last_name?.[0] || '')).toUpperCase() : currentUser.email[0].toUpperCase();
        av.innerHTML = initials + '<div class="av-dot"></div>';
    }
    const name = userProfile?.first_name ? (userProfile.first_name + (userProfile.last_name ? ' ' + userProfile.last_name : '')) : currentUser.email.split('@')[0];
    idEl.innerText = name;
}

// Profile Setup Screen
let setupDpDataUrl = null;
function handleSetupDpFile(e) {
    const file = e.target.files?.[0];
    e.target.value = '';
    if (!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
        setupDpDataUrl = ev.target.result;
        const img = document.getElementById('setup-dp-preview');
        img.src = setupDpDataUrl;
        img.style.display = 'block';
        document.getElementById('setup-dp-overlay').style.display = 'none';
    };
    reader.readAsDataURL(file);
}

async function saveProfileSetup() {
    const first = document.getElementById('setup-first-name').value.trim();
    const last = document.getElementById('setup-last-name').value.trim();
    if (!first) { showToast('Enter your first name'); return; }
    document.getElementById('setup-save-btn').innerText = 'Saving...';
    let dpUrl = setupDpDataUrl || null;
    // Try to upload DP to storage if possible
    if (setupDpDataUrl) {
        try { dpUrl = await uploadDpToStorage(setupDpDataUrl); } catch(e) { dpUrl = setupDpDataUrl; }
    }
    const profile = { first_name: first, last_name: last || null, dp_url: dpUrl };
    await saveProfileToDB(profile);
    document.getElementById('screen-profile-setup').classList.remove('active');
    document.getElementById('setup-save-btn').innerText = 'CONTINUE TO ORBIT';
    setupDpDataUrl = null;
    finishAppInit();
}

function skipProfileSetup() {
    userProfile = { first_name: null, last_name: null, dp_url: null };
    document.getElementById('screen-profile-setup').classList.remove('active');
    finishAppInit();
}

// Profile Edit Modal
let profileDpDataUrl = null;
function openProfileModal() {
    const fn = userProfile?.first_name || '';
    const ln = userProfile?.last_name || '';
    document.getElementById('profile-first-name').value = fn;
    document.getElementById('profile-last-name').value = ln;
    const prevImg = document.getElementById('profile-dp-preview');
    const overlay = document.getElementById('profile-dp-overlay');
    if (userProfile?.dp_url) {
        prevImg.src = userProfile.dp_url;
        prevImg.style.display = 'block';
        overlay.style.display = 'none';
    } else {
        prevImg.style.display = 'none';
        overlay.style.display = 'flex';
    }
    profileDpDataUrl = null;
    document.getElementById('modal-profile').classList.add('active');
}

function handleProfileDpFile(e) {
    const file = e.target.files?.[0];
    e.target.value = '';
    if (!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
        profileDpDataUrl = ev.target.result;
        const img = document.getElementById('profile-dp-preview');
        img.src = profileDpDataUrl;
        img.style.display = 'block';
        document.getElementById('profile-dp-overlay').style.display = 'none';
    };
    reader.readAsDataURL(file);
}

async function saveProfileEdit() {
    const first = document.getElementById('profile-first-name').value.trim();
    const last = document.getElementById('profile-last-name').value.trim();
    if (!first) { showToast('Enter your first name'); return; }
    document.getElementById('save-profile-btn').innerText = 'Saving...';
    let dpUrl = profileDpDataUrl ? profileDpDataUrl : (userProfile?.dp_url || null);
    if (profileDpDataUrl) {
        try { dpUrl = await uploadDpToStorage(profileDpDataUrl); } catch(e) { dpUrl = profileDpDataUrl; }
    }
    const profile = { first_name: first, last_name: last || null, dp_url: dpUrl };
    await saveProfileToDB(profile);
    document.getElementById('modal-profile').classList.remove('active');
    document.getElementById('save-profile-btn').innerText = 'Save';
    profileDpDataUrl = null;
    updateDashHeader();
    await updatePresence(true);
    showToast('Profile updated!', 'success');
}

async function uploadDpToStorage(dataUrl) {
    // Try Supabase storage first; if unavailable, store as base64 directly
    try {
        const res = await fetch(dataUrl);
        const blob = await res.blob();
        const path = `profile_dp/${currentUser.id}_${Date.now()}.jpg`;
        const { error } = await sb.storage.from('chat-assets').upload(path, blob, { cacheControl: '3600', upsert: true, contentType: 'image/jpeg' });
        if (error) throw error;
        return `${SB_URL}/storage/v1/object/public/chat-assets/${path}`;
    } catch(e) {
        console.warn('DP storage upload failed, using base64:', e.message);
        // Compress before storing as base64 to keep it small
        return await compressDpToBase64(dataUrl);
    }
}

async function compressDpToBase64(dataUrl) {
    return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => {
            const SIZE = 200;
            const canvas = document.createElement('canvas');
            canvas.width = SIZE; canvas.height = SIZE;
            const ctx = canvas.getContext('2d');
            // crop square from center
            const min = Math.min(img.width, img.height);
            const sx = (img.width - min) / 2, sy = (img.height - min) / 2;
            ctx.drawImage(img, sx, sy, min, min, 0, 0, SIZE, SIZE);
            resolve(canvas.toDataURL('image/jpeg', 0.75));
        };
        img.onerror = () => resolve(dataUrl);
        img.src = dataUrl;
    });
}

function getMyDisplayName() {
    if (!userProfile) return currentUser.email.split('@')[0];
    return userProfile.first_name ? (userProfile.first_name + (userProfile.last_name ? ' ' + userProfile.last_name : '')) : currentUser.email.split('@')[0];
}


async function loadChats() {
    const list = document.getElementById('chats-list');
    // Show skeleton while loading
    if (!list.children.length || list.innerHTML.includes('loader')) {
        list.innerHTML = `<div style="padding:8px 12px;">${[1,2,3].map(() => `<div style="display:flex;align-items:center;gap:14px;padding:12px;"><div style="width:50px;height:50px;border-radius:50%;background:#1a1a1a;flex-shrink:0;"></div><div style="flex:1;"><div style="height:14px;background:#1a1a1a;border-radius:6px;width:60%;margin-bottom:8px;"></div><div style="height:11px;background:#1a1a1a;border-radius:6px;width:80%;"></div></div></div>`).join('')}</div>`;
    }
    try {
        const { data: memberships, error } = await sb
            .from('room_members')
            .select('room_id, rooms!inner(id, name, is_direct, created_at)')
            .eq('user_id', currentUser.id)
            .limit(50);
        
        if (error) throw error;
        if (!memberships?.length) { list.innerHTML = emptyState('fa-comments', 'No conversations yet', 'Start chatting in Groups or Global'); return; }
        
        // Deduplicate by room_id (prevent showing same room twice)
        const seenRooms = new Map();
        memberships.forEach(m => { if (!seenRooms.has(m.room_id)) seenRooms.set(m.room_id, m); });
        const uniqueMemberships = Array.from(seenRooms.values());
        const roomIds = uniqueMemberships.map(m => m.room_id);
        let html = '';
        uniqueMemberships.forEach(m => {
            const r = m.rooms;
            const initials = r.name ? r.name[0].toUpperCase() : '?';
            html += `<div class="contact-item touch-fix" data-rid="${m.room_id}" data-rname="${esc(r.name)}">
                <div class="c-av"><div class="c-av-inner">${initials}</div></div>
                <div class="c-info"><div class="c-name">${esc(r.name)}</div><div class="c-last" id="preview-${m.room_id}">Loading...</div></div>
                <div class="c-meta"><div class="c-time" id="time-${m.room_id}"></div></div>
            </div>`;
        });
        list.innerHTML = html;
        list.querySelectorAll('.contact-item').forEach(el => el.addEventListener('click', () => openRoom(el.dataset.rid, el.dataset.rname, el.dataset.direct === 'true')));
        
        // Fetch last messages in background (non-blocking)
        sb.from('messages')
            .select('room, text, type, created_at')
            .in('room', roomIds)
            .order('created_at', { ascending: false })
            .limit(100)
            .then(({ data: lastMsgs }) => {
                const lastMap = new Map();
                (lastMsgs || []).forEach(m => {
                    if (!lastMap.has(m.room)) lastMap.set(m.room, m);
                });
                uniqueMemberships.forEach(m => {
                    const lm = lastMap.get(m.room_id);
                    const previewEl = document.getElementById('preview-' + m.room_id);
                    const timeEl = document.getElementById('time-' + m.room_id);
                    if (previewEl) previewEl.innerText = lm ? (lm.type === 'text' ? trunc(lm.text, 35) : lm.type === 'image' ? '📷 Image' : lm.type === 'video' ? '📹 Video' : '📄 Document') : 'No messages yet';
                    if (timeEl && lm) timeEl.innerText = fmtTime(lm.created_at);
                });
            }).catch(() => {});
    } catch (e) { 
        console.error('loadChats:', e); 
        list.innerHTML = emptyState('fa-comments', 'Could not load chats', 'Tap to retry'); 
        list.onclick = () => { list.onclick = null; loadChats(); };
    }
}

async function loadSecureChats() {
    const list = document.getElementById('secure-list');
    try {
        list.innerHTML = '<div class="loader"></div>';
        const { data, error } = await sb
            .from('personal_chats')
            .select('id, name, description, created_at, updated_at')
            .eq('user_id', currentUser.id)
            .order('updated_at', { ascending: false })
            .limit(30);
        
        if (error) {
            // Table doesn't exist yet — show setup message instead of crash
            if (error.code === 'PGRST205' || error.message?.includes('personal_chats')) {
                list.innerHTML = emptyState('fa-lock', 'Secure Chats not set up', 'Run the SQL migration in Supabase to enable this feature');
                console.info('ℹ️ personal_chats table missing — run the SQL migration shown in the comments at the bottom of this file.');
                return;
            }
            throw error;
        }
        if (!data?.length) { 
            list.innerHTML = emptyState('fa-lock', 'No secure chats', 'Tap "New" to create a private encrypted chat'); 
            return; 
        }
        let html = '';
        data.forEach(c => {
            html += `<div class="secure-item touch-fix" data-cid="${c.id}">
                <div class="secure-av"><i class="fa-solid fa-lock"></i></div>
                <div style="flex:1;overflow:hidden;">
                    <div class="secure-name">${esc(c.name || 'Secure Chat')}</div>
                    <div class="secure-desc">${esc(c.description || 'Personal encrypted chat')}</div>
                </div>
                <div class="enc-badge">E2E</div>
            </div>`;
        });
        list.innerHTML = html;
        list.querySelectorAll('.secure-item').forEach(el => el.addEventListener('click', () => openPersonalChat(el.dataset.cid)));
    } catch (e) { 
        console.error('loadSecureChats:', e);
        list.innerHTML = emptyState('fa-lock', 'Could not load secure chats'); 
    }
}

async function loadFriends() {
    try {
        const { data } = await sb.from('friends').select('*, users!friends_friend_id_fkey(email,id)').eq('user_id', currentUser.id).eq('status', 'accepted');
        const list = document.getElementById('friends-list');
        if (!data?.length) { list.innerHTML = emptyState('fa-user-friends', 'No friends yet', 'Add friends to start chatting'); return; }
        let html = '';
        data.forEach(f => {
            const name = f.users.email.split('@')[0];
            html += `<div class="contact-item touch-fix" data-uid="${f.users.id}" data-uname="${esc(name)}">
                <div class="c-av"><div class="c-av-inner">${esc(name[0])}</div></div>
                <div class="c-info"><div class="c-name">${esc(name)}</div><div class="c-last">Friend</div></div></div>`;
        });
        list.innerHTML = html;
        list.querySelectorAll('.contact-item').forEach(el => el.addEventListener('click', () => startChat(el.dataset.uid, el.dataset.uname)));
    } catch (e) {}
}

async function loadGroups() {
    const list = document.getElementById('groups-list');
    if (!list.children.length) {
        list.innerHTML = `<div style="padding:8px 12px;">${[1,2].map(() => `<div style="display:flex;align-items:center;gap:14px;padding:12px;"><div style="width:50px;height:50px;border-radius:50%;background:#1a1a1a;flex-shrink:0;"></div><div style="flex:1;"><div style="height:14px;background:#1a1a1a;border-radius:6px;width:50%;margin-bottom:8px;"></div><div style="height:11px;background:#1a1a1a;border-radius:6px;width:70%;"></div></div></div>`).join('')}</div>`;
    }
    try {
        const { data, error } = await sb
            .from('room_members')
            .select('room_id, rooms!inner(id, name, is_direct, topic, created_at, dp_url)')
            .eq('user_id', currentUser.id)
            .limit(100);
        
        if (error) throw error;
        
        // Filter to non-direct rooms and STRONGLY deduplicate by room ID
        const seenIds = new Set();
        const groups = [];
        (data || []).forEach(m => {
            if (m.rooms && !m.rooms.is_direct && !seenIds.has(m.rooms.id)) {
                seenIds.add(m.rooms.id);
                groups.push(m);
            }
        });
        
        if (!groups.length) { list.innerHTML = emptyState('fa-users', 'No groups yet', 'Create a group to get started'); return; }
        
        let html = '';
        groups.forEach(m => {
            const r = m.rooms;
            const dpHtml = r.dp_url 
                ? `<img src="${esc(r.dp_url)}" class="group-dp-img" onerror="this.parentNode.innerHTML='<div class=\\'c-av-inner\\'><i class=\\'fa-solid fa-users\\'></i></div>'">`
                : `<div class="c-av-inner"><i class="fa-solid fa-users" style="font-size:16px;"></i></div>`;
            html += `<div class="contact-item touch-fix" data-rid="${r.id}" data-rname="${esc(r.name)}">
                <div class="c-av">${dpHtml}</div>
                <div class="c-info"><div class="c-name">${esc(r.name)}</div><div class="c-last">${esc(r.topic || 'Group chat')}</div></div>
                <div class="group-actions">
                    <button class="group-edit-btn touch-fix" data-rid="${r.id}" data-rname="${esc(r.name)}"><i class="fa-solid fa-gear"></i></button>
                    <button class="group-del-btn touch-fix" data-rid="${r.id}" data-rname="${esc(r.name)}"><i class="fa-solid fa-trash"></i></button>
                </div>
            </div>`;
        });
        
        list.innerHTML = html;
        
        list.querySelectorAll('.contact-item').forEach(el => {
            el.addEventListener('click', e => {
                if (e.target.closest('.group-del-btn') || e.target.closest('.group-edit-btn')) return;
                openRoom(el.dataset.rid, el.dataset.rname);
            });
        });
        list.querySelectorAll('.group-del-btn').forEach(b => {
            b.addEventListener('click', async e => {
                e.stopPropagation();
                e.preventDefault();
                const rname = b.dataset.rname;
                const rid = b.dataset.rid;
                if (!confirm(`Delete group "${rname}"? This cannot be undone.`)) return;
                b.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
                await deleteGroupById(rid);
            });
        });
        list.querySelectorAll('.group-edit-btn').forEach(b => {
            b.addEventListener('click', e => {
                e.stopPropagation();
                openGroupSettingsFromList(b.dataset.rid, b.dataset.rname);
            });
        });
    } catch (e) { 
        console.error('loadGroups:', e); 
        list.innerHTML = emptyState('fa-users', 'Could not load groups', 'Tap to retry');
        list.onclick = () => { list.onclick = null; loadGroups(); };
    }
}

async function loadGlobalUsers() {
    const list = document.getElementById('global-list');
    try {
        list.innerHTML = '<div class="loader"></div>';
        const { data, error } = await sb
            .from('user_presence')
            .select('user_id, email, display_name, dp_url, is_online, last_seen')
            .neq('user_id', currentUser.id)
            .order('last_seen', { ascending: false })
            .limit(80);
        
        if (error) throw error;
        if (!data?.length) { list.innerHTML = emptyState('fa-users', 'No users yet'); return; }
        
        let onlineCount = 0;
        let html = '';
        const now = Date.now();
        
        data.forEach(u => {
            const isOnline = u.is_online && (now - new Date(u.last_seen).getTime() < 90000);
            if (isOnline) onlineCount++;
            const name = u.display_name || (u.email ? u.email.split('@')[0] : 'User');
            globalUsersCache.set(u.user_id, u);
            const initials = (name[0] || 'U').toUpperCase();
            const avHtml = u.dp_url
                ? `<img src="${esc(u.dp_url)}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;" loading="lazy" onerror="this.parentNode.innerHTML='<div class=\\'c-av-inner\\'>${initials}</div>'">`
                : `<div class="c-av-inner">${initials}</div>`;
            html += `<div class="contact-item touch-fix" data-uid="${u.user_id}" data-uname="${esc(name)}">
                <div class="c-av">${avHtml}<div class="c-status-dot ${isOnline ? 'online' : 'offline'}"></div></div>
                <div class="c-info">
                    <div class="c-name">${esc(name)}</div>
                    <div class="c-last">${isOnline ? '🟢 Online now' : '⏱ ' + timeAgo(u.last_seen)}</div>
                </div>
            </div>`;
        });
        list.innerHTML = html;
        updateOnlineCount(onlineCount);
        list.querySelectorAll('.contact-item').forEach(el => el.addEventListener('click', () => startChat(el.dataset.uid, el.dataset.uname)));
    } catch (e) { 
        console.error('loadGlobalUsers:', e);
        list.innerHTML = emptyState('fa-users', 'Could not load users', 'Tap to retry');
        list.onclick = () => { list.onclick = null; loadGlobalUsers(); };
    }
}

async function loadNotes() {
    try {
        const { data } = await sb.from('secure_notes').select('*').eq('user_id', currentUser.id).order('updated_at', { ascending: false }).limit(30);
        const list = document.getElementById('notes-list');
        notesCache.clear();
        if (!data?.length) { list.innerHTML = emptyState('fa-note-sticky', 'No notes yet'); return; }
        let html = '';
        data.forEach(n => {
            notesCache.set(n.id, n);
            const preview = n.content.length > 100 ? n.content.substring(0, 100) + '...' : n.content;
            html += `<div class="note-card" data-nid="${n.id}">
                <div class="note-actions">
                    <button class="note-btn touch-fix" data-act="edit"><i class="fa-solid fa-pen"></i></button>
                    <button class="note-btn touch-fix" style="color:#ff4444;" data-act="delete"><i class="fa-solid fa-trash"></i></button>
                </div>
                <div class="note-title">${esc(n.title)}</div>
                <div class="note-body">${esc(preview)}</div>
                <div class="note-date">${new Date(n.updated_at).toLocaleDateString()}</div></div>`;
        });
        list.innerHTML = html;
        list.querySelectorAll('.note-card').forEach(card => {
            const id = card.dataset.nid;
            card.querySelector('[data-act="edit"]').addEventListener('click', e => { e.stopPropagation(); editNote(id); });
            card.querySelector('[data-act="delete"]').addEventListener('click', e => { e.stopPropagation(); deleteNote(id); });
        });
    } catch (e) {}
}

// ===================== CHAT OPEN =====================
async function openRoom(roomId, roomName, isDirect) {
    try {
        currentRoom = roomId;
        isPersonalChat = false;
        document.getElementById('chat-title').innerText = roomName;
        document.getElementById('chat-status').innerText = 'Loading...';
        document.getElementById('fav-btn').innerHTML = favorites.includes(roomId) ? '<i class="fa-solid fa-star"></i>' : '<i class="fa-regular fa-star"></i>';
        document.getElementById('group-info-btn').style.display = (isDirect === true) ? 'none' : 'block';
        navigate('chat');
        const feed = document.getElementById('chat-feed');
        feed.innerHTML = '<div class="loader"></div>';
        messageCache.clear();
        pinnedMessages.clear();
        hasMoreMessages = true;
        oldestMsgDate = null;
        document.getElementById('sel-toggle-btn').style.display = 'block';
        exitSelectMode();
        // Start subscription immediately (non-blocking)
        setupRoomSub(roomId, false);
        setupTypingChannel(roomId);
        // Load messages and pinned in parallel
        const [,] = await Promise.all([
            loadRoomMsgs(roomId),
            loadPinned(roomId)
        ]);
        document.getElementById('chat-status').innerText = 'Connected';
    } catch (e) { console.error('openRoom:', e); showToast('Failed to open chat'); navBack(); }
}

async function openPersonalChat(chatId) {
    try {
        const { data: chat } = await sb.from('personal_chats').select('*').eq('id', chatId).eq('user_id', currentUser.id).single();
        currentRoom = chatId;
        isPersonalChat = true;
        document.getElementById('chat-title').innerText = chat.name || 'Secure Chat';
        document.getElementById('chat-status').innerText = '🔒 Encrypted';
        document.getElementById('group-info-btn').style.display = 'none';
        navigate('chat');
        const feed = document.getElementById('chat-feed');
        feed.innerHTML = '<div class="loader"></div>';
        messageCache.clear();
        hasMoreMessages = true;
        oldestMsgDate = null;
        document.getElementById('sel-toggle-btn').style.display = 'block';
        exitSelectMode();
        // Start subscription immediately
        setupRoomSub(chatId, true);
        setupTypingChannel(chatId);
        await loadPersonalMsgs(chatId);
    } catch (e) { showToast('Failed to open chat'); navBack(); }
}

async function loadRoomMsgs(roomId) {
    try {
        const { data } = await sb.from('messages').select('*').eq('room', roomId).order('created_at', { ascending: false }).limit(20);
        const msgs = (data || []).reverse();
        renderMsgs(msgs);
        if (msgs.length >= 20) { hasMoreMessages = true; oldestMsgDate = msgs[0]?.created_at; }
        else { hasMoreMessages = false; }
    } catch (e) { document.getElementById('chat-feed').innerHTML = '<div style="text-align:center;padding:40px;color:#ff4444;">Error loading messages</div>'; }
}

async function loadPersonalMsgs(chatId) {
    try {
        const { data } = await sb.from('personal_chat_messages').select('*').eq('chat_id', chatId).order('created_at', { ascending: false }).limit(20);
        const msgs = (data || []).reverse();
        renderMsgs(msgs);
        if (msgs.length >= 20) { hasMoreMessages = true; oldestMsgDate = msgs[0]?.created_at; }
        else { hasMoreMessages = false; }
    } catch (e) { document.getElementById('chat-feed').innerHTML = '<div style="text-align:center;padding:40px;color:#ff4444;">Error loading messages</div>'; }
}

async function loadPinned(roomId) {
    try {
        const { data } = await sb.from('pinned_messages').select('*').eq('room_id', roomId);
        (data || []).forEach(p => pinnedMessages.set(p.message_id, p));
    } catch (e) {}
}

function renderMsgs(msgs) {
    const feed = document.getElementById('chat-feed');
    feed.innerHTML = '';
    if (!msgs.length) {
        feed.innerHTML = '<div class="empty-state"><i class="fa-solid fa-comment"></i><div>No messages yet</div><div style="font-size:11px;margin-top:6px;">Send your first message!</div></div>';
        return;
    }
    const frag = document.createDocumentFragment();
    let lastDate = null;
    msgs.forEach(msg => {
        if ((msg.deleted_by || []).includes(currentUser.id)) return;
        const d = new Date(msg.created_at).toDateString();
        if (d !== lastDate) { frag.appendChild(makeDateBadge(msg.created_at)); lastDate = d; }
        frag.appendChild(buildMsgNode(msg));
        messageCache.set(msg.id, msg);
    });
    feed.appendChild(frag);
    scrollBottom();
    attachMsgListeners();
}

// ===================== MESSAGE NODE =====================
function buildMsgNode(msg) {
    const isOwn = msg.sender_id === currentUser.id;
    const isPinned = pinnedMessages.has(msg.id);
    const div = document.createElement('div');
    div.className = 'msg-row ' + (isOwn ? 'own' : 'other');
    if (isPinned) div.classList.add('pinned');
    div.id = 'msg-' + msg.id;
    div.dataset.messageId = msg.id;

    // Checkbox
    const cb = document.createElement('div');
    cb.className = 'msg-checkbox';
    div.appendChild(cb);

    // Swipe indicator
    const si = document.createElement('div');
    si.className = 'swipe-indicator';
    si.innerHTML = '<i class="fa-solid fa-reply"></i>';
    div.appendChild(si);

    // Tick
    let tick = '';
    if (isOwn) {
        if (msg._pending) tick = '<span class="msg-loader"></span>';
        else {
            const reads = ((msg.read_by || []).filter(id => id !== currentUser.id)).length;
            tick = reads > 0 ? '<i class="fa-solid fa-check-double tick-icon tick-read"></i>' : '<i class="fa-solid fa-check tick-icon tick-dlvd"></i>';
        }
    }
    const time = fmtTime(msg.created_at);

    // Reply context
    let replyHtml = '';
    if (msg.reply_to) {
        replyHtml = `<div class="reply-context" data-replyto="${msg.reply_to.id}">
            <div class="reply-author">${esc(msg.reply_to.username)}</div>
            <div class="reply-preview">${esc(msg.reply_to.text || 'Media')}</div></div>`;
    }

    // Content
    let content = '';
    if (msg.type === 'image' && msg.attachments?.length) {
        content = buildImageContent(msg);
    } else if (msg.type === 'video' && msg.attachments?.[0]) {
        const url = mediaUrl(msg.attachments[0]);
        content = `<video class="msg-video touch-fix" src="${url}" data-url="${url}" data-title="${esc(msg.text||'Video')}" data-type="video" poster="" preload="metadata" playsinline></video>`;
        if (msg.text && !msg.text.match(/^\d+ images?$/)) content += `<div style="font-size:11px;margin-top:3px;opacity:.7;">${esc(msg.text)}</div>`;
    } else if (msg.type === 'document' && msg.attachments?.[0]) {
        const url = mediaUrl(msg.attachments[0]);
        const name = msg.text || 'Document';
        const ext = name.split('.').pop().toUpperCase();
        const iconMap = { PDF:'fa-file-pdf', DOC:'fa-file-word', DOCX:'fa-file-word', XLS:'fa-file-excel', XLSX:'fa-file-excel', PPT:'fa-file-powerpoint', PPTX:'fa-file-powerpoint', ZIP:'fa-file-zipper', TXT:'fa-file-lines', CSV:'fa-file-csv', RTF:'fa-file-lines' };
        const colorMap = { PDF:'#FF3B30', DOC:'#007AFF', DOCX:'#007AFF', XLS:'#34C759', XLSX:'#34C759', PPT:'#FF9500', PPTX:'#FF9500', ZIP:'#8E8E93', TXT:'#636366', CSV:'#34C759', RTF:'#636366' };
        const icon = iconMap[ext] || 'fa-file';
        const color = colorMap[ext] || '#8E8E93';
        const isOwnMsg = msg.sender_id === currentUser.id;
        // Size display — read from metadata (new) or file_size (legacy) or fallback to ext
        const rawSize = msg.metadata?.file_size || msg.file_size || null;
        const sizeLabel = rawSize ? (rawSize > 1048576 ? (rawSize/1048576).toFixed(1)+'MB' : Math.round(rawSize/1024)+'KB') : ext;
        content = `<div class="doc-card touch-fix" data-url="${esc(url)}" data-name="${esc(name)}" data-ext="${ext}" style="background:${isOwnMsg ? 'rgba(0,0,0,0.15)' : 'rgba(255,255,255,0.07)'}">
            <div style="width:44px;height:44px;border-radius:10px;background:${color}22;display:flex;align-items:center;justify-content:center;flex-shrink:0;">
                <i class="fa-solid ${icon}" style="color:${color};font-size:22px;"></i>
            </div>
            <div style="flex:1;overflow:hidden;">
                <div class="doc-name">${esc(trunc(name,30))}</div>
                <div class="doc-sub">${sizeLabel} · Tap to ${ext==='PDF'?'preview':'open'}</div>
            </div>
            <div style="display:flex;flex-direction:column;align-items:center;gap:4px;flex-shrink:0;">
                <i class="fa-solid fa-arrow-down-to-line" style="color:${color};font-size:14px;opacity:0.8;"></i>
            </div>
        </div>`;
    } else {
        content = `<div style="white-space:pre-wrap;word-break:break-word;">${esc(msg.text || '')}</div>`;
    }

    let pinBadge = isPinned ? ' <i class="fa-solid fa-thumbtack pin-badge"></i>' : '';
    div.innerHTML += `<div class="msg-bubble">${replyHtml}${content}<div class="msg-meta">${time}${pinBadge} ${tick}</div></div>`;
    
    // Add reactions OUTSIDE the bubble (below it, WhatsApp-style)
    if (msg.reactions && Object.keys(msg.reactions).length) {
        const reactEl = buildReactionsEl(msg.reactions, msg.id);
        if (reactEl) div.appendChild(reactEl);
    }
    
    return div;
}

function buildImageContent(msg) {
    const atts = msg.attachments;
    const count = atts.length;
    let gridClass = count === 1 ? 'g1' : count === 2 ? 'g2' : count === 3 ? 'g3' : 'g4';
    let html = `<div class="image-grid ${gridClass}">`;
    const maxShow = Math.min(count, 4);
    for (let i = 0; i < maxShow; i++) {
        const url = mediaUrl(atts[i]);
        const allUrls = atts.map(a => mediaUrl(a)).join('||');
        if (i === 3 && count > 4) {
            html += `<div class="gi-more" data-urls="${esc(allUrls)}" data-start="${i}" data-title="${esc(msg.text||'Images')}">
                <img src="${url}" alt=""><div class="gi-more-over">+${count - 3}</div></div>`;
        } else {
            html += `<img class="gi touch-fix" src="${url}" data-url="${url}" data-urls="${esc(allUrls)}" data-start="${i}" data-title="${esc(msg.text||'Images')}" alt="" loading="lazy">`;
        }
    }
    html += '</div>';
    if (msg.text && !msg.text.match(/^\d+ images?$/) && count > 1) html += `<div style="font-size:11px;margin-top:3px;opacity:.7;">${esc(msg.text)}</div>`;
    return html;
}

// ===================== MSG LISTENERS =====================
function attachMsgListeners() {
    document.querySelectorAll('.msg-row').forEach(row => {
        row.removeEventListener('touchstart', onSwipeStart);
        row.removeEventListener('touchmove', onSwipeMove);
        row.removeEventListener('touchend', onSwipeEnd);
        row.removeEventListener('contextmenu', onCtxMenu);
        row.addEventListener('touchstart', onSwipeStart, { passive: true });
        row.addEventListener('touchmove', onSwipeMove, { passive: false });
        row.addEventListener('touchend', onSwipeEnd, { passive: true });
        row.addEventListener('contextmenu', onCtxMenu);
        // Checkbox
        const cb = row.querySelector('.msg-checkbox');
        cb.onclick = e => { e.stopPropagation(); if (isSelectMode) toggleSel(row.dataset.messageId, cb); };
        // Image click
        row.querySelectorAll('.gi, .gi-more').forEach(el => {
            el.addEventListener('click', e => {
                e.stopPropagation();
                const urls = el.dataset.urls ? el.dataset.urls.split('||') : [el.dataset.url];
                const start = parseInt(el.dataset.start || '0');
                openLightboxImages(urls, el.dataset.title || 'Images', start);
            });
        });
        // Single image
        row.querySelectorAll('.single-img').forEach(img => {
            img.addEventListener('click', e => { e.stopPropagation(); openLightbox(img.dataset.url || img.src, 'image', img.dataset.title || 'Image'); });
        });
        // Video click
        row.querySelectorAll('.msg-video').forEach(vid => {
            vid.addEventListener('click', e => {
                e.stopPropagation();
                openLightbox(vid.dataset.url || vid.src, 'video', vid.dataset.title || 'Video');
            });
        });
        // Document download/open
        row.querySelectorAll('.doc-card').forEach(card => {
            card.addEventListener('click', e => {
                e.stopPropagation();
                const url = card.dataset.url;
                const name = card.dataset.name || 'document';
                const ext = (card.dataset.ext || name.split('.').pop()).toUpperCase();
                if (!url) return;
                if (ext === 'PDF') {
                    openPdfViewer(url, name);
                } else if (url.startsWith('data:') || url.startsWith('http')) {
                    dlFile(url, name);
                } else {
                    window.open(url, '_blank');
                }
            });
        });
        // Reply context scroll
        row.querySelectorAll('.reply-context').forEach(el => {
            el.addEventListener('click', e => {
                e.stopPropagation();
                const target = document.getElementById('msg-' + el.dataset.replyto);
                if (target) { target.scrollIntoView({ behavior: 'smooth', block: 'center' }); target.classList.add('selected'); setTimeout(() => target.classList.remove('selected'), 1800); }
            });
        });
    });
}

// ===================== SWIPE =====================
function onSwipeStart(e) {
    if (isSelectMode) return;
    swipeStartX = e.touches[0].clientX;
    swipeStartY = e.touches[0].clientY;
    swipeEl = e.currentTarget;
}
function onSwipeMove(e) {
    if (!swipeEl || isSelectMode) return;
    const dx = e.touches[0].clientX - swipeStartX;
    const dy = Math.abs(e.touches[0].clientY - swipeStartY);
    if (dy > 25) return;
    if (dx > SWIPE_THRESHOLD && !swipeEl.classList.contains('own')) { swipeEl.classList.add('swiping'); e.preventDefault(); }
    else swipeEl.classList.remove('swiping');
}
function onSwipeEnd(e) {
    if (!swipeEl || isSelectMode) return;
    const dx = e.changedTouches[0].clientX - swipeStartX;
    const dy = Math.abs(e.changedTouches[0].clientY - swipeStartY);
    if (dy < 25 && dx > SWIPE_THRESHOLD && !swipeEl.classList.contains('own')) {
        const msg = messageCache.get(swipeEl.dataset.messageId);
        if (msg) setReply(msg);
    }
    swipeEl.classList.remove('swiping');
    swipeEl = null;
}

// ===================== CONTEXT MENU =====================
function onCtxMenu(e) {
    e.preventDefault();
    e.stopPropagation();
    if (isSelectMode) { toggleSel(e.currentTarget.dataset.messageId, e.currentTarget.querySelector('.msg-checkbox')); return; }
    selectedMsg = messageCache.get(e.currentTarget.dataset.messageId);
    openCtx(e);
}
function openCtx(e) {
    const menu = document.getElementById('ctx-menu');
    const overlay = document.getElementById('ctx-overlay');
    overlay.classList.add('active');
    const vp = document.getElementById('app-viewport').getBoundingClientRect();
    let x = (e.clientX || e.touches?.[0]?.clientX || 100) - vp.left;
    let y = (e.clientY || e.touches?.[0]?.clientY || 200) - vp.top;
    if (x + 225 > vp.width) x = vp.width - 228;
    if (y + 320 > vp.height) y = vp.height - 325;
    if (x < 5) x = 5; if (y < 5) y = 5;
    menu.style.left = x + 'px'; menu.style.top = y + 'px';
    setTimeout(() => menu.classList.add('active'), 10);
}
function closeCtx() {
    document.getElementById('ctx-menu').classList.remove('active');
    document.getElementById('ctx-overlay').classList.remove('active');
}
function handleCtx(action) {
    closeCtx();
    if (!selectedMsg) return;
    switch (action) {
        case 'react': if (selectedMsg) { reactionPickerMsgId = selectedMsg.id; document.getElementById('reaction-picker').style.display = 'flex'; const vp = document.getElementById('app-viewport').getBoundingClientRect(); document.getElementById('reaction-picker').style.left = (vp.width/2 - 120) + 'px'; document.getElementById('reaction-picker').style.top = (vp.height/2) + 'px'; setTimeout(() => document.addEventListener('click', closeReactionPicker, {once:true}), 10); } break;
        case 'reply': setReply(selectedMsg); break;
        case 'copy': navigator.clipboard.writeText(selectedMsg.text || '').then(() => showToast('Copied!', 'success')); break;
        case 'pin': document.getElementById('modal-pin').classList.add('active'); break;
        case 'download':
            if (selectedMsg.attachments?.[0]) dlFile(mediaUrl(selectedMsg.attachments[0]), selectedMsg.text || 'file');
            else showToast('No file attached');
            break;
        case 'del-me': deleteMessageId = selectedMsg.id; deleteForMe(); break;
        case 'del-all': deleteMessageId = selectedMsg.id; deleteForAll(); break;
    }
}

// ===================== REPLY =====================
function setReply(msg) {
    replyToMsg = msg;
    document.getElementById('reply-bar').classList.remove('hide');
    document.getElementById('reply-user').innerText = 'Replying to ' + (msg.username || 'User');
    document.getElementById('reply-txt').innerText = msg.type === 'text' ? (msg.text || '') : '📎 Media';
    document.getElementById('msg-input').focus();
}
function cancelReply() { replyToMsg = null; document.getElementById('reply-bar').classList.add('hide'); }

// ===================== SEND MESSAGE =====================
async function sendMessage() {
    if (selectedFiles.length > 0) { await sendFiles(); return; }
    const input = document.getElementById('msg-input');
    const text = input.value.trim();
    if (!text || !currentRoom) return;
    input.value = '';
    input.style.height = 'auto';

    const payload = {
        sender_id: currentUser.id,
        username: getMyDisplayName(),
        text,
        type: 'text',
        read_by: [currentUser.id],
        created_at: new Date().toISOString(),
        ...(isPersonalChat ? { chat_id: currentRoom } : { room: currentRoom })
    };
    if (replyToMsg) {
        payload.reply_to = { id: replyToMsg.id, username: replyToMsg.username, text: replyToMsg.type === 'text' ? replyToMsg.text : 'Media' };
        cancelReply();
    }

    // Optimistic UI
    const lid = '__local_' + (++localCounter);
    const localMsg = { ...payload, id: lid, _pending: true };
    messageCache.set(lid, localMsg);
    const node = buildMsgNode(localMsg);
    node.classList.add('sending');
    document.getElementById('chat-feed').appendChild(node);
    scrollBottom();
    attachMsgListeners();

    try {
        const table = isPersonalChat ? 'personal_chat_messages' : 'messages';
        const { data, error } = await sb.from(table).insert([payload]).select().single();
        if (error) throw error;
        document.getElementById('msg-' + lid)?.remove();
        messageCache.delete(lid);
        if (!messageCache.has(data.id)) {
            messageCache.set(data.id, data);
            document.getElementById('chat-feed').appendChild(buildMsgNode(data));
            scrollBottom();
            attachMsgListeners();
        }
    } catch (e) {
        const n = document.getElementById('msg-' + lid);
        if (n) { n.classList.remove('sending'); n.classList.add('failed'); }
        showToast('Failed to send');
    }
}

// ===================== SEND FILES — V83 SMART PIPELINE (STORAGE + BASE64 FALLBACK) =====================
async function sendFiles() {
    if (!selectedFiles.length || !currentRoom || uploadInProgress) return;
    uploadInProgress = true;
    const files = [...selectedFiles];
    clearMediaPreview();

    const imageFiles = files.filter(f => f.type.startsWith('image/'));
    const videoFiles = files.filter(f => f.type.startsWith('video/'));
    const docFiles   = files.filter(f => !f.type.startsWith('image/') && !f.type.startsWith('video/'));

    const totalGroups = (imageFiles.length > 0 ? 1 : 0) + videoFiles.length + docFiles.length;
    let sentCount = 0;

    showUploadOverlay(true, `${files.length} file(s)`);
    updateProgressRing(2);

    try {
        // ── Images ──
        if (imageFiles.length > 0 && !uploadCanceled) {
            updateUploadUI(imageFiles.length === 1 ? imageFiles[0].name : `${imageFiles.length} images`, 1, totalGroups, 5);
            const mediaUrls = [];
            for (let i = 0; i < imageFiles.length; i++) {
                if (uploadCanceled) break;
                updateUploadUI(`Processing image ${i+1}/${imageFiles.length}`, 1, totalGroups, 5 + Math.round((i / imageFiles.length) * 75));
                try {
                    const url = await processMediaFile(imageFiles[i], 'images', (p) => {
                        updateProgressRing(5 + Math.round((i / imageFiles.length) * 75) + Math.round(p * 5));
                    });
                    if (url) mediaUrls.push(url);
                } catch(imgErr) { console.warn('Image error:', imgErr); showToast(`Skipped: ${imageFiles[i].name}`); }
            }
            if (mediaUrls.length && !uploadCanceled) {
                updateUploadUI('Sending images...', 1, totalGroups, 88);
                await insertMessage(buildFilePayload(
                    mediaUrls.length === 1 ? imageFiles[0].name : `${mediaUrls.length} images`,
                    mediaUrls, 'image'
                ));
                updateProgressRing(100);
                sentCount++;
            }
        }

        // ── Videos ──
        for (let vi = 0; vi < videoFiles.length; vi++) {
            const f = videoFiles[vi];
            if (uploadCanceled) break;
            sentCount++;
            updateUploadUI(f.name, sentCount, totalGroups, 5);
            try {
                const url = await processMediaFile(f, 'videos', (p) => {
                    updateProgressRing(5 + Math.round(p * 88));
                    updateUploadUI(f.name, sentCount, totalGroups, 5 + Math.round(p * 88));
                });
                if (!url || uploadCanceled) { sentCount--; continue; }
                updateUploadUI('Sending video...', sentCount, totalGroups, 95);
                await insertMessage(buildFilePayload(f.name, [url], 'video'));
                updateProgressRing(100);
            } catch(vErr) {
                sentCount--;
                console.error('Video send error:', vErr);
                showToast(vErr.message || `Failed to send ${f.name}`);
            }
        }

        // ── Documents / PDFs ──
        for (let di = 0; di < docFiles.length; di++) {
            const f = docFiles[di];
            if (uploadCanceled) break;
            sentCount++;
            updateUploadUI(f.name, sentCount, totalGroups, 5);
            try {
                const url = await processMediaFile(f, 'documents', (p) => {
                    updateProgressRing(5 + Math.round(p * 88));
                    updateUploadUI(f.name, sentCount, totalGroups, 5 + Math.round(p * 88));
                });
                if (!url || uploadCanceled) { sentCount--; continue; }
                updateUploadUI('Sending document...', sentCount, totalGroups, 95);
                // Store file size encoded in the text field as "filename|size" so no extra DB column needed
                const sizeBytes = f.size;
                const payload = buildFilePayload(f.name, [url], 'document');
                payload.metadata = { file_size: sizeBytes }; // safe: ignored if column missing
                await insertMessage(payload);
                updateProgressRing(100);
            } catch(dErr) {
                sentCount--;
                console.error('Doc send error:', dErr);
                showToast(dErr.message || `Failed to send ${f.name}`);
            }
        }

    } catch (e) {
        if (e.message !== 'canceled') { console.error('sendFiles:', e); showToast('Send failed: ' + (e.message || '')); }
    }

    hideUploadOverlay();
    if (!uploadCanceled && sentCount > 0) showToast(`✓ Sent ${sentCount} file(s)!`, 'success');
    uploadCanceled = false;
    uploadInProgress = false;
}

// Smart media processor: uses Storage if available, base64 otherwise
async function processMediaFile(file, folder, onProgress) {
    const isVideo = file.type.startsWith('video/');
    const isImage = file.type.startsWith('image/');
    const isPDF   = file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf');

    // Try Supabase Storage first if available
    if (storageAvailable === true) {
        try {
            return await uploadToStorage(file, folder, onProgress);
        } catch(e) {
            console.warn('Storage upload failed, falling back to base64:', e.message);
            storageAvailable = false; // Mark as unavailable for future calls
        }
    }

    // ── BASE64 FALLBACK ──
    if (isImage) {
        // Images: always compress to base64 (guaranteed to work)
        return await compressImageToDataUrl(file, onProgress);
    }

    if (isPDF) {
        // PDFs: base64 if under 8MB (Supabase row limit ~10MB for most plans)
        const maxPdf = 8 * 1024 * 1024;
        if (file.size > maxPdf) {
            throw new Error(`PDF too large for base64 (${(file.size/1024/1024).toFixed(1)}MB). Please create "chat-assets" Storage bucket in Supabase.`);
        }
        return await fileToBase64(file, onProgress);
    }

    if (isVideo) {
        // Videos: base64 if under 15MB (otherwise too large for DB)
        const maxVideo = 15 * 1024 * 1024;
        if (file.size > maxVideo) {
            throw new Error(`Video too large for base64 mode (${(file.size/1024/1024).toFixed(1)}MB > 15MB). Please create "chat-assets" Storage bucket in Supabase to send large videos.`);
        }
        showToast('No storage bucket — compressing video...', 'success');
        return await fileToBase64(file, onProgress);
    }

    // Other docs: base64 if under 5MB
    const maxDoc = 5 * 1024 * 1024;
    if (file.size > maxDoc) {
        throw new Error(`File too large for base64 mode. Create "chat-assets" Storage bucket in Supabase.`);
    }
    return await fileToBase64(file, onProgress);
}

// Upload to Supabase Storage bucket, return public URL
async function uploadToStorage(file, folder, onProgress) {
    const ext = (file.name.split('.').pop() || 'bin').toLowerCase();
    const safeName = `${Date.now()}_${Math.random().toString(36).slice(2)}.${ext}`;
    const path = `${folder}/${currentUser.id}/${safeName}`;
    onProgress && onProgress(0.05);
    const { error } = await sb.storage.from('chat-assets').upload(path, file, {
        cacheControl: '3600',
        upsert: false,
        contentType: file.type || 'application/octet-stream'
    });
    if (error) throw error;
    onProgress && onProgress(0.95);
    const { data } = sb.storage.from('chat-assets').getPublicUrl(path);
    onProgress && onProgress(1);
    return data.publicUrl;
}

// Read file as base64 data URL with progress (0-1)
function fileToBase64(file, onProgress) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onprogress = (e) => { if (e.lengthComputable && onProgress) onProgress(e.loaded / e.total * 0.9); };
        reader.onload = (e) => { onProgress && onProgress(1); resolve(e.target.result); };
        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsDataURL(file);
    });
}

// Compress image to JPEG data URL — guaranteed to work without any storage bucket
async function compressImageToDataUrl(file, onProgress) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onerror = reject;
        reader.onprogress = (e) => { if (e.lengthComputable && onProgress) onProgress(e.loaded / e.total * 0.4); };
        reader.onload = e => {
            onProgress && onProgress(0.5);
            const img = new Image();
            img.onerror = reject;
            img.onload = () => {
                const MAX = 900;
                let w = img.width, h = img.height;
                if (w > MAX || h > MAX) {
                    if (w > h) { h = Math.round(h * MAX / w); w = MAX; }
                    else { w = Math.round(w * MAX / h); h = MAX; }
                }
                if (w < 1) w = 1; if (h < 1) h = 1;
                const canvas = document.createElement('canvas');
                canvas.width = w; canvas.height = h;
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, w, h);
                ctx.drawImage(img, 0, 0, w, h);
                onProgress && onProgress(0.85);
                const tryEncode = (quality) => {
                    const dataUrl = canvas.toDataURL('image/jpeg', quality);
                    const approxBytes = (dataUrl.length - 22) * 0.75;
                    if (approxBytes > 800000 && quality > 0.3) return tryEncode(quality - 0.15);
                    return dataUrl;
                };
                onProgress && onProgress(1);
                resolve(tryEncode(0.78));
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    });
}

// uploadFileToStorage removed in V78 — pure base64 pipeline used instead

function buildFilePayload(name, paths, type) {
    return {
        sender_id: currentUser.id,
        username: getMyDisplayName(),
        text: name,
        attachments: paths,
        type,
        read_by: [currentUser.id],
        created_at: new Date().toISOString(),
        ...(isPersonalChat ? { chat_id: currentRoom } : { room: currentRoom })
    };
}

// Known safe columns for messages table — strip anything unknown to prevent schema errors
const MSG_SAFE_COLS = new Set(['sender_id','username','text','attachments','type','read_by','created_at','room','chat_id','reply_to','reactions','deleted_by','pinned']);

async function insertMessage(payload) {
    try {
        const table = isPersonalChat ? 'personal_chat_messages' : 'messages';
        // Strip any columns that don't exist in the schema (e.g. file_size, metadata)
        const safe = {};
        Object.keys(payload).forEach(k => { if (MSG_SAFE_COLS.has(k)) safe[k] = payload[k]; });
        const { data, error } = await sb.from(table).insert([safe]).select().single();
        if (error) throw error;
        if (!messageCache.has(data.id)) {
            messageCache.set(data.id, data);
            document.getElementById('chat-feed').appendChild(buildMsgNode(data));
            scrollBottom();
            attachMsgListeners();
        }
    } catch (e) {
        console.error('insertMessage error:', e);
        throw e;
    }
}

function mediaUrl(path) {
    if (!path) return '';
    // data: URLs and http URLs are already complete
    if (path.startsWith('data:') || path.startsWith('http')) return path;
    // Legacy storage paths
    return `${SB_URL}/storage/v1/object/public/chat-assets/${path}`;
}

// ===================== COMPRESS =====================
async function compressImage(file) {
    if (!file.type.startsWith('image/')) return file;
    return new Promise(resolve => {
        const reader = new FileReader();
        reader.onload = e => {
            const img = new Image();
            img.onload = () => {
                const MAX = 1280;
                let w = img.width, h = img.height;
                if (w > MAX || h > MAX) {
                    if (w > h) { h = Math.round(h * MAX / w); w = MAX; }
                    else { w = Math.round(w * MAX / h); h = MAX; }
                }
                const canvas = document.createElement('canvas');
                canvas.width = w; canvas.height = h;
                canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                canvas.toBlob(blob => {
                    if (!blob) { resolve(file); return; }
                    const name = file.name.replace(/\.[^/.]+$/, '') + '.jpg';
                    const cf = new File([blob], name, { type: 'image/jpeg', lastModified: Date.now() });
                    resolve(cf.size < file.size ? cf : file);
                }, 'image/jpeg', 0.82);
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    });
}

// ===================== UPLOAD UI =====================
function showUploadOverlay(show, filename) {
    const el = document.getElementById('upload-overlay');
    el.classList.toggle('hide', !show);
    if (show) { updateProgressRing(0); document.getElementById('upload-file-lbl').innerText = filename || ''; uploadCanceled = false; }
}
function hideUploadOverlay() { document.getElementById('upload-overlay').classList.add('hide'); }
function updateUploadUI(name, current, total, pct) {
    const label = total > 1 ? `${current}/${total} — ${name}` : name;
    document.getElementById('upload-file-lbl').innerText = label;
    updateProgressRing(pct);
}
function updateProgressRing(pct) {
    const pct2 = Math.max(0, Math.min(100, pct));
    document.getElementById('upload-pct').innerText = Math.round(pct2) + '%';
    const circle = document.querySelector('.progress-ring__circle');
    if (circle) circle.style.strokeDashoffset = 326 - (pct2 / 100) * 326;
}

// ===================== MEDIA PREVIEW =====================
function renderMediaPreview() {
    const strip = document.getElementById('media-preview-strip');
    strip.innerHTML = '';
    strip.classList.remove('hide');
    selectedFiles.forEach((file, i) => {
        const thumb = document.createElement('div');
        if (file.type.startsWith('image/')) {
            thumb.className = 'media-thumb';
            const url = URL.createObjectURL(file);
            thumb.innerHTML = `<img src="${url}" alt="">
                <button class="remove-mb touch-fix" data-i="${i}"><i class="fa-solid fa-xmark"></i></button>`;
        } else if (file.type.startsWith('video/')) {
            thumb.className = 'media-thumb';
            thumb.innerHTML = `<video src="${URL.createObjectURL(file)}" muted></video>
                <div class="play-over"><i class="fa-solid fa-play"></i></div>
                <button class="remove-mb touch-fix" data-i="${i}"><i class="fa-solid fa-xmark"></i></button>`;
        } else {
            // Document — WhatsApp-style card
            thumb.className = 'doc-preview-card';
            const ext = file.name.split('.').pop().toUpperCase();
            const sizeFmt = file.size > 1048576 ? (file.size/1048576).toFixed(1)+'MB' : (file.size/1024).toFixed(0)+'KB';
            const iconMap = { PDF:'fa-file-pdf', DOC:'fa-file-word', DOCX:'fa-file-word', XLS:'fa-file-excel', XLSX:'fa-file-excel', PPT:'fa-file-powerpoint', PPTX:'fa-file-powerpoint', ZIP:'fa-file-zipper', TXT:'fa-file-lines', CSV:'fa-file-csv' };
            const icon = iconMap[ext] || 'fa-file';
            const colorMap = { PDF:'#FF3B30', DOC:'#007AFF', DOCX:'#007AFF', XLS:'#34C759', XLSX:'#34C759', PPT:'#FF9500', PPTX:'#FF9500', ZIP:'#8E8E93', TXT:'#636366', CSV:'#34C759' };
            const color = colorMap[ext] || '#8E8E93';
            thumb.innerHTML = `
                <div class="doc-prev-icon" style="background:${color}20;"><i class="fa-solid ${icon}" style="color:${color};font-size:22px;"></i></div>
                <div class="doc-prev-info"><div class="doc-prev-name">${esc(trunc(file.name,22))}</div><div class="doc-prev-meta">${ext} · ${sizeFmt}</div></div>
                <button class="remove-mb-doc touch-fix" data-i="${i}"><i class="fa-solid fa-xmark"></i></button>`;
        }
        strip.appendChild(thumb);
    });
    strip.querySelectorAll('.remove-mb, .remove-mb-doc').forEach(b => b.addEventListener('click', e => { e.stopPropagation(); removeMedia(parseInt(b.dataset.i)); }));
    updateSendBadge();
}
function clearMediaPreview() {
    selectedFiles = [];
    const strip = document.getElementById('media-preview-strip');
    strip.innerHTML = '';
    strip.classList.add('hide');
    updateSendBadge();
}
function removeMedia(i) {
    selectedFiles.splice(i, 1);
    if (!selectedFiles.length) clearMediaPreview();
    else renderMediaPreview();
}
function updateSendBadge() {
    const btn = document.getElementById('send-btn');
    let badge = btn.querySelector('.file-badge');
    if (selectedFiles.length > 0) {
        if (!badge) { badge = document.createElement('span'); badge.className = 'file-badge'; btn.appendChild(badge); }
        badge.textContent = selectedFiles.length;
        badge.style.display = 'flex';
    } else if (badge) { badge.style.display = 'none'; }
}

// ===================== FILE INPUT HANDLERS =====================
function handleGallery(e) {
    const files = Array.from(e.target.files || []);
    e.target.value = '';
    if (!files.length) return;
    // Replace selection (not accumulate) for gallery
    selectedFiles = files;
    renderMediaPreview();
    // Open editor for single image
    if (files.length === 1 && files[0].type.startsWith('image/')) {
        showImageEditor(files[0], 0);
    }
}

function handleCamera(e) {
    const files = Array.from(e.target.files || []);
    e.target.value = '';
    if (!files.length) return;
    selectedFiles.push(...files);
    renderMediaPreview();
    if (files.length === 1) showImageEditor(files[files.length - 1], selectedFiles.length - 1);
}

function handleVideo(e) {
    const file = e.target.files?.[0];
    e.target.value = '';
    if (!file) return;
    showVideoPreview(file);
}

function handleDocument(e) {
    const files = Array.from(e.target.files || []);
    e.target.value = '';
    if (!files.length) return;
    selectedFiles = [...selectedFiles, ...files];
    renderMediaPreview();
    // Don't auto-send — user taps send button (WhatsApp style)
}

// ===================== IMAGE EDITOR =====================
function showImageEditor(file, index) {
    editingFileIndex = index;
    const reader = new FileReader();
    reader.onload = e => {
        const modal = document.getElementById('modal-editor');
        const img = document.getElementById('img-to-edit');
        img.src = e.target.result;
        img.style.filter = 'none';
        currentFilter = 'normal';
        document.querySelectorAll('.filter-item').forEach(el => el.classList.remove('active'));
        document.querySelector('.filter-item[data-filter="normal"]').classList.add('active');
        modal.classList.remove('hide');
        if (cropper) { cropper.destroy(); cropper = null; }
        setTimeout(() => {
            cropper = new Cropper(img, {
                viewMode: 1, dragMode: 'move', autoCropArea: 1,
                restore: false, guides: true, center: true,
                highlight: true, cropBoxMovable: true, cropBoxResizable: true,
                background: false, toggleDragModeOnDblclick: false,
                checkOrientation: false, responsive: true, autoCrop: true
            });
        }, 120);
    };
    reader.readAsDataURL(file);
}
function applyFilter(name, el) {
    currentFilter = name;
    const img = document.getElementById('img-to-edit');
    const filters = { normal: 'none', grayscale: 'grayscale(100%)', sepia: 'sepia(100%)', brightness: 'brightness(1.35)', contrast: 'contrast(1.5)', saturate: 'saturate(2)' };
    img.style.filter = filters[name] || 'none';
    document.querySelectorAll('.filter-item').forEach(i => i.classList.remove('active'));
    if (el) el.classList.add('active');
}
async function finishEditing() {
    if (!cropper) return;
    showToast('Processing...', 'success');
    cropper.getCroppedCanvas().toBlob(blob => {
        const f = new File([blob], 'edited.jpg', { type: 'image/jpeg' });
        if (editingFileIndex !== null && selectedFiles[editingFileIndex]) {
            selectedFiles[editingFileIndex] = f;
        } else {
            selectedFiles.push(f);
        }
        renderMediaPreview();
        cancelEditor();
        showToast('Edited!', 'success');
    }, 'image/jpeg', 0.88);
}
function cancelEditor() {
    document.getElementById('modal-editor').classList.add('hide');
    if (cropper) { cropper.destroy(); cropper = null; }
    editingFileIndex = null;
}

// ===================== VIDEO PREVIEW =====================
function showVideoPreview(file) {
    videoFile = file;
    const url = URL.createObjectURL(file);
    document.getElementById('video-preview').src = url;
    document.getElementById('modal-video').classList.remove('hide');
}
function cancelVideoPreview() {
    const v = document.getElementById('video-preview');
    URL.revokeObjectURL(v.src);
    v.src = '';
    document.getElementById('modal-video').classList.add('hide');
    videoFile = null;
}
async function sendVideoFile() {
    if (!videoFile) return;
    const file = videoFile;
    cancelVideoPreview();
    selectedFiles = [file];
    renderMediaPreview();
    await sendFiles();
}

// ===================== MEDIA PICKER =====================
function openMediaPicker() { document.getElementById('sheet-media').classList.add('active'); }
function closeMediaSheet() { document.getElementById('sheet-media').classList.remove('active'); }
function triggerFile(type) {
    closeMediaSheet();
    const delay = 250;
    switch (type) {
        case 'gallery': setTimeout(() => document.getElementById('inp-gallery').click(), delay); break;
        case 'camera': setTimeout(() => document.getElementById('inp-camera').click(), delay); break;
        case 'video': setTimeout(() => document.getElementById('inp-video').click(), delay); break;
        case 'video-record': setTimeout(() => document.getElementById('inp-video-record').click(), delay); break;
        case 'document': setTimeout(() => document.getElementById('inp-document').click(), delay); break;
    }
}

// ===================== SELECT MODE =====================
function toggleSelectMode() {
    isSelectMode = !isSelectMode;
    const feed = document.getElementById('chat-feed');
    const toolbar = document.getElementById('sel-toolbar');
    const btn = document.getElementById('sel-toggle-btn');
    if (isSelectMode) {
        feed.querySelectorAll('.msg-row').forEach(r => r.classList.add('select-mode'));
        btn.innerHTML = '<i class="fa-solid fa-xmark"></i>';
        toolbar.classList.add('active');
    } else {
        feed.querySelectorAll('.msg-row').forEach(r => r.classList.remove('select-mode'));
        btn.innerHTML = '<i class="fa-solid fa-check-double"></i>';
        toolbar.classList.remove('active');
        clearSel();
    }
}
function exitSelectMode() {
    isSelectMode = false;
    document.querySelectorAll('.msg-row').forEach(r => r.classList.remove('select-mode'));
    document.getElementById('sel-toggle-btn').innerHTML = '<i class="fa-solid fa-check-double"></i>';
    document.getElementById('sel-toolbar').classList.remove('active');
    clearSel();
}
function toggleSel(msgId, cb) {
    if (selectedMessages.has(msgId)) { selectedMessages.delete(msgId); cb?.classList.remove('checked'); }
    else { selectedMessages.add(msgId); cb?.classList.add('checked'); }
    document.getElementById('sel-count').innerText = selectedMessages.size + ' selected';
}
function clearSel() {
    selectedMessages.clear();
    document.querySelectorAll('.msg-checkbox').forEach(cb => cb.classList.remove('checked'));
    document.getElementById('sel-count').innerText = '0 selected';
}
function downloadSelected() {
    let count = 0;
    selectedMessages.forEach(id => {
        const msg = messageCache.get(id);
        if (msg?.attachments?.length) {
            msg.attachments.forEach((att, i) => setTimeout(() => dlFile(mediaUrl(att), msg.text || `file_${i}`), count++ * 300));
        }
    });
    if (!count) showToast('No media in selection');
    else showToast(`Downloading ${count} files...`, 'success');
    exitSelectMode();
}
async function deleteSelected() {
    if (!selectedMessages.size) return;
    if (!confirm(`Delete ${selectedMessages.size} messages for you?`)) return;
    try {
        for (const id of selectedMessages) {
            const msg = messageCache.get(id);
            if (!msg) continue;
            const deletedBy = [...(msg.deleted_by || []), currentUser.id];
            const table = isPersonalChat ? 'personal_chat_messages' : 'messages';
            await sb.from(table).update({ deleted_by: deletedBy }).eq('id', id);
            document.getElementById('msg-' + id)?.remove();
            messageCache.delete(id);
        }
        showToast('Deleted', 'success');
        clearSel();
        exitSelectMode();
    } catch (e) { showToast('Delete failed'); }
}

// ===================== MESSAGE DELETE =====================
function hideDeleteModal() { document.getElementById('modal-delete').classList.remove('active'); deleteMessageId = null; }
async function deleteForMe() {
    if (!deleteMessageId) return;
    const msg = messageCache.get(deleteMessageId);
    if (!msg) { hideDeleteModal(); return; }
    try {
        const deletedBy = [...(msg.deleted_by || []), currentUser.id];
        const table = isPersonalChat ? 'personal_chat_messages' : 'messages';
        await sb.from(table).update({ deleted_by: deletedBy }).eq('id', deleteMessageId);
        document.getElementById('msg-' + deleteMessageId)?.remove();
        messageCache.delete(deleteMessageId);
        showToast('Deleted for you', 'success');
    } catch (e) { showToast('Failed to delete'); }
    finally { hideDeleteModal(); }
}
async function deleteForAll() {
    if (!deleteMessageId) return;
    const msg = messageCache.get(deleteMessageId);
    if (!msg) { hideDeleteModal(); return; }
    if (msg.sender_id !== currentUser.id) { showToast("Can't delete others' messages"); hideDeleteModal(); return; }
    try {
        const table = isPersonalChat ? 'personal_chat_messages' : 'messages';
        await sb.from(table).delete().eq('id', deleteMessageId);
        document.getElementById('msg-' + deleteMessageId)?.remove();
        messageCache.delete(deleteMessageId);
        showToast('Deleted for everyone', 'success');
    } catch (e) { showToast('Failed to delete'); }
    finally { hideDeleteModal(); }
}

// ===================== PIN =====================
async function pinMessage() {
    if (!selectedMsg) return;
    try {
        await sb.from('pinned_messages').insert([{ room_id: currentRoom, message_id: selectedMsg.id, pinned_by: currentUser.id, pinned_at: new Date().toISOString() }]);
        pinnedMessages.set(selectedMsg.id, selectedMsg);
        document.getElementById('msg-' + selectedMsg.id)?.classList.add('pinned');
        document.getElementById('modal-pin').classList.remove('active');
        showToast('Message pinned', 'success');
    } catch (e) { showToast('Pin failed'); }
}

// ===================== NOTES =====================
function newNote() { editingNoteId = null; document.getElementById('note-modal-title').innerText = 'New Note'; document.getElementById('note-title-in').value = ''; document.getElementById('note-content-in').value = ''; document.getElementById('modal-note').classList.add('active'); }
function editNote(id) {
    const n = notesCache.get(id); if (!n) return;
    editingNoteId = id;
    document.getElementById('note-modal-title').innerText = 'Edit Note';
    document.getElementById('note-title-in').value = n.title;
    document.getElementById('note-content-in').value = n.content;
    document.getElementById('modal-note').classList.add('active');
}
async function saveNote() {
    const title = document.getElementById('note-title-in').value.trim();
    const content = document.getElementById('note-content-in').value.trim();
    if (!title || !content) { showToast('Fill both fields'); return; }
    try {
        const nd = { user_id: currentUser.id, title, content, updated_at: new Date().toISOString() };
        if (editingNoteId) await sb.from('secure_notes').update(nd).eq('id', editingNoteId);
        else { nd.created_at = nd.updated_at; await sb.from('secure_notes').insert([nd]); }
        document.getElementById('modal-note').classList.remove('active');
        editingNoteId = null;
        await loadNotes();
        showToast('Note saved', 'success');
    } catch (e) { showToast('Save failed'); }
}
async function deleteNote(id) {
    if (!confirm('Delete note?')) return;
    try { await sb.from('secure_notes').delete().eq('id', id); await loadNotes(); showToast('Deleted', 'success'); }
    catch (e) { showToast('Delete failed'); }
}

// ===================== ROOM CREATION =====================
function showRoomModal() { document.getElementById('room-name-in').value = ''; document.getElementById('room-topic-in').value = ''; document.getElementById('modal-room').classList.add('active'); document.getElementById('room-name-in').focus(); }
async function createRoom() {
    const name = document.getElementById('room-name-in').value.trim();
    const topic = document.getElementById('room-topic-in').value.trim();
    if (!name) { showToast('Enter a room name'); return; }
    const btn = document.getElementById('create-room-btn');
    btn.disabled = true; btn.innerText = 'Creating...';
    try {
        // Check for duplicate group name for this user (prevent accidental double-tap duplicates)
        const { data: existing } = await sb.from('room_members')
            .select('rooms!inner(name)')
            .eq('user_id', currentUser.id)
            .eq('rooms.is_direct', false);
        const duplicate = (existing || []).some(m => m.rooms?.name?.toLowerCase().trim() === name.toLowerCase().trim());
        if (duplicate) { showToast('A group with this name already exists!'); return; }

        const { data: room, error } = await sb.from('rooms').insert([{ name, topic: topic || null, created_by: currentUser.id, is_direct: false, participants: [currentUser.id] }]).select().single();
        if (error) throw error;
        // upsert prevents duplicate member rows if somehow called twice
        await sb.from('room_members').upsert([{ room_id: room.id, user_id: currentUser.id, role: 'admin' }], { onConflict: 'room_id,user_id', ignoreDuplicates: true });
        document.getElementById('modal-room').classList.remove('active');
        await loadGroups();
        openRoom(room.id, room.name);
    } catch (e) { console.error('createRoom:', e); showToast('Failed to create room'); }
    finally { btn.disabled = false; btn.innerText = 'Create'; }
}
async function createSecureChat() {
    try {
        const name = `Secure Chat ${new Date().toLocaleDateString()}`;
        const { data, error } = await sb.from('personal_chats').insert([{ user_id: currentUser.id, name, description: 'Personal encrypted chat', created_at: new Date().toISOString(), updated_at: new Date().toISOString() }]).select().single();
        if (error) {
            if (error.code === 'PGRST205' || error.message?.includes('personal_chats')) {
                showToast('Secure chats need DB setup — see SQL migration in code', 'error');
                return;
            }
            throw error;
        }
        showToast('Secure chat created!', 'success');
        await loadSecureChats();
        openPersonalChat(data.id);
    } catch (e) { showToast('Failed to create secure chat'); }
}
async function sendFriendRequest() {
    const email = document.getElementById('friend-email-in').value.trim();
    if (!email) { showToast("Enter email"); return; }
    if (email === currentUser.email) { showToast("Can't add yourself"); return; }
    try {
        const { data: user } = await sb.from('user_presence').select('user_id').eq('email', email).single();
        if (!user) { showToast('User not found'); return; }
        await sb.from('friend_requests').insert([{ from_user_id: currentUser.id, to_user_id: user.user_id, status: 'pending' }]);
        document.getElementById('modal-friend').classList.remove('active');
        showToast('Request sent!', 'success');
    } catch (e) { showToast('Failed to send'); }
}
async function startChat(userId, userName) {
    try {
        const { data: existing } = await sb.from('rooms').select('*').eq('is_direct', true).contains('participants', [currentUser.id, userId]);
        if (existing?.length) { openRoom(existing[0].id, userName); return; }
        const { data: room, error } = await sb.from('rooms').insert([{ name: userName, is_direct: true, created_by: currentUser.id, participants: [currentUser.id, userId] }]).select().single();
        if (error) throw error;
        await sb.from('room_members').insert([{ room_id: room.id, user_id: currentUser.id }, { room_id: room.id, user_id: userId }]);
        openRoom(room.id, userName);
    } catch (e) { showToast('Failed to start chat'); }
}

// ===================== GROUP DELETE =====================
async function deleteGroup() {
    if (!currentRoom || isPersonalChat) return;
    if (!confirm('Delete group? All messages will be permanently removed.')) return;
    try {
        showToast('Deleting...', 'success');
        await sb.from('messages').delete().eq('room', currentRoom);
        await sb.from('room_members').delete().eq('room_id', currentRoom);
        try { await sb.from('pinned_messages').delete().eq('room_id', currentRoom); } catch(e) {}
        await sb.from('rooms').delete().eq('id', currentRoom);
        document.getElementById('modal-group-info').classList.remove('active');
        showToast('Group deleted ✓', 'success');
        navBack();
        loadGroups();
        loadChats();
    } catch (e) { showToast('Delete failed: ' + (e.message || '')); }
}
async function deleteGroupById(roomId) {
    try {
        showToast('Deleting group...', 'success');
        // Delete in order: messages first, then members, then pinned, then room
        await sb.from('messages').delete().eq('room', roomId).throwOnError();
        await sb.from('room_members').delete().eq('room_id', roomId);
        try { await sb.from('pinned_messages').delete().eq('room_id', roomId); } catch(e) {}
        await sb.from('rooms').delete().eq('id', roomId);
        showToast('Group deleted ✓', 'success');
        await loadGroups();
        await loadChats();
    } catch (e) { 
        console.error('deleteGroupById:', e); 
        showToast('Delete failed: ' + (e.message || 'Unknown error')); 
    }
}

// ===================== GROUP SETTINGS (Rename + DP) =====================
let groupSettingsRoomId = null;
let groupDpCropper = null;
let groupDpAspect = NaN; // NaN = free, 1 = square

function openGroupSettingsFromList(roomId, roomName) {
    groupSettingsRoomId = roomId;
    currentRoom = roomId; // needed for deleteGroup too
    isPersonalChat = false;
    document.getElementById('chat-title').innerText = roomName;
    document.getElementById('modal-group-info').classList.add('active');
}

async function renameGroup() {
    const newName = document.getElementById('group-rename-in').value.trim();
    if (!newName) { showToast('Enter a name'); return; }
    if (!groupSettingsRoomId) return;
    try {
        // Check duplicate
        const { data: existing } = await sb.from('room_members')
            .select('rooms!inner(name, id)')
            .eq('user_id', currentUser.id)
            .eq('rooms.is_direct', false);
        const duplicate = (existing || []).some(m => m.rooms.name.toLowerCase().trim() === newName.toLowerCase().trim() && m.rooms.id !== groupSettingsRoomId);
        if (duplicate) { showToast('A group with this name already exists!'); return; }
        await sb.from('rooms').update({ name: newName }).eq('id', groupSettingsRoomId);
        document.getElementById('modal-group-rename').classList.remove('active');
        showToast('Group renamed!', 'success');
        loadGroups();
    } catch (e) { showToast('Rename failed'); }
}

function openGroupDpPicker() {
    document.getElementById('inp-group-dp').click();
}

function handleGroupDpFile(e) {
    const file = e.target.files?.[0];
    e.target.value = '';
    if (!file) return;
    document.getElementById('modal-group-info').classList.remove('active');
    const reader = new FileReader();
    reader.onload = ev => {
        const modal = document.getElementById('modal-group-dp');
        const img = document.getElementById('group-dp-img');
        img.src = ev.target.result;
        modal.classList.remove('hide');
        if (groupDpCropper) { groupDpCropper.destroy(); groupDpCropper = null; }
        setTimeout(() => {
            groupDpCropper = new Cropper(img, {
                viewMode: 1, dragMode: 'move', autoCropArea: 0.9,
                aspectRatio: NaN, restore: false, guides: true, center: true,
                highlight: true, cropBoxMovable: true, cropBoxResizable: true,
                background: false, toggleDragModeOnDblclick: false,
                checkOrientation: false, responsive: true, autoCrop: true
            });
        }, 120);
    };
    reader.readAsDataURL(file);
}

async function saveGroupDp() {
    if (!groupDpCropper || !groupSettingsRoomId) return;
    showToast('Saving...', 'success');
    groupDpCropper.getCroppedCanvas({ width: 400, height: 400 }).toBlob(async blob => {
        try {
            let dpUrl;
            // Try storage first, always fallback to base64
            try {
                const path = `group_dp/${groupSettingsRoomId}_${Date.now()}.jpg`;
                const { error } = await sb.storage.from('chat-assets').upload(path, blob, { cacheControl: '3600', upsert: true, contentType: 'image/jpeg' });
                if (error) throw error;
                dpUrl = `${SB_URL}/storage/v1/object/public/chat-assets/${path}`;
            } catch(e) {
                // Always fallback to base64 — compress to stay small
                const canvas = document.createElement('canvas');
                canvas.width = 200; canvas.height = 200;
                const imgEl = new Image();
                await new Promise(res => { imgEl.onload = res; imgEl.src = URL.createObjectURL(blob); });
                canvas.getContext('2d').drawImage(imgEl, 0, 0, 200, 200);
                dpUrl = canvas.toDataURL('image/jpeg', 0.75);
            }
            await sb.from('rooms').update({ dp_url: dpUrl }).eq('id', groupSettingsRoomId);
            showToast('Group photo updated!', 'success');
            cancelGroupDp();
            loadGroups();
        } catch (e) { showToast('Failed to save photo'); cancelGroupDp(); }
    }, 'image/jpeg', 0.88);
}

function cancelGroupDp() {
    document.getElementById('modal-group-dp').classList.add('hide');
    if (groupDpCropper) { groupDpCropper.destroy(); groupDpCropper = null; }
}

// ===================== TYPING INDICATOR =====================
let typingTimeout = null;
let typingChannel = null;

function setupTypingChannel(roomId) {
    if (typingChannel) { try { sb.removeChannel(typingChannel); } catch(e) {} }
    typingChannel = sb.channel(`typing_${roomId}`)
        .on('broadcast', { event: 'typing' }, ({ payload }) => {
            if (payload.user_id !== currentUser?.id) {
                showTypingIndicator(payload.name);
            }
        })
        .subscribe();
}

function broadcastTyping() {
    if (!typingChannel || !currentUser) return;
    typingChannel.send({
        type: 'broadcast',
        event: 'typing',
        payload: { user_id: currentUser.id, name: getMyDisplayName() }
    });
}

let typingHideTimer = null;
function showTypingIndicator(name) {
    const el = document.getElementById('typing-indicator');
    const nameEl = document.getElementById('typing-name');
    if (el && nameEl) {
        nameEl.innerText = `${name} is typing...`;
        el.classList.add('show');
        if (typingHideTimer) clearTimeout(typingHideTimer);
        typingHideTimer = setTimeout(() => el.classList.remove('show'), 3000);
    }
}

// ===================== REACTIONS =====================
let reactionPickerMsgId = null;

function openReactionPicker(e, msgId) {
    e.stopPropagation();
    reactionPickerMsgId = msgId;
    const picker = document.getElementById('reaction-picker');
    const vp = document.getElementById('app-viewport').getBoundingClientRect();
    let x = (e.clientX || e.touches?.[0]?.clientX || 100) - vp.left;
    let y = (e.clientY || e.touches?.[0]?.clientY || 200) - vp.top;
    if (x + 240 > vp.width) x = vp.width - 245;
    if (y + 50 > vp.height) y = y - 55;
    picker.style.left = x + 'px';
    picker.style.top = y + 'px';
    picker.style.display = 'flex';
    setTimeout(() => document.addEventListener('click', closeReactionPicker, { once: true }), 10);
}

function closeReactionPicker() {
    document.getElementById('reaction-picker').style.display = 'none';
    reactionPickerMsgId = null;
}

async function sendReaction(emoji) {
    if (!reactionPickerMsgId || !currentUser) return;
    closeReactionPicker();
    try {
        const table = isPersonalChat ? 'personal_chat_messages' : 'messages';
        const msg = messageCache.get(reactionPickerMsgId);
        if (!msg) return;
        const reactions = JSON.parse(JSON.stringify(msg.reactions || {})); // deep copy
        if (!reactions[emoji]) reactions[emoji] = [];
        const userIdx = reactions[emoji].indexOf(currentUser.id);
        if (userIdx > -1) reactions[emoji].splice(userIdx, 1);
        else reactions[emoji].push(currentUser.id);
        if (reactions[emoji].length === 0) delete reactions[emoji];
        await sb.from(table).update({ reactions }).eq('id', reactionPickerMsgId);
        // Update locally
        msg.reactions = reactions;
        const node = document.getElementById('msg-' + reactionPickerMsgId);
        if (node) {
            // Remove existing reactions div (it's a direct child of msg-row, outside bubble)
            const existing = node.querySelector('.msg-reactions');
            if (existing) existing.remove();
            const reactEl = buildReactionsEl(reactions, reactionPickerMsgId);
            if (reactEl) node.appendChild(reactEl); // append to msg-row, not bubble
        }
    } catch(e) { console.warn('Reaction error:', e); }
}

function buildReactionsEl(reactions, msgId) {
    if (!reactions || !Object.keys(reactions).length) return null;
    const div = document.createElement('div');
    div.className = 'msg-reactions';
    Object.entries(reactions).forEach(([emoji, users]) => {
        if (!Array.isArray(users) || !users.length) return;
        const pill = document.createElement('div');
        pill.className = 'reaction-pill' + (users.includes(currentUser?.id) ? ' reacted-me' : '');
        pill.innerHTML = `<span style="font-size:14px;">${emoji}</span><span class="r-count">${users.length}</span>`;
        pill.onclick = (e) => { e.stopPropagation(); reactionPickerMsgId = msgId; sendReaction(emoji); };
        div.appendChild(pill);
    });
    return div.children.length ? div : null;
}

// ===================== REALTIME =====================
function setupGlobalRealtime() {
    sb.channel('global_presence')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'user_presence' }, payload => {
            if (payload.new?.user_id !== currentUser.id) {
                globalUsersCache.set(payload.new.user_id, payload.new);
                updateOnlineCount();
            }
        }).subscribe();
}

function setupRoomSub(roomId, isPersonal) {
    // Remove all old subscriptions
    activeSubscriptions.forEach(ch => { try { sb.removeChannel(ch); } catch (e) {} });
    activeSubscriptions = [];

    const tableName = isPersonal ? 'personal_chat_messages' : 'messages';
    const roomField = isPersonal ? 'chat_id' : 'room';
    const channelName = `room_${roomId}_${Date.now()}`;

    const ch = sb.channel(channelName)
        .on('postgres_changes', {
            event: 'INSERT',
            schema: 'public',
            table: tableName,
            filter: `${roomField}=eq.${roomId}`
        }, payload => {
            const msg = payload.new;
            if (messageCache.has(msg.id)) return;
            if ((msg.deleted_by || []).includes(currentUser.id)) return;
            messageCache.set(msg.id, msg);
            const node = buildMsgNode(msg);
            document.getElementById('chat-feed').appendChild(node);
            attachMsgListeners();
            const feed = document.getElementById('chat-feed');
            if (feed.scrollHeight - feed.clientHeight - feed.scrollTop < 140) scrollBottom();
            if (msg.sender_id !== currentUser.id) {
                // Get sender info from cache
                const senderPresence = globalUsersCache.get(msg.sender_id);
                const senderName = msg.username || senderPresence?.display_name || 'User';
                const senderDp = senderPresence?.dp_url || null;
                showNotif(senderName, msg.text || '📎 Media', { dpUrl: senderDp });
            }
        })
        .on('postgres_changes', {
            event: 'DELETE',
            schema: 'public',
            table: tableName,
            filter: `${roomField}=eq.${roomId}`
        }, payload => {
            const id = payload.old?.id;
            if (!id) return;
            document.getElementById('msg-' + id)?.remove();
            messageCache.delete(id);
            selectedMessages.delete(id);
        })
        .on('postgres_changes', {
            event: 'UPDATE',
            schema: 'public',
            table: tableName,
            filter: `${roomField}=eq.${roomId}`
        }, payload => {
            const msg = payload.new;
            if ((msg.deleted_by || []).includes(currentUser.id)) {
                document.getElementById('msg-' + msg.id)?.remove();
                messageCache.delete(msg.id);
            }
        })
        .subscribe();

    activeSubscriptions.push(ch);
}

// ===================== LIGHTBOX =====================
function openLightbox(url, type, title) {
    lbImages = [{ url, type }];
    lbIndex = 0;
    document.getElementById('lb-title').innerText = title || 'Media';
    renderLbMedia(url, type);
    document.getElementById('lightbox')._url = url;
    document.getElementById('lightbox')._title = title;
    document.getElementById('lb-prev').style.display = 'none';
    document.getElementById('lb-next').style.display = 'none';
    document.getElementById('lightbox').classList.add('active');
}
function openLightboxImages(urls, title, startIndex) {
    lbImages = urls.map(u => ({ url: u, type: 'image' }));
    lbIndex = startIndex;
    document.getElementById('lb-title').innerText = title || 'Images';
    renderLbMedia(urls[startIndex], 'image');
    document.getElementById('lightbox')._url = urls[startIndex];
    document.getElementById('lightbox')._title = title;
    document.getElementById('lb-prev').style.display = urls.length > 1 ? 'flex' : 'none';
    document.getElementById('lb-next').style.display = urls.length > 1 ? 'flex' : 'none';
    document.getElementById('lightbox').classList.add('active');
}
function renderLbMedia(url, type) {
    const img = document.getElementById('lb-img');
    const vid = document.getElementById('lb-video');
    if (type === 'video') {
        img.style.display = 'none'; vid.style.display = 'block'; vid.src = url;
    } else {
        vid.style.display = 'none'; img.style.display = 'block'; img.src = url;
    }
    document.getElementById('lightbox')._url = url;
}
function prevLbImg() {
    if (!lbImages.length) return;
    lbIndex = (lbIndex - 1 + lbImages.length) % lbImages.length;
    const { url, type } = lbImages[lbIndex];
    renderLbMedia(url, type);
}
function nextLbImg() {
    if (!lbImages.length) return;
    lbIndex = (lbIndex + 1) % lbImages.length;
    const { url, type } = lbImages[lbIndex];
    renderLbMedia(url, type);
}
function closeLightbox() {
    document.getElementById('lightbox').classList.remove('active');
    document.getElementById('lb-video').pause?.();
    document.getElementById('lb-video').src = '';
}
function downloadLb() {
    const url = document.getElementById('lightbox')._url;
    const title = document.getElementById('lightbox')._title || 'media';
    if (url) dlFile(url, title);
}

// ===================== UTILS =====================
function dlFile(url, name) {
    const a = document.createElement('a');
    a.href = url; a.download = name; a.target = '_blank';
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
    showToast('Download started', 'success');
}
function navigate(screen) {
    if (screen === 'chat') {
        document.getElementById('screen-dash').classList.remove('active');
        document.getElementById('screen-chat').classList.add('active');
    }
}
function navBack() {
    document.getElementById('screen-chat').classList.remove('active');
    document.getElementById('screen-dash').classList.add('active');
    currentRoom = null;
    isPersonalChat = false;
    replyToMsg = null;
    clearMediaPreview();
    exitSelectMode();
    activeSubscriptions.forEach(ch => { try { sb.removeChannel(ch); } catch (e) {} });
    activeSubscriptions = [];
    loadChats();
}
function toggleFav() {
    if (!currentRoom) return;
    const idx = favorites.indexOf(currentRoom);
    if (idx === -1) { favorites.push(currentRoom); document.getElementById('fav-btn').innerHTML = '<i class="fa-solid fa-star"></i>'; showToast('Favourited', 'success'); }
    else { favorites.splice(idx, 1); document.getElementById('fav-btn').innerHTML = '<i class="fa-regular fa-star"></i>'; showToast('Removed from favourites', 'success'); }
    localStorage.setItem('orbit_favorites', JSON.stringify(favorites));
}
function switchTab(tab) {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelector(`.tab-btn[data-tab="${tab}"]`).classList.add('active');
    document.querySelectorAll('[id^="tab-"]').forEach(el => el.classList.add('hide'));
    document.getElementById('tab-' + tab)?.classList.remove('hide');
    // Only reload if list is empty or shows loader (don't reload every switch)
    const listMap = { chats: 'chats-list', secure: 'secure-list', friends: 'friends-list', groups: 'groups-list', global: 'global-list', notes: 'notes-list' };
    const listId = listMap[tab];
    const listEl = listId ? document.getElementById(listId) : null;
    const needsLoad = !listEl || !listEl.children.length || listEl.innerHTML.includes('loader') || listEl.innerHTML.includes('Could not');
    if (needsLoad) {
        if (tab === 'chats') loadChats();
        else if (tab === 'secure') loadSecureChats();
        else if (tab === 'friends') loadFriends();
        else if (tab === 'groups') loadGroups();
        else if (tab === 'global') loadGlobalUsers();
        else if (tab === 'notes') loadNotes();
    }
}
function updateOnlineCount(count) {
    if (count === undefined) {
        count = Array.from(globalUsersCache.values()).filter(u => u.is_online && (Date.now() - new Date(u.last_seen).getTime() < 65000)).length;
    }
    document.getElementById('online-count').innerText = count;
    document.getElementById('global-count').innerText = count;
}
function autoResize() { this.style.height = 'auto'; this.style.height = this.scrollHeight + 'px'; }
function handleKeyDown(e) { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } }
function scrollBottom() { const f = document.getElementById('chat-feed'); setTimeout(() => { f.scrollTop = f.scrollHeight; }, 40); }
function showToast(msg, type = 'error') {
    const el = document.getElementById('toast');
    el.innerText = msg;
    el.className = 'toast' + (type === 'success' ? ' success' : '');
    el.classList.add('show');
    if (toastTimer) clearTimeout(toastTimer);
    toastTimer = setTimeout(() => el.classList.remove('show'), 2800);
}
function debounce(fn, ms) {
    let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), ms); };
}
function makeDateBadge(dateStr) {
    const div = document.createElement('div');
    div.className = 'date-badge';
    div.innerHTML = '<span>' + getFriendlyDate(dateStr) + '</span>';
    return div;
}
function getFriendlyDate(s) {
    const d = new Date(s), t = new Date();
    if (d.toDateString() === t.toDateString()) return 'Today';
    const y = new Date(t); y.setDate(y.getDate() - 1);
    if (d.toDateString() === y.toDateString()) return 'Yesterday';
    return d.toLocaleDateString();
}
function fmtTime(s) { return new Date(s).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }); }
function timeAgo(ts) {
    const d = Date.now() - new Date(ts).getTime();
    if (d < 60000) return 'just now';
    if (d < 3600000) return Math.floor(d / 60000) + 'm ago';
    if (d < 86400000) return Math.floor(d / 3600000) + 'h ago';
    return Math.floor(d / 86400000) + 'd ago';
}
function esc(s) {
    if (s == null) return '';
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}
function trunc(s, n) { return s && s.length > n ? s.substring(0, n) + '...' : (s || ''); }
function emptyState(icon, title, sub) {
    return `<div class="empty-state"><i class="fa-solid ${icon}"></i><div>${title}</div>${sub ? `<div style="font-size:11px;margin-top:6px;">${sub}</div>` : ''}</div>`;
}
function initTheme() {
    if (localStorage.getItem('orbit_theme') === 'light') {
        document.body.classList.add('light-mode');
        document.getElementById('theme-toggle').innerHTML = '<i class="fa-solid fa-sun"></i>';
    }
}
function toggleTheme() {
    const isLight = document.body.classList.toggle('light-mode');
    document.getElementById('theme-toggle').innerHTML = isLight ? '<i class="fa-solid fa-sun"></i>' : '<i class="fa-solid fa-moon"></i>';
    localStorage.setItem('orbit_theme', isLight ? 'light' : 'dark');
}

// ===================== INFINITE SCROLL =====================
async function onFeedScroll() {
    const feed = document.getElementById('chat-feed');
    const scrollBtn = document.getElementById('scroll-bottom-btn');
    const distFromBottom = feed.scrollHeight - feed.clientHeight - feed.scrollTop;
    // Show/hide scroll-to-bottom button
    if (scrollBtn) scrollBtn.style.display = distFromBottom > 200 ? 'flex' : 'none';
    // Load older messages when scrolled to top
    if (feed.scrollTop < 60 && !loadingMore && hasMoreMessages && oldestMsgDate) {
        loadingMore = true;
        await loadOlderMessages();
        loadingMore = false;
    }
}
async function loadOlderMessages() {
    if (!currentRoom || !oldestMsgDate) return;
    try {
        let query;
        if (isPersonalChat) {
            query = sb.from('personal_chat_messages').select('*').eq('chat_id', currentRoom).lt('created_at', oldestMsgDate).order('created_at', { ascending: false }).limit(25);
        } else {
            query = sb.from('messages').select('*').eq('room', currentRoom).lt('created_at', oldestMsgDate).order('created_at', { ascending: false }).limit(25);
        }
        const { data } = await query;
        if (!data?.length) { hasMoreMessages = false; return; }
        const msgs = data.reverse();
        const feed = document.getElementById('chat-feed');
        const frag = document.createDocumentFragment();
        let lastDate = null;
        msgs.forEach(msg => {
            if ((msg.deleted_by || []).includes(currentUser.id)) return;
            const d = new Date(msg.created_at).toDateString();
            if (d !== lastDate) { frag.appendChild(makeDateBadge(msg.created_at)); lastDate = d; }
            frag.appendChild(buildMsgNode(msg));
            messageCache.set(msg.id, msg);
        });
        const oldScrollHeight = feed.scrollHeight;
        feed.prepend(frag);
        feed.scrollTop = feed.scrollHeight - oldScrollHeight; // keep position
        attachMsgListeners();
        hasMoreMessages = data.length >= 25;
        oldestMsgDate = msgs[0]?.created_at;
    } catch (e) { console.error('loadOlderMessages:', e); }
}

// ===================== PDF VIEWER =====================
let pdfViewerUrl = null;
let pdfViewerName = null;

function openPdfViewer(url, name) {
    pdfViewerUrl = url;
    pdfViewerName = name;
    document.getElementById('pdf-viewer-title').innerText = name;
    document.getElementById('pdf-viewer-modal').style.display = 'flex';
    document.getElementById('pdf-pages-container').innerHTML = '<div style="color:#888;padding:40px;text-align:center;"><div class="loader"></div><div style="margin-top:12px;font-size:13px;">Loading...</div></div>';
    document.getElementById('pdf-dl-btn').onclick = () => dlFile(url, name);

    // Set PDF.js worker
    if (window.pdfjsLib) {
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        renderPdf(url);
    } else {
        // Fallback if PDF.js not loaded
        document.getElementById('pdf-pages-container').innerHTML = `
            <div style="text-align:center;padding:40px;color:#888;">
                <i class="fa-solid fa-file-pdf" style="font-size:56px;color:#FF3B30;margin-bottom:16px;display:block;"></i>
                <div style="font-size:14px;color:#fff;margin-bottom:8px;">${esc(name)}</div>
                <div style="font-size:12px;color:#888;margin-bottom:24px;">PDF preview unavailable</div>
                <button onclick="dlFile('${esc(url)}','${esc(name)}')" style="background:var(--gold);color:#000;border:none;padding:12px 24px;border-radius:12px;font-weight:700;font-size:14px;cursor:pointer;font-family:'Syne',sans-serif;">
                    <i class="fa-solid fa-download"></i> Download PDF
                </button>
            </div>`;
    }
}

async function renderPdf(url) {
    try {
        const container = document.getElementById('pdf-pages-container');
        let pdfData;
        if (url.startsWith('data:')) {
            // Extract base64 data
            const base64 = url.split(',')[1];
            const binary = atob(base64);
            const bytes = new Uint8Array(binary.length);
            for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
            pdfData = { data: bytes };
        } else {
            pdfData = { url };
        }
        const pdf = await pdfjsLib.getDocument(pdfData).promise;
        container.innerHTML = '';
        const totalPages = pdf.numPages;

        // Show page count
        const header = document.createElement('div');
        header.style.cssText = 'color:#888;font-size:11px;padding:4px 0 8px;text-align:center;';
        header.innerText = `${totalPages} page${totalPages > 1 ? 's' : ''}`;
        container.appendChild(header);

        const vp = document.getElementById('app-viewport');
        const maxWidth = (vp?.offsetWidth || 380) - 24;

        for (let pageNum = 1; pageNum <= totalPages; pageNum++) {
            const page = await pdf.getPage(pageNum);
            const viewport = page.getViewport({ scale: 1 });
            const scale = maxWidth / viewport.width;
            const scaledViewport = page.getViewport({ scale });

            const canvas = document.createElement('canvas');
            canvas.width = scaledViewport.width;
            canvas.height = scaledViewport.height;
            canvas.style.cssText = `width:100%;border-radius:8px;display:block;margin-bottom:8px;box-shadow:0 2px 12px rgba(0,0,0,0.5);`;

            const wrapper = document.createElement('div');
            wrapper.style.cssText = 'width:100%;position:relative;';

            const pageLabel = document.createElement('div');
            pageLabel.style.cssText = 'font-size:10px;color:#555;text-align:right;margin-bottom:3px;';
            pageLabel.innerText = `Page ${pageNum}`;
            wrapper.appendChild(pageLabel);
            wrapper.appendChild(canvas);
            container.appendChild(wrapper);

            await page.render({ canvasContext: canvas.getContext('2d'), viewport: scaledViewport }).promise;
        }
    } catch(err) {
        console.error('PDF render error:', err);
        document.getElementById('pdf-pages-container').innerHTML = `
            <div style="text-align:center;padding:40px;color:#888;">
                <i class="fa-solid fa-file-pdf" style="font-size:56px;color:#FF3B30;margin-bottom:16px;display:block;"></i>
                <div style="font-size:12px;margin-bottom:20px;">Could not render PDF</div>
                <button onclick="dlFile('${esc(pdfViewerUrl)}','${esc(pdfViewerName)}')" style="background:var(--gold);color:#000;border:none;padding:12px 24px;border-radius:12px;font-weight:700;cursor:pointer;font-family:'Syne',sans-serif;">
                    <i class="fa-solid fa-download"></i> Download
                </button>
            </div>`;
    }
}

function closePdfViewer() {
    document.getElementById('pdf-viewer-modal').style.display = 'none';
    document.getElementById('pdf-pages-container').innerHTML = '';
    pdfViewerUrl = null; pdfViewerName = null;
}

console.log('%c🚀 Orbit V84 — PDF + Reactions Fixed', 'color:#FFD700;font-weight:bold;font-size:16px;');
console.log('%c✅ FIXED: PDF & documents now send — file_size column error eliminated', 'color:#34C759;font-size:13px;');
console.log('%c✅ FIXED: insertMessage strips unknown columns — schema-proof for future', 'color:#34C759;font-size:13px;');
console.log('%c✅ FIXED: Reactions now show properly BELOW messages (WhatsApp-style)', 'color:#34C759;font-size:13px;');
console.log('%c✅ FIXED: Reactions gold-highlighted when YOU reacted, correct alignment', 'color:#34C759;font-size:13px;');
console.log('%c📌 OPTIONAL: Create "chat-assets" Storage bucket for videos > 15MB', 'color:#FF9500;font-size:13px;');
/*
  SUPABASE SQL MIGRATION (run this in Supabase SQL editor):
  -- Required for group/profile pictures:
  ALTER TABLE rooms ADD COLUMN IF NOT EXISTS dp_url text;
  ALTER TABLE user_presence ADD COLUMN IF NOT EXISTS display_name text;
  ALTER TABLE user_presence ADD COLUMN IF NOT EXISTS dp_url text;
  -- User profiles table
  CREATE TABLE IF NOT EXISTS user_profiles (
    user_id uuid PRIMARY KEY,
    first_name text,
    last_name text,
    dp_url text,
    updated_at timestamptz DEFAULT now()
  );
  ALTER TABLE user_profiles ENABLE ROW LEVEL SECURITY;
  CREATE POLICY "Users manage own profile" ON user_profiles FOR ALL USING (auth.uid() = user_id);
  CREATE POLICY "All read profiles" ON user_profiles FOR SELECT USING (true);
*/
</script>
</body>
</html>
