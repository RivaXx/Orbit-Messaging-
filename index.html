<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#000000">
    <title>Orbit Pro | Solar OS</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Outfit:wght@500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

    <style>
        :root {
            --gold: #FFD700;
            --gold-dim: rgba(255, 215, 0, 0.15);
            --bg: #090909;
            --surface: #141414;
            --surface-light: #1E1E1E;
            --border: rgba(255, 255, 255, 0.08);
            --text: #F0F0F0;
            --text-sec: #888888;
            --msg-own: #FFD700;
            --msg-own-text: #000000;
            --msg-other: #222222;
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
            --online: #00ff00;
            --offline: #ff4444;
            --away: #ffaa00;
            --select-bg: rgba(255, 215, 0, 0.1);
            --select-border: rgba(255, 215, 0, 0.3);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; -webkit-user-drag: none; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; overflow: hidden; touch-action: pan-y; }

        .hide { display: none !important; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .center { align-items: center; justify-content: center; }
        .glass { background: rgba(20, 20, 20, 0.7); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid var(--border); }
        .btn-reset { border: none; background: none; padding: 0; margin: 0; cursor: pointer; color: inherit; }

        #app-viewport { width: 100%; height: 100%; position: relative; overflow: hidden; background: var(--bg); }
        @media (min-width: 768px) {
            body { display: flex; align-items: center; justify-content: center; background: #000; }
            #app-viewport { width: 400px; height: 850px; max-height: 95vh; border-radius: 24px; box-shadow: 0 0 50px rgba(255, 215, 0, 0.1); border: 1px solid var(--border); }
        }

        .screen { position: absolute; inset: 0; display: flex; flex-direction: column; background: var(--bg); transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); z-index: 10; }
        .screen.active { transform: translateX(0); z-index: 20; }
        .screen.z-top { z-index: 50; }

        .auth-container { padding: 40px; text-align: center; }
        .brand-logo { width: 60px; height: 60px; background: var(--gold); border-radius: 50%; margin: 0 auto 20px; box-shadow: 0 0 30px var(--gold-dim); animation: pulse 2s infinite; }
        .input-box { width: 100%; padding: 16px; background: var(--surface); border: 1px solid var(--border); border-radius: 12px; color: #fff; margin-bottom: 12px; font-size: 15px; transition: 0.2s; }
        .input-box:focus { border-color: var(--gold); }
        .btn-primary { width: 100%; padding: 16px; background: var(--gold); color: #000; font-weight: 700; border-radius: 12px; font-size: 16px; font-family: 'Outfit', sans-serif; letter-spacing: 0.5px; border: none; cursor: pointer; }
        
        /* Password input with eye icon */
        .password-wrapper { position: relative; width: 100%; margin-bottom: 12px; }
        .password-wrapper .input-box { width: 100%; padding-right: 45px; }
        .toggle-password { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--text-sec); cursor: pointer; font-size: 16px; z-index: 5; }
        
        /* Remember me checkbox */
        .remember-me { display: flex; align-items: center; gap: 8px; margin: 15px 0; font-size: 13px; color: var(--text-sec); cursor: pointer; }
        .remember-me input { width: 16px; height: 16px; accent-color: var(--gold); }
        
        .dash-nav { padding: calc(10px + var(--safe-top)) 20px 10px; display: flex; justify-content: space-between; align-items: center; }
        .dash-title { font-family: 'Outfit'; font-weight: 800; font-size: 24px; letter-spacing: -0.5px; }
        .user-chip { display: flex; align-items: center; gap: 10px; background: var(--surface); padding: 6px 12px 6px 6px; border-radius: 30px; border: 1px solid var(--border); }
        .avatar-small { width: 28px; height: 28px; background: linear-gradient(135deg, #333, #111); border-radius: 50%; color: var(--gold); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 12px; position: relative; }
        .avatar-small::after { content: ''; position: absolute; bottom: 0; right: 0; width: 8px; height: 8px; background: var(--online); border-radius: 50%; border: 2px solid var(--bg); }
        
        .search-bar-container { padding: 10px 20px; }
        .search-bar { width: 100%; background: var(--surface); border: none; padding: 12px 15px; border-radius: 10px; color: #fff; display: flex; align-items: center; gap: 10px; }
        .search-input { background: transparent; border: none; color: #fff; width: 100%; font-size: 14px; }
        .search-input::placeholder { color: var(--text-sec); }

        .dash-tabs { display: flex; padding: 0 20px; gap: 5px; border-bottom: 1px solid var(--border); overflow-x: auto; }
        .tab-btn { padding: 10px 0; min-width: 60px; background: none; border: none; color: var(--text-sec); font-size: 12px; font-weight: 600; border-bottom: 2px solid transparent; cursor: pointer; white-space: nowrap; }
        .tab-btn.active { color: var(--gold); border-bottom-color: var(--gold); }

        .contact-list { padding: 0 10px; overflow-y: auto; flex: 1; }
        .contact-item { display: flex; align-items: center; gap: 15px; padding: 12px; border-radius: 16px; transition: 0.2s; cursor: pointer; position: relative; }
        .contact-item:active { background: var(--surface); }
        .c-avatar { width: 48px; height: 48px; border-radius: 50%; background: #222; position: relative; border: 1px solid var(--border); flex-shrink: 0; }
        .c-avatar img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
        .c-status { position: absolute; bottom: 0; right: 0; width: 12px; height: 12px; border: 2px solid var(--bg); border-radius: 50%; }
        .c-status.online { background: var(--online); }
        .c-status.offline { background: var(--offline); }
        .c-status.away { background: var(--away); }
        .c-info { flex: 1; overflow: hidden; }
        .c-name { font-weight: 600; font-size: 15px; margin-bottom: 2px; display: flex; align-items: center; gap: 5px; }
        .c-last { font-size: 13px; color: var(--text-sec); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .c-meta { display: flex; flex-direction: column; align-items: flex-end; gap: 5px; }
        .c-time { font-size: 11px; color: var(--text-sec); }
        .unread-badge { background: var(--gold); color: #000; font-size: 10px; font-weight: 800; padding: 2px 6px; border-radius: 10px; }
        .pin-badge { color: var(--gold); font-size: 10px; }
        
        .modal-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.8); z-index: 200; display: none; align-items: center; justify-content: center; }
        .modal-overlay.active { display: flex; }
        .modal-content { background: var(--surface); width: 90%; max-width: 350px; border-radius: 16px; padding: 20px; border: 1px solid var(--border); }
        .modal-title { font-weight: 700; font-size: 18px; margin-bottom: 15px; }
        .modal-input { width: 100%; padding: 12px; background: #000; border: 1px solid var(--border); border-radius: 10px; color: #fff; margin-bottom: 15px; font-size: 14px; font-family: inherit; }
        .modal-input:focus { border-color: var(--gold); }
        .modal-btns { display: flex; gap: 10px; }
        .modal-btn { flex: 1; padding: 12px; border-radius: 10px; border: none; font-weight: 600; cursor: pointer; font-size: 14px; }
        .modal-btn.cancel { background: #333; color: #fff; }
        .modal-btn.create { background: var(--gold); color: #000; }

        .notes-container { padding: 20px; }
        .note-item { background: var(--surface); border-radius: 12px; padding: 15px; margin-bottom: 10px; border-left: 3px solid var(--gold); position: relative; }
        .note-title { font-weight: 700; margin-bottom: 5px; }
        .note-content { color: var(--text-sec); font-size: 14px; white-space: pre-wrap; word-break: break-word; }
        .note-actions { position: absolute; top: 10px; right: 10px; display: flex; gap: 8px; }
        .note-action-btn { width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.5); color: var(--gold); border: none; cursor: pointer; font-size: 13px; }
        .note-date { font-size: 10px; color: var(--text-sec); margin-top: 8px; }
        
        .online-counter { display: flex; align-items: center; gap: 5px; font-size: 11px; color: var(--online); padding: 5px 10px; background: rgba(0,255,0,0.1); border-radius: 10px; }
        
        .app-footer { text-align: center; padding: 20px; font-size: 10px; color: var(--text-sec); border-top: 1px solid var(--border); margin-top: auto; }

        .chat-header { padding: calc(10px + var(--safe-top)) 15px 10px; background: rgba(9, 9, 9, 0.9); backdrop-filter: blur(10px); border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 15px; z-index: 20; flex-shrink: 0; }
        .chat-info { flex: 1; }
        .chat-name { font-weight: 700; font-size: 16px; }
        .chat-status { font-size: 11px; color: var(--gold); }
        
        .chat-feed { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 4px; min-height: 0; }
        
        .msg-row { display: flex; width: 100%; margin-bottom: 2px; position: relative; transition: transform 0.2s, background 0.2s; }
        .msg-row.own { justify-content: flex-end; }
        .msg-row.swiping { transform: translateX(60px); }
        .msg-row.selected { background: var(--select-bg); border-radius: 8px; }
        .msg-row.selected::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 3px; background: var(--gold); border-radius: 3px; }
        .msg-bubble { max-width: 75%; padding: 8px 12px; border-radius: 12px; position: relative; font-size: 14px; line-height: 1.4; word-wrap: break-word; }
        .msg-row.own .msg-bubble { background: var(--msg-own); color: var(--msg-own-text); border-bottom-right-radius: 2px; }
        .msg-row.other .msg-bubble { background: var(--msg-other); color: #fff; border-bottom-left-radius: 2px; }
        .msg-row.sending .msg-bubble { opacity: 0.7; }
        .msg-row.failed .msg-bubble { opacity: 0.5; border: 1px solid #ff4444; }
        .msg-row.pinned { border-left: 3px solid var(--gold); padding-left: 8px; }
        
        .msg-checkbox { position: absolute; left: 5px; top: 50%; transform: translateY(-50%); width: 18px; height: 18px; border: 2px solid var(--gold); border-radius: 4px; background: rgba(0,0,0,0.5); display: none; cursor: pointer; z-index: 2; }
        .msg-row.select-mode .msg-checkbox { display: block; }
        .msg-row.select-mode.own .msg-checkbox { left: auto; right: 5px; }
        .msg-checkbox.checked { background: var(--gold); }
        .msg-checkbox.checked::after { content: '✓'; position: absolute; color: #000; font-size: 12px; font-weight: bold; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        
        .msg-meta { display: flex; align-items: center; justify-content: flex-end; gap: 4px; font-size: 9px; margin-top: 4px; opacity: 0.7; }
        .msg-row.own .msg-meta { color: rgba(0,0,0,0.5); }
        .tick-icon { font-size: 10px; }
        .tick-read { color: #007AFF; }
        .tick-sent { color: rgba(0,0,0,0.4); }
        .tick-dlvd { color: rgba(0,0,0,0.6); }
        .tick-sending { color: rgba(0,0,0,0.3); }

        .chat-footer { padding: 10px; background: var(--surface-light); display: flex; flex-direction: column; gap: 8px; border-top: 1px solid var(--border); padding-bottom: calc(10px + var(--safe-bottom)); flex-shrink: 0; }
        .chat-footer-row { display: flex; align-items: center; gap: 10px; }
        .input-wrapper { flex: 1; background: #000; border-radius: 20px; border: 1px solid var(--border); display: flex; align-items: center; padding: 8px 12px; min-height: 40px; }
        .msg-input { background: transparent; border: none; color: #fff; width: 100%; max-height: 100px; font-family: inherit; font-size: 15px; resize: none; padding: 0; margin: 0; line-height: 1.4; }
        .msg-input::placeholder { color: var(--text-sec); }
        .footer-btn { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; color: var(--gold); transition: 0.2s; border: none; background: none; cursor: pointer; flex-shrink: 0; }
        .footer-btn:active { background: rgba(255,255,255,0.1); transform: scale(0.9); }
        
        /* Fixed red badge position */
        .send-btn-badge { 
            position: absolute; 
            top: -5px; 
            right: -5px; 
            background: #ff4444; 
            color: white; 
            font-size: 9px; 
            font-weight: bold; 
            width: 16px; 
            height: 16px; 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            z-index: 10;
        }
        
        .selection-toolbar { position: absolute; bottom: 0; left: 0; right: 0; background: var(--surface-light); border-top: 1px solid var(--border); padding: 10px; display: flex; justify-content: space-around; align-items: center; transform: translateY(100%); transition: transform 0.3s; z-index: 100; }
        .selection-toolbar.active { transform: translateY(0); }
        .selection-count { color: var(--gold); font-weight: 700; font-size: 14px; }
        .selection-btn { background: none; border: none; color: var(--gold); font-size: 18px; cursor: pointer; padding: 8px 12px; border-radius: 8px; }
        .selection-btn:active { background: rgba(255,215,0,0.1); }
        
        .media-preview-strip { display: flex; gap: 8px; overflow-x: auto; padding: 0 5px 5px; }
        .media-preview-strip.hide { display: none; }
        .media-preview-thumb { position: relative; width: 70px; height: 70px; border-radius: 10px; overflow: hidden; border: 2px solid var(--border); flex-shrink: 0; background: #111; }
        .media-preview-thumb img, .media-preview-thumb video { width: 100%; height: 100%; object-fit: cover; }
        .media-preview-thumb .play-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.4); display: flex; align-items: center; justify-content: center; color: #fff; font-size: 18px; }
        .remove-media-btn { position: absolute; top: 2px; right: 2px; background: rgba(255, 0, 0, 0.85); color: white; border: none; width: 18px; height: 18px; border-radius: 50%; font-size: 9px; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 2; }

        .media-sheet { position: absolute; inset: 0; background: rgba(0,0,0,0.6); z-index: 100; display: none; align-items: flex-end; }
        .media-sheet.active { display: flex; animation: fadeIn 0.2s; }
        .sheet-content { width: 100%; background: #1a1a1a; border-radius: 20px 20px 0 0; padding: 20px; border-top: 1px solid var(--border); transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .media-sheet.active .sheet-content { transform: translateY(0); }
        
        .sheet-handle { width: 40px; height: 5px; background: rgba(255,255,255,0.2); border-radius: 5px; margin: 0 auto 20px; }
        .media-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; }
        .media-opt { display: flex; flex-direction: column; align-items: center; gap: 8px; cursor: pointer; }
        .m-icon { width: 50px; height: 50px; border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 20px; color: #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .media-opt span { font-size: 11px; opacity: 0.7; }
        
        .btn-cancel { width: 100%; padding: 15px; background: #2a2a2a; border: none; border-radius: 12px; color: #fff; font-weight: 600; font-size: 16px; cursor: pointer; }

        .fullscreen-modal { position: absolute; inset: 0; background: #000; z-index: 200; display: flex; flex-direction: column; }
        .editor-header { padding: calc(10px + var(--safe-top)) 20px 10px; display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.8); z-index: 10; flex-shrink: 0; }
        .btn-icon { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background: none; border: none; color: #fff; font-size: 20px; cursor: pointer; }
        .btn-text-gold { color: var(--gold); background: none; border: none; font-weight: 700; font-size: 16px; cursor: pointer; font-family: inherit; }

        .editor-canvas-container { flex: 1; background: #111; position: relative; display: flex; align-items: center; justify-content: center; overflow: hidden; min-height: 0; }
        .editor-canvas-container img { max-width: 100%; max-height: 100%; }

        .enhanced-tools { display: flex; flex-direction: column; padding: 15px; background: #111; gap: 12px; flex-shrink: 0; }
        .tool-section { display: flex; flex-direction: column; gap: 8px; }
        .tool-section-title { font-size: 11px; color: #888; font-weight: 600; letter-spacing: 0.5px; }
        .editor-tools-row { display: flex; gap: 8px; flex-wrap: wrap; }
        .editor-tool { background: #222; border: 1px solid var(--border); color: #fff; padding: 8px 12px; border-radius: 8px; font-size: 12px; display: flex; align-items: center; gap: 5px; cursor: pointer; font-family: inherit; }
        .editor-tool:active { background: var(--gold); color: #000; }
        .filter-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .filter-item { aspect-ratio: 1; border-radius: 8px; overflow: hidden; border: 2px solid transparent; cursor: pointer; position: relative; background: #222; display: flex; align-items: center; justify-content: center; }
        .filter-item.active { border-color: var(--gold); }
        .filter-item .filter-label { font-size: 9px; color: #fff; text-align: center; position: absolute; bottom: 3px; left: 0; right: 0; text-shadow: 0 1px 2px #000; }
        .filter-swatch { width: 100%; height: 100%; }
        .swatch-normal { background: linear-gradient(135deg, #444, #222); }
        .swatch-bw { background: linear-gradient(135deg, #888, #333); filter: grayscale(100%); }
        .swatch-vintage { background: linear-gradient(135deg, #8B6914, #5C3D0E); }
        .swatch-bright { background: linear-gradient(135deg, #fff, #ccc); }
        .swatch-contrast { background: linear-gradient(135deg, #fff 0%, #000 100%); }
        .swatch-saturate { background: linear-gradient(135deg, #ff6b6b, #4ecdc4); }

        .video-preview-modal { position: absolute; inset: 0; background: #000; z-index: 200; display: flex; flex-direction: column; }
        .video-preview-modal .editor-header { flex-shrink: 0; }
        .video-preview-container { flex: 1; display: flex; align-items: center; justify-content: center; min-height: 0; padding: 10px; }
        .video-preview-container video { max-width: 100%; max-height: 100%; border-radius: 8px; }
        .video-controls { padding: 15px; background: #111; flex-shrink: 0; display: flex; align-items: center; justify-content: center; gap: 20px; }
        .video-ctrl-btn { width: 44px; height: 44px; border-radius: 50%; background: #222; border: 1px solid var(--border); color: #fff; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 16px; }
        .video-ctrl-btn:active { background: var(--gold); color: #000; }

        .upload-screen { position: absolute; inset: 0; background: rgba(0,0,0,0.85); z-index: 300; display: flex; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .upload-circle { position: relative; width: 120px; height: 120px; }
        .progress-ring__circle { stroke-dasharray: 326; stroke-dashoffset: 326; transition: stroke-dashoffset 0.3s linear; transform: rotate(-90deg); transform-origin: 50% 50%; }
        .upload-pct { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 20px; font-family: 'Outfit'; color: var(--gold); }
        .upload-label { margin-top: 20px; font-weight: 600; color: #fff; font-size: 15px; }
        .upload-sublabel { margin-top: 5px; font-size: 12px; color: var(--text-sec); }

        .reply-bar { background: var(--surface); padding: 8px 15px; border-top: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; border-left: 3px solid var(--gold); flex-shrink: 0; }
        .reply-content { flex: 1; font-size: 12px; overflow: hidden; }
        .reply-title { color: var(--gold); font-weight: 700; margin-bottom: 2px; }
        .reply-text { color: #aaa; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .ctx-overlay { position: fixed; inset: 0; z-index: 500; background: rgba(0,0,0,0.1); }
        .ctx-menu { position: absolute; background: rgba(30,30,30,0.95); backdrop-filter: blur(10px); width: 200px; border-radius: 12px; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.5); border: 1px solid var(--border); transform: scale(0.9); opacity: 0; transition: 0.2s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .ctx-menu.active { transform: scale(1); opacity: 1; }
        
        .ctx-item { padding: 12px 15px; color: #fff; font-size: 14px; border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; gap: 12px; align-items: center; cursor: pointer; }
        .ctx-item:last-child { border-bottom: none; }
        .ctx-item:active { background: rgba(255,255,255,0.1); }
        .ctx-item.delete { color: #ff4444; }

        .date-badge { text-align: center; margin: 15px 0; position: sticky; top: 0; z-index: 5; }
        .date-badge span { background: rgba(30,30,30,0.8); backdrop-filter: blur(4px); color: #888; padding: 4px 12px; border-radius: 10px; font-size: 10px; font-weight: 700; border: 1px solid var(--border); }

        .msg-reply-context { background: rgba(0,0,0,0.15); border-left: 2px solid var(--gold); padding: 4px 8px; border-radius: 4px; margin-bottom: 4px; font-size: 11px; cursor: pointer; }
        .msg-row.own .msg-reply-context { background: rgba(0,0,0,0.12); }
        .msg-reply-context .reply-author { font-weight: 700; color: var(--gold); margin-bottom: 1px; }
        .msg-reply-context .reply-preview { color: rgba(0,0,0,0.5); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .msg-row.other .msg-reply-context .reply-preview { color: #aaa; }

        .loader { border: 3px solid rgba(255,255,255,0.1); border-top: 3px solid var(--gold); border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; margin: 10px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.05); opacity: 0.8; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Enhanced image grid for multiple images */
        .image-grid-container { display: grid; gap: 4px; margin-bottom: 4px; }
        .image-grid-container.grid-1 { grid-template-columns: 1fr; }
        .image-grid-container.grid-2 { grid-template-columns: repeat(2, 1fr); }
        .image-grid-container.grid-3 { grid-template-columns: repeat(2, 1fr); grid-template-rows: repeat(2, 1fr); }
        .image-grid-container.grid-3 img:first-child { grid-column: 1 / span 2; }
        .image-grid-container.grid-4 { grid-template-columns: repeat(2, 1fr); grid-template-rows: repeat(2, 1fr); }
        
        .image-grid-item { width: 100%; height: 150px; object-fit: cover; border-radius: 8px; cursor: pointer; background: #000; }
        .image-grid-item.more-overlay { position: relative; }
        .image-grid-item.more-overlay::after { content: '+X'; position: absolute; inset: 0; background: rgba(0,0,0,0.7); color: #fff; display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: bold; border-radius: 8px; }
        
        .msg-bubble img.single-image { max-width: 200px; border-radius: 8px; display: block; cursor: pointer; margin-bottom: 4px; }
        .msg-bubble video { max-width: 200px; border-radius: 8px; display: block; cursor: pointer; margin-bottom: 4px; background: #000; }

        .doc-bubble { background: #333; padding: 10px; border-radius: 8px; display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .doc-bubble:active { background: #444; }
        .doc-icon { font-size: 24px; color: #FF3B30; }
        .doc-info { flex: 1; min-width: 0; }
        .doc-name { font-weight: 600; font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .doc-sub { font-size: 10px; color: #aaa; }

        .delete-modal { position: absolute; inset: 0; background: rgba(0,0,0,0.8); z-index: 700; display: none; align-items: center; justify-content: center; }
        .delete-modal.active { display: flex; }
        .delete-content { background: var(--surface); width: 80%; max-width: 300px; border-radius: 16px; padding: 20px; text-align: center; border: 1px solid var(--border); }
        .delete-title { font-weight: 700; margin-bottom: 10px; }
        .delete-desc { color: #aaa; font-size: 14px; margin-bottom: 20px; }
        .delete-btns { display: flex; gap: 10px; flex-wrap: wrap; }
        .delete-btn { flex: 1; min-width: 80px; padding: 12px; border-radius: 10px; border: none; font-weight: 600; cursor: pointer; font-size: 13px; }
        .delete-btn.cancel { background: #333; color: #fff; }
        .delete-btn.del-me { background: #ff4444; color: #fff; }
        .delete-btn.del-all { background: #ff8800; color: #fff; }

        .skeleton { background: linear-gradient(90deg, #222 25%, #2a2a2a 50%, #222 75%); background-size: 200% 100%; animation: loading 1.5s infinite; border-radius: 12px; }
        @keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

        .toast { position: absolute; bottom: 80px; left: 50%; transform: translateX(-50%) translateY(100px); background: #ff4444; color: #fff; padding: 12px 20px; border-radius: 10px; font-size: 13px; font-weight: 600; z-index: 600; transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); white-space: nowrap; }
        .toast.show { transform: translateX(-50%) translateY(0); }
        .toast.success { background: #34C759; }

        .lightbox-overlay { position: absolute; inset: 0; background: #000; z-index: 1000; display: none; flex-direction: column; }
        .lightbox-overlay.active { display: flex; }
        .lightbox-header { padding: calc(10px + var(--safe-top)) 15px 10px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .lightbox-body { flex: 1; display: flex; align-items: center; justify-content: center; padding: 10px; min-height: 0; }
        .lightbox-body img, .lightbox-body video { max-width: 100%; max-height: 100%; border-radius: 4px; }
        .lightbox-actions { padding: 15px; display: flex; justify-content: center; gap: 20px; flex-shrink: 0; }
        .lightbox-btn { width: 44px; height: 44px; border-radius: 50%; background: #222; border: 1px solid var(--border); color: #fff; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 16px; }
        .lightbox-btn:active { background: var(--gold); color: #000; }

        .discard-btn { position: absolute; bottom: 10px; left: 10px; background: rgba(255, 0, 0, 0.8); color: white; border: none; padding: 8px 14px; border-radius: 20px; font-size: 12px; cursor: pointer; z-index: 10; display: flex; align-items: center; gap: 5px; font-family: inherit; font-weight: 600; }
        
        .swipe-reply-indicator { position: absolute; left: -60px; top: 50%; transform: translateY(-50%); color: var(--gold); font-size: 24px; width: 50px; text-align: center; opacity: 0; transition: opacity 0.2s; }
        .msg-row.swiping .swipe-reply-indicator { opacity: 1; }
        
        .pin-modal { position: absolute; inset: 0; background: rgba(0,0,0,0.8); z-index: 800; display: none; align-items: center; justify-content: center; }
        .pin-modal.active { display: flex; }
        .pin-content { background: var(--surface); width: 80%; max-width: 300px; border-radius: 16px; padding: 20px; text-align: center; border: 1px solid var(--border); }
        .pin-title { font-weight: 700; margin-bottom: 10px; }
        .pin-desc { color: #aaa; font-size: 14px; margin-bottom: 20px; }
        .pin-btns { display: flex; gap: 10px; flex-wrap: wrap; }
        .pin-btn { flex: 1; min-width: 80px; padding: 12px; border-radius: 10px; border: none; font-weight: 600; cursor: pointer; font-size: 13px; }
        .pin-btn.cancel { background: #333; color: #fff; }
        .pin-btn.pin { background: var(--gold); color: #000; }
        
        .compression-options { position: fixed; bottom: 0; left: 0; right: 0; background: var(--surface); border-top: 1px solid var(--border); padding: 15px; transform: translateY(100%); transition: transform 0.3s; z-index: 150; }
        .compression-options.active { transform: translateY(0); }
        .compression-title { font-weight: 600; margin-bottom: 10px; }
        .compression-slider { width: 100%; -webkit-appearance: none; height: 4px; background: #333; border-radius: 2px; outline: none; }
        .compression-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 20px; height: 20px; background: var(--gold); border-radius: 50%; cursor: pointer; }
        .compression-labels { display: flex; justify-content: space-between; margin-top: 5px; font-size: 11px; color: var(--text-sec); }
        
        .batch-download-modal { position: absolute; inset: 0; background: rgba(0,0,0,0.8); z-index: 900; display: none; align-items: center; justify-content: center; }
        .batch-download-modal.active { display: flex; }
        .batch-download-content { background: var(--surface); width: 80%; max-width: 300px; border-radius: 16px; padding: 20px; text-align: center; border: 1px solid var(--border); }
        .batch-download-title { font-weight: 700; margin-bottom: 10px; }
        .batch-download-desc { color: #aaa; font-size: 14px; margin-bottom: 20px; }
        .batch-download-btns { display: flex; gap: 10px; flex-wrap: wrap; }
        .batch-download-btn { flex: 1; min-width: 80px; padding: 12px; border-radius: 10px; border: none; font-weight: 600; cursor: pointer; font-size: 13px; }
        .batch-download-btn.cancel { background: #333; color: #fff; }
        .batch-download-btn.download { background: var(--gold); color: #000; }
        
        /* Secure Chat Tab Styles */
        .secure-chat-item { display: flex; align-items: center; gap: 15px; padding: 12px; border-radius: 16px; cursor: pointer; border: 1px solid var(--gold-dim); background: var(--surface); }
        .secure-chat-avatar { width: 48px; height: 48px; border-radius: 50%; background: linear-gradient(135deg, #1a2a3a, #0a1a2a); display: flex; align-items: center; justify-content: center; color: var(--gold); font-size: 20px; border: 2px solid var(--gold-dim); }
        .secure-chat-info { flex: 1; }
        .secure-chat-name { font-weight: 700; font-size: 15px; color: var(--gold); }
        .secure-chat-desc { font-size: 12px; color: var(--text-sec); }
        .secure-chat-status { font-size: 10px; color: var(--online); padding: 2px 8px; background: rgba(0,255,0,0.1); border-radius: 10px; }
        
        /* Enhanced Context Menu */
        .ctx-menu-enhanced { position: absolute; background: rgba(20,20,20,0.95); backdrop-filter: blur(20px); width: 220px; border-radius: 16px; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.7); border: 1px solid var(--border); transform: scale(0.9); opacity: 0; transition: 0.2s cubic-bezier(0.2, 0.8, 0.2, 1); z-index: 1000; }
        .ctx-menu-enhanced.active { transform: scale(1); opacity: 1; }
        .ctx-divider { height: 1px; background: rgba(255,255,255,0.1); margin: 4px 0; }
    </style>
</head>
<body>

<div id="app-viewport">

    <!-- AUTH SCREEN -->
    <div id="screen-auth" class="screen active flex center">
        <div class="auth-container">
            <div class="brand-logo"></div>
            <h1 style="font-family:'Outfit'; margin-bottom:5px;">Orbit Pro</h1>
            <p style="color:var(--text-sec); font-size:12px; margin-bottom:30px;">V72 | SOLAR OS</p>
            
            <input type="email" id="auth-email" class="input-box" placeholder="Access ID (Email)">
            <div class="password-wrapper">
                <input type="password" id="auth-pass" class="input-box" placeholder="Passkey">
                <button type="button" class="toggle-password" id="toggle-password">
                    <i class="fa-solid fa-eye"></i>
                </button>
            </div>
            <div class="remember-me">
                <input type="checkbox" id="remember-me">
                <label for="remember-me">Remember me for 2 days</label>
            </div>
            <button class="btn-primary" onclick="handleAuth()">INITIALIZE</button>
            <p id="auth-err" style="color:#ff4444; font-size:12px; margin-top:15px; display:none;"></p>
        </div>
    </div>

    <!-- DASHBOARD -->
    <div id="screen-dash" class="screen">
        <div class="dash-nav">
            <div>
                <div class="dash-title">Orbit</div>
                <div style="font-size:10px; color:var(--text-sec);">Connect & Communicate</div>
            </div>
            <div class="user-chip">
                <div class="avatar-small" id="dash-av">U</div>
                <span style="font-size:12px; font-weight:600;" id="dash-id">User</span>
                <div class="online-counter" id="online-counter">
                    <i class="fa-solid fa-circle"></i> <span>0 online</span>
                </div>
            </div>
        </div>
        
        <div class="search-bar-container">
            <div class="search-bar">
                <i class="fa-solid fa-magnifying-glass" style="color:var(--text-sec);"></i>
                <input type="text" class="search-input" placeholder="Search people or groups..." id="search-input">
                <i class="fa-solid fa-plus-circle" style="color:var(--gold); font-size:20px; cursor:pointer;" onclick="showNewRoomModal()"></i>
            </div>
        </div>

        <div class="dash-tabs">
            <button class="tab-btn active" data-tab="chats" onclick="switchTab(this)">Chats</button>
            <button class="tab-btn" data-tab="secure-chat" onclick="switchTab(this)"><i class="fa-solid fa-lock"></i> Secure</button>
            <button class="tab-btn" data-tab="friends" onclick="switchTab(this)">Friends</button>
            <button class="tab-btn" data-tab="groups" onclick="switchTab(this)">Groups</button>
            <button class="tab-btn" data-tab="global" onclick="switchTab(this)">Global</button>
            <button class="tab-btn" data-tab="notes" onclick="switchTab(this)">Notes</button>
        </div>

        <div class="contact-list" id="tab-chats">
            <div style="padding:15px 20px 5px; font-size:13px; color:var(--text-sec); font-weight:600;">Recent Conversations</div>
            <div id="chats-list"></div>
        </div>

        <div class="contact-list hide" id="tab-secure-chat">
            <div style="padding:15px 20px 5px; display:flex; justify-content:space-between; align-items:center;">
                <span style="font-size:13px; color:var(--text-sec); font-weight:600;">Personal Secure Chat</span>
                <button onclick="createSecureChat()" style="background:var(--gold); color:#000; border:none; padding:5px 12px; border-radius:15px; font-size:11px; font-weight:700; cursor:pointer;"><i class="fa-solid fa-lock"></i> New</button>
            </div>
            <div id="secure-chat-list" style="padding:10px;">
                <!-- Secure chats will be loaded here -->
            </div>
        </div>

        <div class="contact-list hide" id="tab-friends">
            <div style="padding:15px 20px 5px; display:flex; justify-content:space-between; align-items:center;">
                <span style="font-size:13px; color:var(--text-sec); font-weight:600;">Friends</span>
                <button onclick="addFriend()" style="background:var(--gold); color:#000; border:none; padding:5px 12px; border-radius:15px; font-size:11px; font-weight:700; cursor:pointer;"><i class="fa-solid fa-user-plus"></i> Add</button>
            </div>
            <div id="friends-list"></div>
        </div>

        <div class="contact-list hide" id="tab-groups">
            <div style="padding:15px 20px 5px; display:flex; justify-content:space-between; align-items:center;">
                <span style="font-size:13px; color:var(--text-sec); font-weight:600;">Groups</span>
                <button onclick="createGroup()" style="background:var(--gold); color:#000; border:none; padding:5px 12px; border-radius:15px; font-size:11px; font-weight:700; cursor:pointer;"><i class="fa-solid fa-users"></i> New</button>
            </div>
            <div id="groups-list"></div>
        </div>

        <div class="contact-list hide" id="tab-global">
            <div style="padding:15px 20px 5px; display:flex; justify-content:space-between; align-items:center;">
                <span style="font-size:13px; color:var(--text-sec); font-weight:600;">Global Users</span>
                <div class="online-counter" id="global-online-counter">
                    <i class="fa-solid fa-circle"></i> <span>0 online</span>
                </div>
            </div>
            <div id="global-users-list"></div>
        </div>

        <div class="contact-list hide" id="tab-notes">
            <div style="padding:15px 20px 5px; display:flex; justify-content:space-between; align-items:center;">
                <span style="font-size:13px; color:var(--text-sec); font-weight:600;">Secure Notes</span>
                <button onclick="createNewNote()" style="background:var(--gold); color:#000; border:none; padding:5px 12px; border-radius:15px; font-size:11px; font-weight:700; cursor:pointer;"><i class="fa-solid fa-plus"></i> New</button>
            </div>
            <div id="secure-notes-list" class="notes-container"></div>
        </div>

        <div class="app-footer">
            Developed by Rivaldo<br>an Orbit ® production
        </div>
    </div>

    <!-- CHAT SCREEN -->
    <div id="screen-chat" class="screen z-top">
        <div class="chat-header">
            <button class="btn-reset" onclick="navBack()"><i class="fa-solid fa-arrow-left" style="font-size:18px;"></i></button>
            <div class="chat-info">
                <div class="chat-name" id="chat-title">Room Name</div>
                <div class="chat-status" id="chat-status">Connected</div>
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn-reset" id="select-toggle-btn" style="font-size:16px; color:var(--gold); display:none;" onclick="toggleSelectMode()"><i class="fa-solid fa-check-double"></i></button>
                <button class="btn-reset" onclick="toggleFavorite()" id="fav-btn" style="font-size:16px; color:var(--gold);"><i class="fa-regular fa-star"></i></button>
            </div>
        </div>

        <div class="chat-feed" id="chat-feed"></div>
        
        <div class="selection-toolbar" id="selection-toolbar">
            <div class="selection-count" id="selection-count">0 selected</div>
            <button class="selection-btn" onclick="downloadSelectedMessages()"><i class="fa-solid fa-download"></i></button>
            <button class="selection-btn" onclick="deleteSelectedMessages()"><i class="fa-solid fa-trash"></i></button>
            <button class="selection-btn" onclick="clearSelection()"><i class="fa-solid fa-xmark"></i></button>
        </div>

        <div id="reply-bar" class="reply-bar hide">
            <div class="reply-content">
                <div class="reply-title" id="reply-user">Replying to User</div>
                <div class="reply-text" id="reply-text">Message content...</div>
            </div>
            <button class="btn-icon" onclick="cancelReply()" style="width:30px; height:30px; color:#fff;"><i class="fa-solid fa-xmark"></i></button>
        </div>

        <div class="chat-footer">
            <div class="media-preview-strip hide" id="media-preview-strip"></div>
            <div class="chat-footer-row">
                <button class="footer-btn" onclick="openMediaPicker()"><i class="fa-solid fa-plus"></i></button>
                <div class="input-wrapper">
                    <textarea id="msg-input" class="msg-input" rows="1" placeholder="Message..." onkeydown="handleKeyDown(event)"></textarea>
                </div>
                <button class="footer-btn" style="background:var(--gold); color:#000; position:relative;" onclick="sendMessage()" id="send-btn">
                    <i class="fa-solid fa-paper-plane" style="font-size:14px;"></i>
                </button>
            </div>
        </div>
    </div>

    <div id="modal-new-room" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-title" id="modal-room-title">Create New Room</div>
            <input type="text" id="room-name-input" class="modal-input" placeholder="Room name">
            <input type="text" id="room-topic-input" class="modal-input" placeholder="Room topic (optional)">
            <div class="modal-btns">
                <button class="modal-btn cancel" onclick="closeNewRoomModal()">Cancel</button>
                <button class="modal-btn create" onclick="createNewRoom()">Create</button>
            </div>
        </div>
    </div>

    <div id="modal-add-friend" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-title">Add Friend</div>
            <input type="email" id="friend-email-input" class="modal-input" placeholder="Friend's email">
            <div class="modal-btns">
                <button class="modal-btn cancel" onclick="closeAddFriendModal()">Cancel</button>
                <button class="modal-btn create" onclick="sendFriendRequest()">Send Request</button>
            </div>
        </div>
    </div>

    <div id="modal-note" class="modal-overlay">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-title" id="modal-note-title">New Secure Note</div>
            <input type="text" id="note-title-input" class="modal-input" placeholder="Note title">
            <textarea id="note-content-input" class="modal-input" placeholder="Note content..." rows="8" style="resize: vertical; min-height: 120px;"></textarea>
            <div class="modal-btns">
                <button class="modal-btn cancel" onclick="closeNoteModal()">Cancel</button>
                <button class="modal-btn create" onclick="saveNote()">Save</button>
            </div>
        </div>
    </div>

    <div id="sheet-media" class="media-sheet">
        <div class="sheet-content">
            <div class="sheet-handle"></div>
            <div class="media-grid">
                <div class="media-opt" onclick="triggerFile('gallery')">
                    <div class="m-icon" style="background:#007AFF;"><i class="fa-solid fa-images"></i></div>
                    <span>Gallery</span>
                </div>
                <div class="media-opt" onclick="triggerFile('camera')">
                    <div class="m-icon" style="background:#FF3B30;"><i class="fa-solid fa-camera"></i></div>
                    <span>Camera</span>
                </div>
                <div class="media-opt" onclick="triggerFile('video')">
                    <div class="m-icon" style="background:#34C759;"><i class="fa-solid fa-video"></i></div>
                    <span>Video</span>
                </div>
                <div class="media-opt" onclick="triggerFile('document')">
                    <div class="m-icon" style="background:#5856D6;"><i class="fa-solid fa-file-pdf"></i></div>
                    <span>Document</span>
                </div>
            </div>
            <button class="btn-cancel" onclick="closeMediaSheet()">Cancel</button>
        </div>
    </div>

    <div id="modal-editor" class="fullscreen-modal hide">
        <div class="editor-header">
            <button class="btn-icon" onclick="cancelEditor()"><i class="fa-solid fa-xmark"></i></button>
            <span style="font-weight:700; color:#fff;">Edit Image</span>
            <button class="btn-text-gold" onclick="finishEditing()">Send</button>
        </div>
        <div class="editor-canvas-container">
            <img id="image-to-edit" src="" alt="edit">
        </div>
        <div class="enhanced-tools">
            <div class="tool-section">
                <div class="tool-section-title">EDIT</div>
                <div class="editor-tools-row">
                    <button class="editor-tool" onclick="cropperCrop()"><i class="fa-solid fa-crop"></i> Crop</button>
                    <button class="editor-tool" onclick="cropperRotate(-90)"><i class="fa-solid fa-rotate-left"></i></button>
                    <button class="editor-tool" onclick="cropperRotate(90)"><i class="fa-solid fa-rotate-right"></i></button>
                    <button class="editor-tool" onclick="cropperFlip()"><i class="fa-solid fa-left-right"></i></button>
                </div>
            </div>
            <div class="tool-section">
                <div class="tool-section-title">FILTERS</div>
                <div class="filter-grid">
                    <div class="filter-item active" id="filter-normal" onclick="applyFilter('normal', this)">
                        <div class="filter-swatch swatch-normal"></div>
                        <div class="filter-label">Normal</div>
                    </div>
                    <div class="filter-item" id="filter-bw" onclick="applyFilter('grayscale', this)">
                        <div class="filter-swatch swatch-bw"></div>
                        <div class="filter-label">B&W</div>
                    </div>
                    <div class="filter-item" id="filter-vintage" onclick="applyFilter('sepia', this)">
                        <div class="filter-swatch swatch-vintage"></div>
                        <div class="filter-label">Vintage</div>
                    </div>
                    <div class="filter-item" id="filter-bright" onclick="applyFilter('brightness', this)">
                        <div class="filter-swatch swatch-bright"></div>
                        <div class="filter-label">Bright</div>
                    </div>
                    <div class="filter-item" id="filter-contrast" onclick="applyFilter('contrast', this)">
                        <div class="filter-swatch swatch-contrast"></div>
                        <div class="filter-label">Contrast</div>
                    </div>
                    <div class="filter-item" id="filter-saturate" onclick="applyFilter('saturate', this)">
                        <div class="filter-swatch swatch-saturate"></div>
                        <div class="filter-label">Vivid</div>
                    </div>
                </div>
            </div>
        </div>
        <button class="discard-btn" onclick="cancelEditor()"><i class="fa-solid fa-trash"></i> Discard</button>
    </div>

    <div id="modal-video-preview" class="video-preview-modal hide">
        <div class="editor-header">
            <button class="btn-icon" onclick="cancelVideoPreview()"><i class="fa-solid fa-xmark"></i></button>
            <span style="font-weight:700; color:#fff;">Video Preview</span>
            <button class="btn-text-gold" onclick="sendVideoPreview()">Send</button>
        </div>
        <div class="video-preview-container">
            <video id="video-preview" controls playsinline></video>
        </div>
        <div class="video-controls">
            <button class="video-ctrl-btn" onclick="trimVideo()"><i class="fa-solid fa-scissors"></i></button>
        </div>
    </div>

    <div id="upload-overlay" class="upload-screen hide">
        <div class="upload-circle">
            <svg class="progress-ring" width="120" height="120">
                <circle class="progress-ring__circle" stroke="var(--gold)" stroke-width="4" fill="transparent" r="52" cx="60" cy="60"/>
            </svg>
            <div class="upload-pct" id="upload-pct">0%</div>
        </div>
        <div class="upload-label">Uploading...</div>
        <div class="upload-sublabel" id="upload-file-name">file.jpg</div>
        <button style="margin-top:25px; background:#333; color:#fff; border:none; padding:10px 20px; border-radius:20px; cursor:pointer; font-size:13px;" onclick="cancelUpload()"><i class="fa-solid fa-xmark"></i> Cancel</button>
    </div>

    <div id="ctx-overlay" class="ctx-overlay hide" onclick="closeCtx()"></div>
    
    <!-- Enhanced Context Menu -->
    <div id="ctx-menu-enhanced" class="ctx-menu-enhanced">
        <div class="ctx-item" onclick="handleCtxAction('reply')"><i class="fa-solid fa-reply"></i> Reply</div>
        <div class="ctx-item" onclick="handleCtxAction('copy')"><i class="fa-solid fa-copy"></i> Copy Message</div>
        <div class="ctx-divider"></div>
        <div class="ctx-item" onclick="handleCtxAction('pin')"><i class="fa-solid fa-thumbtack"></i> Pin Message</div>
        <div class="ctx-item" onclick="handleCtxAction('forward')"><i class="fa-solid fa-share"></i> Forward</div>
        <div class="ctx-item" onclick="handleCtxAction('download')"><i class="fa-solid fa-download"></i> Download</div>
        <div class="ctx-divider"></div>
        <div class="ctx-item delete" onclick="handleCtxAction('delete-for-me')"><i class="fa-solid fa-user-xmark"></i> Delete for Me</div>
        <div class="ctx-item delete" onclick="handleCtxAction('delete-for-all')"><i class="fa-solid fa-trash-can"></i> Delete for Everyone</div>
        <div class="ctx-divider"></div>
        <div class="ctx-item" onclick="closeCtx()"><i class="fa-solid fa-xmark"></i> Cancel</div>
    </div>

    <div id="modal-delete" class="delete-modal">
        <div class="delete-content">
            <div class="delete-title">Delete Message</div>
            <div class="delete-desc">Choose how to delete this message.</div>
            <div class="delete-btns">
                <button class="delete-btn cancel" onclick="hideDeleteModal()">Cancel</button>
                <button class="delete-btn del-me" onclick="deleteForMe()">For Me</button>
                <button class="delete-btn del-all" onclick="deleteForEveryone()">For All</button>
            </div>
        </div>
    </div>

    <div id="pin-modal" class="pin-modal">
        <div class="pin-content">
            <div class="pin-title">Pin Message</div>
            <div class="pin-desc">Pin this message to the top of the chat?</div>
            <div class="pin-btns">
                <button class="pin-btn cancel" onclick="hidePinModal()">Cancel</button>
                <button class="pin-btn pin" onclick="pinMessage()">Pin</button>
            </div>
        </div>
    </div>

    <div id="batch-download-modal" class="batch-download-modal">
        <div class="batch-download-content">
            <div class="batch-download-title">Download Selected Files</div>
            <div class="batch-download-desc" id="batch-download-desc">Download 0 selected files</div>
            <div class="batch-download-btns">
                <button class="batch-download-btn cancel" onclick="hideBatchDownloadModal()">Cancel</button>
                <button class="batch-download-btn download" onclick="proceedBatchDownload()">Download</button>
            </div>
        </div>
    </div>

    <div class="compression-options" id="compression-options">
        <div class="compression-title">Image Quality (Higher = Larger File)</div>
        <input type="range" class="compression-slider" id="compression-slider" min="10" max="100" value="70">
        <div class="compression-labels">
            <span>Small</span>
            <span>Medium</span>
            <span>Large</span>
        </div>
    </div>

    <div id="lightbox" class="lightbox-overlay">
        <div class="lightbox-header">
            <button class="btn-icon" onclick="closeLightbox()"><i class="fa-solid fa-xmark"></i></button>
            <span style="color:#fff; font-weight:600; font-size:14px;" id="lightbox-title">Image</span>
            <button class="btn-icon" onclick="downloadLightbox()"><i class="fa-solid fa-download"></i></button>
        </div>
        <div class="lightbox-body">
            <img id="lightbox-img" src="" alt="lightbox" style="display:none;">
            <video id="lightbox-video" controls playsinline style="display:none;"></video>
        </div>
    </div>

    <input type="file" id="inp-gallery" accept="image/*" multiple hidden>
    <input type="file" id="inp-camera" accept="image/*" capture="environment" hidden>
    <input type="file" id="inp-video" accept="video/*" hidden>
    <input type="file" id="inp-document" accept=".pdf,.doc,.docx,.txt,.rtf" hidden>

    <div id="toast" class="toast"></div>

</div>

<script>
// ============================================================
// CONFIGURATION
// ============================================================
const SB_URL = "https://dhtbiggamuwoqurguhib.supabase.co";
const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRodGJpZ2dhbXV3b3F1cmd1aGliIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxNzY2MzksImV4cCI6MjA3ODc1MjYzOX0.-utin9W_-hSeijdHwcVSjft9biB5DSXrNOmuz5kCPlE";
const sb = supabase.createClient(SB_URL, SB_KEY);

let currentUser = null;
let currentRoom = null;
let activeSubscription = null;

let messageCache = new Map();
let userCache = new Map();
let globalUsersCache = new Map();
let notesCache = new Map();
let favorites = JSON.parse(localStorage.getItem('orbit_favorites') || '[]');
let pinnedMessages = new Map();
let selectedMessages = new Set();
let isSelectMode = false;

let replyToMsg = null;
let selectedMsg = null;
let selectedFiles = [];
let selectedFile = null;
let cropper = null;
let currentFilter = 'normal';
let uploadCanceled = false;
let deleteMessageId = null;
let editingNoteId = null;
let videoBlob = null;

let presenceInterval = null;
let localMsgCounter = 0;
let compressionQuality = 70;

let swipeStartX = 0;
let swipeStartY = 0;
let swipeThreshold = 50;
let currentSwipeElement = null;

let toastTimeout = null;

// Check for saved session on load
document.addEventListener('DOMContentLoaded', function() {
    const savedSession = localStorage.getItem('orbit_session');
    if (savedSession) {
        try {
            const sessionData = JSON.parse(savedSession);
            // Check if session is still valid (2 days)
            if (Date.now() - sessionData.timestamp < 2 * 24 * 60 * 60 * 1000) {
                document.getElementById('auth-email').value = sessionData.email;
                document.getElementById('remember-me').checked = true;
            }
        } catch(e) {
            localStorage.removeItem('orbit_session');
        }
    }
    
    // Setup password toggle
    document.getElementById('toggle-password').addEventListener('click', function() {
        const passInput = document.getElementById('auth-pass');
        const type = passInput.type === 'password' ? 'text' : 'password';
        passInput.type = type;
        this.innerHTML = type === 'password' ? '<i class="fa-solid fa-eye"></i>' : '<i class="fa-solid fa-eye-slash"></i>';
    });
});

function showToast(msg, type = 'error') {
    const el = document.getElementById('toast');
    el.innerText = msg;
    el.className = 'toast ' + (type === 'success' ? 'success' : '');
    el.classList.add('show');
    if (toastTimeout) clearTimeout(toastTimeout);
    toastTimeout = setTimeout(() => el.classList.remove('show'), 2800);
}

async function handleAuth() {
    const email = document.getElementById('auth-email').value.trim();
    const pass = document.getElementById('auth-pass').value;
    const rememberMe = document.getElementById('remember-me').checked;
    const errEl = document.getElementById('auth-err');
    errEl.style.display = 'none';

    if (!email || !pass) {
        errEl.innerText = "Please enter both email and password";
        errEl.style.display = 'block';
        return;
    }

    try {
        let { data, error } = await sb.auth.signInWithPassword({ email, password: pass });

        if (error) {
            let up = await sb.auth.signUp({ email, password: pass });
            if (up.error) {
                errEl.innerText = up.error.message;
                errEl.style.display = 'block';
                return;
            }
            data = up.data;
        }

        currentUser = data.user;
        
        // Save session if remember me is checked
        if (rememberMe) {
            localStorage.setItem('orbit_session', JSON.stringify({
                email: email,
                timestamp: Date.now()
            }));
        } else {
            localStorage.removeItem('orbit_session');
        }
        
        await initApp();
    } catch (err) {
        errEl.innerText = "Network error. Please check connection.";
        errEl.style.display = 'block';
    }
}

async function initApp() {
    document.getElementById('dash-av').innerText = currentUser.email[0].toUpperCase();
    document.getElementById('dash-id').innerText = currentUser.email.split('@')[0];

    document.getElementById('screen-auth').classList.remove('active');
    document.getElementById('screen-dash').classList.add('active');

    await updateUserPresence(true);
    startPresenceTracking();

    await loadRecentChats();
    await loadSecureChats();
    await loadFriends();
    await loadGroups();
    await loadGlobalUsers();
    await loadSecureNotes();

    setupRealtimeListeners();
    updateOnlineCounter();
}

async function updateUserPresence(isOnline) {
    try {
        await sb.from('user_presence').upsert({
            user_id: currentUser.id,
            email: currentUser.email,
            is_online: isOnline,
            last_seen: new Date().toISOString(),
            updated_at: new Date().toISOString()
        });
    } catch (e) { }
}

function startPresenceTracking() {
    presenceInterval = setInterval(() => updateUserPresence(true), 30000);
    document.addEventListener('visibilitychange', () => {
        updateUserPresence(!document.hidden);
    });
    window.addEventListener('beforeunload', () => updateUserPresence(false));
}

async function loadGlobalUsers() {
    try {
        const { data } = await sb.from('user_presence').select('*').neq('user_id', currentUser.id).order('last_seen', { ascending: false });
        const list = document.getElementById('global-users-list');
        let onlineCount = 0;

        if (!data || !data.length) {
            list.innerHTML = emptyState('fa-users', 'No other users online');
            return;
        }

        let html = '';
        data.forEach(u => {
            const isOnline = u.is_online && (Date.now() - new Date(u.last_seen).getTime() < 120000); // 2 minutes
            if (isOnline) onlineCount++;
            const name = u.email.split('@')[0];
            globalUsersCache.set(u.user_id, u);
            html += contactHTML(name[0].toUpperCase(), name, u.email, isOnline ? 'online' : 'offline',
                isOnline ? 'Online' : 'Last seen ' + timeAgo(u.last_seen),
                `startChatWithUser('${u.user_id}','${escapeHtml(name)}')`);
        });
        list.innerHTML = html;
        document.getElementById('global-online-counter').innerHTML = `<i class="fa-solid fa-circle"></i> <span>${onlineCount} online</span>`;
    } catch (e) { console.error(e); }
}

function addFriend() {
    document.getElementById('modal-add-friend').classList.add('active');
    document.getElementById('friend-email-input').focus();
}
function closeAddFriendModal() {
    document.getElementById('modal-add-friend').classList.remove('active');
    document.getElementById('friend-email-input').value = '';
}
async function sendFriendRequest() {
    const email = document.getElementById('friend-email-input').value.trim();
    if (!email) { showToast("Enter friend's email"); return; }
    if (email === currentUser.email) { showToast("Can't add yourself"); return; }
    try {
        const { data: user, error } = await sb.from('auth.users').select('id').eq('email', email).single();
        if (error || !user) { showToast('User not found'); return; }
        await sb.from('friend_requests').insert([{ from_user_id: currentUser.id, to_user_id: user.id, status: 'pending' }]);
        closeAddFriendModal();
        showToast('Friend request sent!', 'success');
    } catch (e) { showToast('Failed to send request'); }
}
async function loadFriends() {
    try {
        const { data } = await sb.from('friends').select('*, users!friends_friend_id_fkey(email, id)').eq('user_id', currentUser.id).eq('status', 'accepted');
        const list = document.getElementById('friends-list');
        if (!data || !data.length) { list.innerHTML = emptyState('fa-user-friends', 'No friends yet', 'Add friends to start chatting'); return; }
        let html = '';
        data.forEach(f => {
            const name = f.users.email.split('@')[0];
            html += contactHTML(name[0].toUpperCase(), name, 'Friend', null, null, `startChatWithUser('${f.users.id}','${escapeHtml(name)}')`);
        });
        list.innerHTML = html;
    } catch (e) { console.error(e); }
}

function createGroup() { showNewRoomModal(); }
async function loadGroups() {
    try {
        const { data } = await sb.from('room_members').select('*, rooms!inner(*)').eq('user_id', currentUser.id).eq('rooms.is_direct', false);
        const list = document.getElementById('groups-list');
        if (!data || !data.length) { list.innerHTML = emptyState('fa-users', 'No groups yet', 'Create or join a group'); return; }
        let html = '';
        data.forEach(m => {
            const r = m.rooms;
            html += `<div class="contact-item" onclick="openRoom('${r.id}','${escapeHtml(r.name)}')">
                <div class="c-avatar"><div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;border-radius:50%;background:#222;color:var(--gold);font-weight:700;"><i class="fa-solid fa-users"></i></div></div>
                <div class="c-info"><div class="c-name">${escapeHtml(r.name)}</div><div class="c-last">${escapeHtml(r.topic || 'Group chat')}</div></div></div>`;
        });
        list.innerHTML = html;
    } catch (e) { console.error(e); }
}

// ============================================================
// SECURE CHAT FUNCTIONS - FIXED
// ============================================================
async function loadSecureChats() {
    try {
        const { data } = await sb.from('rooms').select('*').eq('created_by', currentUser.id).eq('is_secure', true).order('created_at', { ascending: false });
        const list = document.getElementById('secure-chat-list');
        
        if (!data || !data.length) {
            list.innerHTML = `<div style="text-align:center;padding:40px 20px;color:var(--text-sec);">
                <i class="fa-solid fa-lock" style="font-size:40px;margin-bottom:15px;opacity:0.3;"></i>
                <div>No secure chats yet</div>
                <div style="font-size:11px;margin-top:8px;">Create a personal secure chat</div>
            </div>`;
            return;
        }
        
        let html = '';
        data.forEach(room => {
            html += `
            <div class="secure-chat-item" onclick="openRoom('${room.id}','${escapeHtml(room.name)}')">
                <div class="secure-chat-avatar">
                    <i class="fa-solid fa-lock"></i>
                </div>
                <div class="secure-chat-info">
                    <div class="secure-chat-name">${escapeHtml(room.name)}</div>
                    <div class="secure-chat-desc">${escapeHtml(room.topic || 'Personal secure chat')}</div>
                </div>
                <div class="secure-chat-status">ENCRYPTED</div>
            </div>`;
        });
        list.innerHTML = html;
    } catch (e) { console.error(e); }
}

async function createSecureChat() {
    try {
        const roomName = `Secure Chat - ${new Date().toLocaleDateString()}`;
        const { data: room, error } = await sb.from('rooms').insert([{
            name: roomName,
            topic: 'End-to-end encrypted personal chat',
            created_by: currentUser.id,
            is_direct: false,
            is_secure: true,
            participants: [currentUser.id],
            encrypted: true
        }]).select().single();
        
        if (error) throw error;
        
        await sb.from('room_members').insert([{ room_id: room.id, user_id: currentUser.id, role: 'admin' }]);
        
        showToast('Secure chat created!', 'success');
        await loadSecureChats();
        openRoom(room.id, room.name);
    } catch (e) {
        console.error(e);
        showToast('Failed to create secure chat');
    }
}

// ============================================================
// ROOM FUNCTIONS - FIXED CLICK ISSUE
// ============================================================
function showNewRoomModal() {
    document.getElementById('modal-new-room').classList.add('active');
    document.getElementById('room-name-input').value = '';
    document.getElementById('room-topic-input').value = '';
    document.getElementById('room-name-input').focus();
}
function closeNewRoomModal() {
    document.getElementById('modal-new-room').classList.remove('active');
}
async function createNewRoom() {
    const name = document.getElementById('room-name-input').value.trim();
    const topic = document.getElementById('room-topic-input').value.trim();
    if (!name) { showToast('Enter a room name'); return; }
    try {
        const { data: room, error } = await sb.from('rooms').insert([{
            name, topic: topic || null, created_by: currentUser.id, is_direct: false, participants: [currentUser.id]
        }]).select().single();
        if (error) throw error;
        await sb.from('room_members').insert([{ room_id: room.id, user_id: currentUser.id, role: 'admin' }]);
        closeNewRoomModal();
        openRoom(room.id, room.name);
    } catch (e) { showToast('Failed to create room'); }
}

async function startChatWithUser(userId, userName) {
    try {
        const { data: existing } = await sb.from('rooms').select('*').eq('is_direct', true).contains('participants', [currentUser.id, userId]);
        if (existing && existing.length) { 
            openRoom(existing[0].id, userName); 
            return; 
        }
    } catch (e) { console.error(e); }
    
    try {
        const { data: newRoom, error } = await sb.from('rooms').insert([{
            name: userName, is_direct: true, created_by: currentUser.id, participants: [currentUser.id, userId]
        }]).select().single();
        if (error) throw error;
        await sb.from('room_members').insert([
            { room_id: newRoom.id, user_id: currentUser.id },
            { room_id: newRoom.id, user_id: userId }
        ]).select();
        openRoom(newRoom.id, userName);
    } catch (e) { 
        console.error(e);
        showToast('Failed to start chat'); 
    }
}

async function loadRecentChats() {
    try {
        const { data } = await sb.from('room_members')
            .select('*, rooms!inner(*)')
            .eq('user_id', currentUser.id)
            .order('last_accessed', { ascending: false })
            .limit(20);
            
        const list = document.getElementById('chats-list');
        if (!data || !data.length) { 
            list.innerHTML = emptyState('fa-comments', 'No conversations yet', 'Start a new chat'); 
            return; 
        }

        let html = '';
        for (const member of data) {
            const r = member.rooms;
            // Get last message
            const { data: lastMsg } = await sb.from('messages')
                .select('*')
                .eq('room', r.id)
                .order('created_at', { ascending: false })
                .limit(1)
                .single();
                
            const lastText = lastMsg ? 
                (lastMsg.type === 'text' ? lastMsg.text : 
                 lastMsg.type === 'image' ? '📷 Image' : 
                 lastMsg.type === 'document' ? '📄 Document' : '📹 Video') : 
                'No messages';
            const time = lastMsg ? new Date(lastMsg.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';
            
            html += `<div class="contact-item" onclick="openRoom('${r.id}','${escapeHtml(r.name)}')">
                <div class="c-avatar"><div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;border-radius:50%;background:#222;color:var(--gold);font-weight:700;">${escapeHtml(r.name[0])}</div></div>
                <div class="c-info"><div class="c-name">${escapeHtml(r.name)}</div><div class="c-last">${escapeHtml(lastText)}</div></div>
                <div class="c-meta"><div class="c-time">${time}</div></div></div>`;
        }
        list.innerHTML = html;
    } catch (e) { 
        console.error(e);
        document.getElementById('chats-list').innerHTML = emptyState('fa-comments', 'Error loading chats', 'Try refreshing');
    }
}

// ============================================================
// NOTES FUNCTIONS
// ============================================================
async function loadSecureNotes() {
    try {
        const { data } = await sb.from('secure_notes').select('*').eq('user_id', currentUser.id).order('updated_at', { ascending: false });
        const list = document.getElementById('secure-notes-list');
        notesCache.clear();
        if (!data || !data.length) { list.innerHTML = emptyState('fa-note-sticky', 'No secure notes yet', 'Create your first secure note'); return; }
        let html = '';
        data.forEach(n => {
            notesCache.set(n.id, n);
            const short = n.content.length > 100 ? n.content.substring(0, 100) + '...' : n.content;
            html += `<div class="note-item">
                <div class="note-actions">
                    <button class="note-action-btn" onclick="editNote('${n.id}')"><i class="fa-solid fa-pen"></i></button>
                    <button class="note-action-btn" style="color:#ff4444;" onclick="deleteNote('${n.id}')"><i class="fa-solid fa-trash"></i></button>
                </div>
                <div class="note-title">${escapeHtml(n.title)}</div>
                <div class="note-content">${escapeHtml(short)}</div>
                <div class="note-date">Updated: ${new Date(n.updated_at).toLocaleDateString()}</div></div>`;
        });
        list.innerHTML = html;
    } catch (e) { console.error(e); }
}
function createNewNote() {
    editingNoteId = null;
    document.getElementById('modal-note-title').innerText = 'New Secure Note';
    document.getElementById('note-title-input').value = '';
    document.getElementById('note-content-input').value = '';
    document.getElementById('modal-note').classList.add('active');
}
function editNote(id) {
    const n = notesCache.get(id); if (!n) return;
    editingNoteId = id;
    document.getElementById('modal-note-title').innerText = 'Edit Note';
    document.getElementById('note-title-input').value = n.title;
    document.getElementById('note-content-input').value = n.content;
    document.getElementById('modal-note').classList.add('active');
}
function closeNoteModal() { document.getElementById('modal-note').classList.remove('active'); editingNoteId = null; }
async function saveNote() {
    const title = document.getElementById('note-title-input').value.trim();
    const content = document.getElementById('note-content-input').value.trim();
    if (!title || !content) { showToast('Enter both title and content'); return; }
    try {
        const nd = { user_id: currentUser.id, title, content, updated_at: new Date().toISOString() };
        if (editingNoteId) { await sb.from('secure_notes').update(nd).eq('id', editingNoteId); }
        else { nd.created_at = nd.updated_at; await sb.from('secure_notes').insert([nd]); }
        closeNoteModal();
        await loadSecureNotes();
        showToast('Note saved', 'success');
    } catch (e) { showToast('Failed to save note'); }
}
async function deleteNote(id) {
    if (!confirm('Delete this note?')) return;
    try { await sb.from('secure_notes').delete().eq('id', id); await loadSecureNotes(); }
    catch (e) { showToast('Failed to delete note'); }
}

// ============================================================
// CHAT FUNCTIONS - FIXED OPEN DELAY
// ============================================================
async function openRoom(roomId, roomName) {
    if (!roomId) {
        showToast('Cannot open chat: Invalid room');
        return;
    }
    
    currentRoom = roomId;
    document.getElementById('chat-title').innerText = roomName;
    document.getElementById('chat-status').innerText = 'Connected';

    const favBtn = document.getElementById('fav-btn');
    favBtn.innerHTML = favorites.includes(roomId) ? '<i class="fa-solid fa-star"></i>' : '<i class="fa-regular fa-star"></i>';

    // Switch screens immediately
    document.getElementById('screen-dash').classList.remove('active');
    document.getElementById('screen-chat').classList.add('active');

    // Show loading skeleton
    const feed = document.getElementById('chat-feed');
    feed.innerHTML = '<div class="skeleton" style="height:50px;margin:8px 0;"></div><div class="skeleton" style="height:35px;margin:8px 0;width:60%;align-self:flex-end;"></div><div class="skeleton" style="height:65px;margin:8px 0;"></div>';

    // Load messages in background
    setTimeout(async () => {
        try {
            await Promise.all([
                loadRoomMessages(roomId),
                loadPinnedMessages(roomId)
            ]);
            setupRoomSubscription(roomId);
        } catch (e) {
            console.error('Error loading room:', e);
            showToast('Error loading chat');
        }
        
        document.getElementById('select-toggle-btn').style.display = 'block';
        exitSelectMode();
    }, 10);
}

async function loadRoomMessages(roomId) {
    try {
        const { data } = await sb.from('messages').select('*').eq('room', roomId).order('created_at', { ascending: true }).limit(100);
        const feed = document.getElementById('chat-feed');
        feed.innerHTML = '';
        if (data && data.length) {
            renderMessages(data);
        } else {
            feed.innerHTML = '<div style="text-align:center;padding:40px 20px;color:var(--text-sec);"><i class="fa-solid fa-comment-slash" style="font-size:40px;margin-bottom:15px;opacity:0.3;"></i><div>No messages yet</div><div style="font-size:11px;margin-top:8px;">Start the conversation</div></div>';
        }
    } catch (e) { 
        console.error(e);
        document.getElementById('chat-feed').innerHTML = '<div style="text-align:center;padding:40px 20px;color:#ff4444;"><i class="fa-solid fa-exclamation-triangle"></i><div>Error loading messages</div></div>';
    }
}

async function loadPinnedMessages(roomId) {
    try {
        const { data } = await sb.from('pinned_messages').select('*, messages!inner(*)').eq('room_id', roomId).order('pinned_at', { ascending: false });
        if (data && data.length) {
            data.forEach(pin => {
                pinnedMessages.set(pin.message_id, pin);
            });
        }
    } catch (e) { console.error(e); }
}

function renderMessages(messages) {
    const feed = document.getElementById('chat-feed');
    const frag = document.createDocumentFragment();
    let lastDate = null;
    messages.forEach(msg => {
        if ((msg.deleted_by || []).includes(currentUser.id)) return;
        const d = new Date(msg.created_at).toDateString();
        if (d !== lastDate) { frag.appendChild(makeDateBadge(msg.created_at)); lastDate = d; }
        frag.appendChild(createMessageNode(msg));
        messageCache.set(msg.id, msg);
    });
    feed.appendChild(frag);
    setupSwipeListeners();
    scrollToBottom();
}

function createMessageNode(msg) {
    const isOwn = msg.sender_id === currentUser.id;
    const isPinned = pinnedMessages.has(msg.id);
    const div = document.createElement('div');
    div.className = 'msg-row ' + (isOwn ? 'own' : 'other');
    if (isPinned) div.classList.add('pinned');
    div.id = 'msg-' + msg.id;
    div.dataset.messageId = msg.id;

    const checkbox = document.createElement('div');
    checkbox.className = 'msg-checkbox';
    checkbox.onclick = (e) => {
        e.stopPropagation();
        toggleMessageSelection(msg.id, checkbox);
    };
    div.appendChild(checkbox);

    const swipeIndicator = document.createElement('div');
    swipeIndicator.className = 'swipe-reply-indicator';
    swipeIndicator.innerHTML = '<i class="fa-solid fa-reply"></i>';
    div.appendChild(swipeIndicator);

    // Enhanced long-press context menu
    let pressTimer;
    div.addEventListener('touchstart', function(e) {
        if (isSelectMode) {
            toggleMessageSelection(msg.id, checkbox);
            return;
        }
        swipeStartX = e.touches[0].clientX;
        swipeStartY = e.touches[0].clientY;
        currentSwipeElement = div;
        
        // Start long-press timer
        pressTimer = setTimeout(() => {
            selectedMsg = msg;
            openEnhancedCtx(e.touches[0]);
            clearTimeout(pressTimer);
        }, 500);
    }, { passive: true });
    
    div.addEventListener('touchmove', function(e) {
        clearTimeout(pressTimer);
        if (!currentSwipeElement || currentSwipeElement !== div || isSelectMode) return;
        
        const touch = e.touches[0];
        const deltaX = touch.clientX - swipeStartX;
        const deltaY = Math.abs(touch.clientY - swipeStartY);
        
        if (deltaY > 30) return;
        
        if (deltaX > swipeThreshold && !isOwn) {
            div.classList.add('swiping');
            e.preventDefault();
        } else {
            div.classList.remove('swiping');
        }
    }, { passive: false });
    
    div.addEventListener('touchend', function(e) {
        clearTimeout(pressTimer);
        if (!currentSwipeElement || currentSwipeElement !== div) return;
        
        const touch = e.changedTouches[0];
        const deltaX = touch.clientX - swipeStartX;
        const deltaY = Math.abs(touch.clientY - swipeStartY);
        
        if (deltaY < 30 && deltaX > swipeThreshold && !isOwn) {
            selectedMsg = msg;
            setReply(msg);
        }
        
        div.classList.remove('swiping');
        currentSwipeElement = null;
    });

    // Right-click context menu for desktop
    div.addEventListener('contextmenu', function(e) {
        e.preventDefault();
        e.stopPropagation();
        if (isSelectMode) {
            toggleMessageSelection(msg.id, checkbox);
            return;
        }
        selectedMsg = msg;
        openEnhancedCtx(e);
    });

    let tickHtml = '';
    if (isOwn) {
        if (msg._pending) { tickHtml = '<i class="fa-solid fa-clock tick-icon tick-sending"></i>'; }
        else {
            const readCount = ((msg.read_by || []).filter(id => id !== currentUser.id)).length;
            tickHtml = readCount > 0
                ? '<i class="fa-solid fa-check-double tick-icon tick-read"></i>'
                : '<i class="fa-solid fa-check tick-icon tick-dlvd"></i>';
        }
    }

    const time = new Date(msg.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

    let replyHtml = '';
    if (msg.reply_to) {
        replyHtml = `<div class="msg-reply-context">
            <div class="reply-author">${escapeHtml(msg.reply_to.username)}</div>
            <div class="reply-preview">${escapeHtml(msg.reply_to.text || 'Media')}</div>
        </div>`;
    }

    let content = '';
    if (msg.type === 'image' && msg.attachments) {
        // Handle multiple images in grid
        if (msg.attachments.length > 1) {
            content = renderImageGrid(msg.attachments, msg.text);
        } else {
            const url = getMediaUrl(msg.attachments[0]);
            content = `<img src="${url}" alt="image" class="single-image" onclick="openLightbox('${url}','image','${escapeHtml(msg.text||'Image')}')">`;
        }
    } else if (msg.type === 'video' && msg.attachments && msg.attachments[0]) {
        const url = getMediaUrl(msg.attachments[0]);
        content = `<video src="${url}" poster="" controls playsinline style="max-width:200px;border-radius:8px;background:#000;margin-bottom:4px;"></video>`;
    } else if (msg.type === 'document' && msg.attachments && msg.attachments[0]) {
        const url = getMediaUrl(msg.attachments[0]);
        content = `<div class="doc-bubble" onclick="downloadFile('${url}','${escapeHtml(msg.text||'document')}')">
            <i class="fa-solid fa-file-pdf doc-icon"></i>
            <div class="doc-info"><div class="doc-name">${escapeHtml(msg.text || 'Document')}</div><div class="doc-sub">Tap to download</div></div></div>`;
    } else {
        content = `<div style="white-space:pre-wrap;word-break:break-word;">${escapeHtml(msg.text || '')}</div>`;
    }

    let pinBadge = '';
    if (isPinned) {
        pinBadge = ' <i class="fa-solid fa-thumbtack pin-badge"></i>';
    }

    div.innerHTML = `<div class="msg-bubble">${replyHtml}${content}<div class="msg-meta">${time}${pinBadge} ${tickHtml}</div></div>`;
    return div;
}

function renderImageGrid(attachments, text) {
    const count = attachments.length;
    let gridClass = 'grid-1';
    if (count === 2) gridClass = 'grid-2';
    else if (count === 3) gridClass = 'grid-3';
    else if (count >= 4) gridClass = 'grid-4';
    
    let html = `<div class="image-grid-container ${gridClass}">`;
    
    const maxShow = Math.min(count, 4);
    for (let i = 0; i < maxShow; i++) {
        const url = getMediaUrl(attachments[i]);
        const alt = text || `Image ${i+1}`;
        
        if (i === 3 && count > 4) {
            html += `<div class="image-grid-item more-overlay" onclick="openImageGridLightbox('${attachments.map(a => getMediaUrl(a)).join('|')}','${escapeHtml(text||'Images')}')" style="background-image:url('${url}');background-size:cover;background-position:center;">+${count-4}</div>`;
        } else {
            html += `<img src="${url}" alt="${alt}" class="image-grid-item" onclick="openImageGridLightbox('${attachments.map(a => getMediaUrl(a)).join('|')}','${escapeHtml(text||'Images')}',${i})">`;
        }
    }
    
    html += '</div>';
    return html;
}

function openImageGridLightbox(imageUrls, title, startIndex = 0) {
    const urls = imageUrls.split('|');
    const lightbox = document.getElementById('lightbox');
    const img = document.getElementById('lightbox-img');
    const video = document.getElementById('lightbox-video');
    const lightboxTitle = document.getElementById('lightbox-title');
    
    lightboxTitle.innerText = title || 'Images';
    img.style.display = 'block';
    video.style.display = 'none';
    img.src = urls[startIndex];
    
    // Store all images for navigation
    lightbox._images = urls;
    lightbox._currentIndex = startIndex;
    
    // Update lightbox actions for multiple images
    const actions = document.querySelector('.lightbox-actions');
    if (actions) actions.remove();
    
    const newActions = document.createElement('div');
    newActions.className = 'lightbox-actions';
    newActions.innerHTML = `
        <button class="lightbox-btn" onclick="prevImage()"><i class="fa-solid fa-chevron-left"></i></button>
        <button class="lightbox-btn" onclick="downloadLightbox()"><i class="fa-solid fa-download"></i></button>
        <button class="lightbox-btn" onclick="nextImage()"><i class="fa-solid fa-chevron-right"></i></button>
    `;
    lightbox.appendChild(newActions);
    
    lightbox.classList.add('active');
}

function prevImage() {
    const lightbox = document.getElementById('lightbox');
    if (!lightbox._images || lightbox._images.length <= 1) return;
    
    lightbox._currentIndex = (lightbox._currentIndex - 1 + lightbox._images.length) % lightbox._images.length;
    document.getElementById('lightbox-img').src = lightbox._images[lightbox._currentIndex];
}

function nextImage() {
    const lightbox = document.getElementById('lightbox');
    if (!lightbox._images || lightbox._images.length <= 1) return;
    
    lightbox._currentIndex = (lightbox._currentIndex + 1) % lightbox._images.length;
    document.getElementById('lightbox-img').src = lightbox._images[lightbox._currentIndex];
}

function setupSwipeListeners() {
    const feed = document.getElementById('chat-feed');
    const rows = feed.querySelectorAll('.msg-row');
    rows.forEach(row => {
        row.addEventListener('touchstart', handleSwipeStart, { passive: true });
        row.addEventListener('touchmove', handleSwipeMove, { passive: false });
        row.addEventListener('touchend', handleSwipeEnd, { passive: true });
    });
}

function handleSwipeStart(e) {
    if (isSelectMode) return;
    swipeStartX = e.touches[0].clientX;
    swipeStartY = e.touches[0].clientY;
    currentSwipeElement = e.currentTarget;
}

function handleSwipeMove(e) {
    if (!currentSwipeElement || isSelectMode) return;
    
    const touch = e.touches[0];
    const deltaX = touch.clientX - swipeStartX;
    const deltaY = Math.abs(touch.clientY - swipeStartY);
    
    if (deltaY > 30) return;
    
    if (deltaX > swipeThreshold && !currentSwipeElement.classList.contains('own')) {
        currentSwipeElement.classList.add('swiping');
        e.preventDefault();
    } else {
        currentSwipeElement.classList.remove('swiping');
    }
}

function handleSwipeEnd(e) {
    if (!currentSwipeElement || isSelectMode) return;
    
    const touch = e.changedTouches[0];
    const deltaX = touch.clientX - swipeStartX;
    const deltaY = Math.abs(touch.clientY - swipeStartY);
    
    if (deltaY < 30 && deltaX > swipeThreshold && !currentSwipeElement.classList.contains('own')) {
        const msgId = currentSwipeElement.dataset.messageId;
        const msg = messageCache.get(msgId);
        if (msg) {
            selectedMsg = msg;
            setReply(msg);
        }
    }
    
    currentSwipeElement.classList.remove('swiping');
    currentSwipeElement = null;
}

// ============================================================
// ENHANCED CONTEXT MENU
// ============================================================
function openEnhancedCtx(e) {
    const menu = document.getElementById('ctx-menu-enhanced');
    const overlay = document.getElementById('ctx-overlay');
    overlay.classList.remove('hide');

    let x = e.clientX || (e.touches && e.touches[0] && e.touches[0].clientX) || 100;
    let y = e.clientY || (e.touches && e.touches[0] && e.touches[0].clientY) || 200;

    const vp = document.getElementById('app-viewport').getBoundingClientRect();
    if (x + 220 > vp.right) x = vp.right - 225;
    if (y + 300 > vp.bottom) y = vp.bottom - 305;
    if (x < vp.left) x = vp.left + 5;
    if (y < vp.top) y = vp.top + 5;

    menu.style.left = (x - vp.left) + 'px';
    menu.style.top = (y - vp.top) + 'px';
    setTimeout(() => menu.classList.add('active'), 10);
}

function closeCtx() {
    document.getElementById('ctx-menu-enhanced').classList.remove('active');
    setTimeout(() => document.getElementById('ctx-overlay').classList.add('hide'), 200);
}

function handleCtxAction(action) {
    closeCtx();
    if (!selectedMsg) return;
    
    switch(action) {
        case 'reply':
            setReply(selectedMsg);
            break;
        case 'copy':
            navigator.clipboard.writeText(selectedMsg.text || '').then(() => showToast('Copied!', 'success'));
            break;
        case 'pin':
            showPinModal();
            break;
        case 'download':
            if (selectedMsg.attachments && selectedMsg.attachments[0]) {
                const url = getMediaUrl(selectedMsg.attachments[0]);
                downloadFile(url, selectedMsg.text || 'file');
            } else {
                showToast('No file to download');
            }
            break;
        case 'forward':
            showToast('Forward coming soon');
            break;
        case 'delete-for-me':
            deleteMessageId = selectedMsg.id;
            deleteForMe();
            break;
        case 'delete-for-all':
            deleteMessageId = selectedMsg.id;
            deleteForEveryone();
            break;
    }
}

// ============================================================
// UPLOAD FUNCTIONS - FIXED FILE SELECTION ISSUE
// ============================================================
function compressImage(file) {
    return new Promise((resolve, reject) => {
        if (!file.type.startsWith('image/')) {
            resolve(file);
            return;
        }
        
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                let width = img.width;
                let height = img.height;
                const maxSize = 2048;
                
                if (width > height) {
                    if (width > maxSize) {
                        height *= maxSize / width;
                        width = maxSize;
                    }
                } else {
                    if (height > maxSize) {
                        width *= maxSize / height;
                        height = maxSize;
                    }
                }
                
                canvas.width = width;
                canvas.height = height;
                ctx.drawImage(img, 0, 0, width, height);
                
                canvas.toBlob((blob) => {
                    const compressedFile = new File([blob], file.name, {
                        type: 'image/jpeg',
                        lastModified: Date.now()
                    });
                    resolve(compressedFile);
                }, 'image/jpeg', compressionQuality / 100);
            };
            img.onerror = reject;
            img.src = e.target.result;
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
    });
}

async function sendMessage() {
    const input = document.getElementById('msg-input');
    const text = input.value.trim();

    if (selectedFiles.length > 0) { await sendQueuedFiles(); return; }
    if (!text) return;

    input.value = '';
    input.style.height = 'auto';

    const now = new Date().toISOString();
    const payload = {
        room: currentRoom,
        sender_id: currentUser.id,
        username: currentUser.email.split('@')[0],
        text: text,
        type: 'text',
        read_by: [currentUser.id],
        created_at: now
    };

    if (replyToMsg) {
        payload.reply_to = { id: replyToMsg.id, username: replyToMsg.username, text: replyToMsg.type === 'text' ? replyToMsg.text : 'Media' };
        cancelReply();
    }

    const localId = '__local_' + (++localMsgCounter);
    const localMsg = { ...payload, id: localId, _pending: true };
    messageCache.set(localId, localMsg);
    const node = createMessageNode(localMsg);
    node.classList.add('sending');
    document.getElementById('chat-feed').appendChild(node);
    scrollToBottom();

    try {
        const { data, error } = await sb.from('messages').insert([payload]).select().single();
        if (error) throw error;

        const localNode = document.getElementById('msg-' + localId);
        if (localNode) localNode.remove();
        messageCache.delete(localId);

        if (!messageCache.has(data.id)) {
            messageCache.set(data.id, data);
            document.getElementById('chat-feed').appendChild(createMessageNode(data));
            scrollToBottom();
        }
    } catch (e) {
        const localNode = document.getElementById('msg-' + localId);
        if (localNode) { localNode.classList.remove('sending'); localNode.classList.add('failed'); }
        showToast('Failed to send message');
    }
}

async function sendQueuedFiles() {
    if (!selectedFiles.length) return;
    uploadCanceled = false;

    const filesToSend = [...selectedFiles];
    clearMediaPreview();
    
    showUploadOverlay(true, filesToSend[0].name);
    updateUploadLabel(filesToSend[0].name, 1, filesToSend.length);

    // Group images together
    const imageFiles = filesToSend.filter(f => f.type.startsWith('image/'));
    const otherFiles = filesToSend.filter(f => !f.type.startsWith('image/'));
    
    // Send non-image files individually
    for (let i = 0; i < otherFiles.length; i++) {
        if (uploadCanceled) break;
        const file = otherFiles[i];
        await uploadAndSendFile(file, i + 1, otherFiles.length);
    }
    
    // Send images as a group
    if (imageFiles.length > 0) {
        await uploadAndSendImageGroup(imageFiles);
    }

    showUploadOverlay(false);
}

async function uploadAndSendFile(file, current, total) {
    if (uploadCanceled) return;
    
    updateUploadLabel(file.name, current, total);
    
    try {
        const compressedFile = await compressImage(file);
        const storagePath = await uploadToStorage(compressedFile);
        if (uploadCanceled) return;

        const type = compressedFile.type.startsWith('image') ? 'image' : 
                    compressedFile.type.startsWith('video') ? 'video' : 'document';
        
        const payload = {
            room: currentRoom,
            sender_id: currentUser.id,
            username: currentUser.email.split('@')[0],
            text: compressedFile.name,
            attachments: [storagePath],
            type: type,
            read_by: [currentUser.id],
            created_at: new Date().toISOString()
        };

        const { data, error } = await sb.from('messages').insert([payload]).select().single();
        if (error) throw error;

        if (!messageCache.has(data.id)) {
            messageCache.set(data.id, data);
            document.getElementById('chat-feed').appendChild(createMessageNode(data));
            scrollToBottom();
        }
        
        animateProgress((current / total) * 100, (current / total) * 100, 300);
    } catch (e) {
        console.error('Upload error:', e);
        showToast(`Failed to send ${file.name}`);
    }
}

async function uploadAndSendImageGroup(imageFiles) {
    if (uploadCanceled || !imageFiles.length) return;
    
    updateUploadLabel(`${imageFiles.length} images`, 1, 1);
    
    try {
        const uploadPromises = imageFiles.map(file => uploadToStorage(file));
        const storagePaths = await Promise.all(uploadPromises);
        
        if (uploadCanceled) return;

        const payload = {
            room: currentRoom,
            sender_id: currentUser.id,
            username: currentUser.email.split('@')[0],
            text: `${imageFiles.length} images`,
            attachments: storagePaths,
            type: 'image',
            read_by: [currentUser.id],
            created_at: new Date().toISOString()
        };

        const { data, error } = await sb.from('messages').insert([payload]).select().single();
        if (error) throw error;

        if (!messageCache.has(data.id)) {
            messageCache.set(data.id, data);
            document.getElementById('chat-feed').appendChild(createMessageNode(data));
            scrollToBottom();
        }
        
        animateProgress(100, 100, 300);
    } catch (e) {
        console.error('Image group upload error:', e);
        showToast('Failed to send images');
    }
}

async function uploadToStorage(file) {
    try {
        // Sanitize filename
        const originalName = file.name || 'file';
        const safeName = originalName.replace(/[^a-zA-Z0-9._-]/g, '_');
        const timestamp = Date.now();
        const random = Math.random().toString(36).substring(7);
        const filePath = `${currentRoom}/${timestamp}_${random}_${safeName}`;
        
        const { data, error } = await sb.storage
            .from('chat-assets')
            .upload(filePath, file, { 
                cacheControl: '3600',
                upsert: false
            });
        
        if (error) {
            // If upload fails, use data URL as fallback
            console.warn('Upload failed, using base64 fallback:', error);
            return await fileToDataURL(file);
        }
        
        return filePath;
    } catch (error) {
        console.error('Upload failed, using base64 fallback:', error);
        return await fileToDataURL(file);
    }
}

function fileToDataURL(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsDataURL(file);
    });
}

function getMediaUrl(path) {
    if (path.startsWith('data:')) {
        return path;
    }
    return `${SB_URL}/storage/v1/object/public/chat-assets/${path}`;
}

function showUploadOverlay(show, fileName) {
    document.getElementById('upload-overlay').classList.toggle('hide', !show);
    if (show) {
        document.getElementById('upload-pct').innerText = '0%';
        setProgressRing(0);
        document.getElementById('upload-file-name').innerText = fileName || '';
    }
}
function updateUploadLabel(name, current, total) {
    document.getElementById('upload-file-name').innerText = total > 1 ? `${current}/${total} — ${name}` : name;
    animateProgress(0, (current / total) * 100, 500);
}
function animateProgress(from, to, duration) {
    const start = performance.now();
    function tick(now) {
        const pct = Math.min(((now - start) / duration) * (to - from) + from, to);
        document.getElementById('upload-pct').innerText = Math.round(pct) + '%';
        setProgressRing(pct / 100);
        if (pct < to && !uploadCanceled) requestAnimationFrame(tick);
    }
    requestAnimationFrame(tick);
}
function setProgressRing(pct) {
    const circle = document.querySelector('.progress-ring__circle');
    const offset = 326 - (pct * 326);
    circle.style.strokeDashoffset = offset;
}
function cancelUpload() {
    uploadCanceled = true;
    showUploadOverlay(false);
    clearMediaPreview();
}

// ============================================================
// SELECTION MODE FUNCTIONS - FIXED RED BADGE POSITION
// ============================================================
function toggleSelectMode() {
    isSelectMode = !isSelectMode;
    const feed = document.getElementById('chat-feed');
    const selectBtn = document.getElementById('select-toggle-btn');
    const toolbar = document.getElementById('selection-toolbar');
    
    if (isSelectMode) {
        feed.querySelectorAll('.msg-row').forEach(row => {
            row.classList.add('select-mode');
        });
        selectBtn.innerHTML = '<i class="fa-solid fa-xmark"></i>';
        toolbar.classList.add('active');
    } else {
        feed.querySelectorAll('.msg-row').forEach(row => {
            row.classList.remove('select-mode');
        });
        selectBtn.innerHTML = '<i class="fa-solid fa-check-double"></i>';
        toolbar.classList.remove('active');
        clearSelection();
    }
    updateSelectionCount();
}

function exitSelectMode() {
    isSelectMode = false;
    const feed = document.getElementById('chat-feed');
    const selectBtn = document.getElementById('select-toggle-btn');
    const toolbar = document.getElementById('selection-toolbar');
    
    feed.querySelectorAll('.msg-row').forEach(row => {
        row.classList.remove('select-mode');
    });
    selectBtn.innerHTML = '<i class="fa-solid fa-check-double"></i>';
    toolbar.classList.remove('active');
    clearSelection();
}

function toggleMessageSelection(msgId, checkbox) {
    if (!isSelectMode) return;
    
    if (selectedMessages.has(msgId)) {
        selectedMessages.delete(msgId);
        checkbox.classList.remove('checked');
    } else {
        selectedMessages.add(msgId);
        checkbox.classList.add('checked');
    }
    updateSelectionCount();
}

function updateSelectionCount() {
    const count = selectedMessages.size;
    document.getElementById('selection-count').textContent = `${count} selected`;
}

function clearSelection() {
    selectedMessages.clear();
    document.querySelectorAll('.msg-checkbox').forEach(cb => {
        cb.classList.remove('checked');
    });
    updateSelectionCount();
}

async function deleteSelectedMessages() {
    if (selectedMessages.size === 0) return;
    
    if (confirm(`Delete ${selectedMessages.size} selected messages for you?`)) {
        try {
            for (const msgId of selectedMessages) {
                const msg = messageCache.get(msgId);
                if (msg) {
                    const deletedBy = [...(msg.deleted_by || []), currentUser.id];
                    await sb.from('messages')
                        .update({ deleted_by: deletedBy })
                        .eq('id', msgId);
                    
                    const el = document.getElementById('msg-' + msgId);
                    if (el) el.remove();
                    messageCache.delete(msgId);
                }
            }
            showToast(`Deleted ${selectedMessages.size} messages`, 'success');
            clearSelection();
            exitSelectMode();
        } catch (e) {
            console.error('Delete error:', e);
            showToast('Failed to delete messages');
        }
    }
}

function downloadSelectedMessages() {
    if (selectedMessages.size === 0) return;
    
    let mediaCount = 0;
    selectedMessages.forEach(msgId => {
        const msg = messageCache.get(msgId);
        if (msg && (msg.type === 'image' || msg.type === 'video' || msg.type === 'document')) {
            mediaCount++;
        }
    });
    
    if (mediaCount === 0) {
        showToast('No media files in selection');
        return;
    }
    
    document.getElementById('batch-download-desc').textContent = `Download ${mediaCount} selected file${mediaCount > 1 ? 's' : ''}`;
    document.getElementById('batch-download-modal').classList.add('active');
}

function hideBatchDownloadModal() {
    document.getElementById('batch-download-modal').classList.remove('active');
}

async function proceedBatchDownload() {
    const mediaUrls = [];
    const mediaNames = [];
    
    selectedMessages.forEach(msgId => {
        const msg = messageCache.get(msgId);
        if (msg && msg.attachments) {
            msg.attachments.forEach((att, idx) => {
                const url = getMediaUrl(att);
                mediaUrls.push(url);
                mediaNames.push(msg.text || `file_${msgId}_${idx}`);
            });
        }
    });
    
    if (mediaUrls.length === 0) {
        showToast('No files to download');
        return;
    }
    
    hideBatchDownloadModal();
    
    if (mediaUrls.length === 1) {
        downloadFile(mediaUrls[0], mediaNames[0]);
    } else {
        for (let i = 0; i < mediaUrls.length; i++) {
            setTimeout(() => {
                downloadFile(mediaUrls[i], mediaNames[i]);
            }, i * 300);
        }
        showToast(`Downloading ${mediaUrls.length} files...`, 'success');
    }
    
    exitSelectMode();
}

// ============================================================
// PIN MESSAGE FUNCTIONS
// ============================================================
function showPinModal() {
    document.getElementById('pin-modal').classList.add('active');
}

function hidePinModal() {
    document.getElementById('pin-modal').classList.remove('active');
}

async function pinMessage() {
    if (!selectedMsg) return;
    
    try {
        const { error } = await sb.from('pinned_messages').insert([{
            room_id: currentRoom,
            message_id: selectedMsg.id,
            pinned_by: currentUser.id,
            pinned_at: new Date().toISOString()
        }]);
        
        if (error) throw error;
        
        pinnedMessages.set(selectedMsg.id, selectedMsg);
        const msgElement = document.getElementById('msg-' + selectedMsg.id);
        if (msgElement) {
            msgElement.classList.add('pinned');
        }
        
        hidePinModal();
        showToast('Message pinned', 'success');
    } catch (e) {
        console.error('Pin error:', e);
        showToast('Failed to pin message');
    }
}

// ============================================================
// DELETE FUNCTIONS
// ============================================================
function showDeleteModal() {
    if (!selectedMsg) return;
    deleteMessageId = selectedMsg.id;
    document.getElementById('modal-delete').classList.add('active');
}

function hideDeleteModal() {
    document.getElementById('modal-delete').classList.remove('active');
    deleteMessageId = null;
}

async function deleteForMe() {
    if (!deleteMessageId) return;
    
    try {
        const msg = messageCache.get(deleteMessageId);
        if (!msg) {
            showToast('Message not found');
            hideDeleteModal();
            return;
        }
        
        const deletedBy = [...(msg.deleted_by || []), currentUser.id];
        
        const { error } = await sb.from('messages')
            .update({ deleted_by: deletedBy })
            .eq('id', deleteMessageId);
            
        if (error) throw error;
        
        const el = document.getElementById('msg-' + deleteMessageId);
        if (el) el.remove();
        messageCache.delete(deleteMessageId);
        
        showToast('Message deleted', 'success');
    } catch (e) { 
        console.error('Delete error:', e);
        showToast('Failed to delete'); 
    } finally {
        deleteMessageId = null;
    }
}

async function deleteForEveryone() {
    if (!deleteMessageId) return;
    
    const msg = messageCache.get(deleteMessageId);
    if (!msg) {
        showToast('Message not found');
        hideDeleteModal();
        return;
    }
    
    if (msg.sender_id !== currentUser.id) { 
        showToast("Can only delete your own messages for everyone"); 
        hideDeleteModal(); 
        return; 
    }
    
    try {
        const { error } = await sb.from('messages')
            .delete()
            .eq('id', deleteMessageId);
            
        if (error) throw error;
        
        const el = document.getElementById('msg-' + deleteMessageId);
        if (el) el.remove();
        messageCache.delete(deleteMessageId);
        
        showToast('Message deleted for everyone', 'success');
    } catch (e) { 
        console.error('Delete error:', e);
        showToast('Failed to delete'); 
    } finally {
        deleteMessageId = null;
    }
}

// ============================================================
// EDITOR FUNCTIONS
// ============================================================
function showImageEditor(file) {
    selectedFile = file;
    const reader = new FileReader();
    reader.onload = e => {
        const modal = document.getElementById('modal-editor');
        const img = document.getElementById('image-to-edit');
        img.src = e.target.result;
        img.style.filter = 'none';
        currentFilter = 'normal';
        document.querySelectorAll('.filter-item').forEach(el => el.classList.remove('active'));
        document.getElementById('filter-normal').classList.add('active');
        modal.classList.remove('hide');

        if (cropper) { cropper.destroy(); cropper = null; }
        setTimeout(() => {
            cropper = new Cropper(img, {
                viewMode: 1, dragMode: 'move', autoCropArea: 1,
                restore: false, guides: true, center: true,
                highlight: true, cropBoxMovable: true, cropBoxResizable: true,
                background: false, toggleDragModeOnDblclick: false
            });
        }, 100);
    };
    reader.readAsDataURL(file);
}

function cropperCrop() { if (cropper) cropper.setDragMode('crop'); }
function cropperRotate(deg) { if (cropper) cropper.rotate(deg); }
function cropperFlip() { if (cropper) cropper.flip('horizontal'); }

function applyFilter(name, el) {
    currentFilter = name;
    const img = document.getElementById('image-to-edit');
    const filters = { normal: 'none', grayscale: 'grayscale(100%)', sepia: 'sepia(100%)', brightness: 'brightness(1.3)', contrast: 'contrast(1.5)', saturate: 'saturate(2)' };
    img.style.filter = filters[name] || 'none';
    document.querySelectorAll('.filter-item').forEach(i => i.classList.remove('active'));
    if (el) el.classList.add('active');
}

async function finishEditing() {
    if (!cropper) return;
    
    cropper.getCroppedCanvas().toBlob(async blob => {
        const file = new File([blob], 'edited_image.jpg', { type: 'image/jpeg' });
        uploadCanceled = false;
        showUploadOverlay(true, 'edited_image.jpg');
        
        try {
            const storagePath = await uploadToStorage(file);
            if (uploadCanceled) return;

            const payload = {
                room: currentRoom, 
                sender_id: currentUser.id,
                username: currentUser.email.split('@')[0],
                text: 'Edited image', 
                attachments: [storagePath],
                type: 'image', 
                read_by: [currentUser.id],
                created_at: new Date().toISOString()
            };
            
            const { data, error } = await sb.from('messages').insert([payload]).select().single();
            if (error) throw error;
            
            if (!messageCache.has(data.id)) {
                messageCache.set(data.id, data);
                document.getElementById('chat-feed').appendChild(createMessageNode(data));
                scrollToBottom();
            }
            
            cancelEditor();
        } catch (e) { 
            console.error('Editor send error:', e);
            showToast('Failed to send image'); 
        }
        
        showUploadOverlay(false);
    }, 'image/jpeg', 0.92);
}

function cancelEditor() {
    document.getElementById('modal-editor').classList.add('hide');
    if (cropper) { cropper.destroy(); cropper = null; }
    selectedFile = null;
}

function showVideoPreview(file) {
    videoBlob = file;
    const url = URL.createObjectURL(file);
    const modal = document.getElementById('modal-video-preview');
    const video = document.getElementById('video-preview');
    video.src = url;
    modal.classList.remove('hide');
}
function cancelVideoPreview() {
    document.getElementById('modal-video-preview').classList.add('hide');
    videoBlob = null;
}

async function sendVideoPreview() {
    if (!videoBlob) return;
    const file = videoBlob;
    cancelVideoPreview();
    uploadCanceled = false;
    showUploadOverlay(true, file.name);
    
    try {
        const storagePath = await uploadToStorage(file);
        if (uploadCanceled) return;
        
        const payload = {
            room: currentRoom, 
            sender_id: currentUser.id,
            username: currentUser.email.split('@')[0],
            text: file.name, 
            attachments: [storagePath],
            type: 'video', 
            read_by: [currentUser.id],
            created_at: new Date().toISOString()
        };
        
        const { data, error } = await sb.from('messages').insert([payload]).select().single();
        if (error) throw error;
        
        if (!messageCache.has(data.id)) {
            messageCache.set(data.id, data);
            document.getElementById('chat-feed').appendChild(createMessageNode(data));
            scrollToBottom();
        }
        
        videoBlob = null;
    } catch (e) {
        console.error('Video send error:', e);
        showToast('Failed to send video');
        videoBlob = null;
    }
    
    showUploadOverlay(false);
}

function trimVideo() { showToast('Trim feature coming soon', 'success'); }

// ============================================================
// MEDIA HANDLING - FIXED FILE SELECTION ISSUE
// ============================================================
function openMediaPicker() {
    document.getElementById('sheet-media').classList.add('active');
}
function closeMediaSheet() {
    document.getElementById('sheet-media').classList.remove('active');
}
function triggerFile(type) {
    closeMediaSheet();
    switch (type) {
        case 'gallery': 
            document.getElementById('compression-options').classList.add('active');
            setTimeout(() => {
                document.getElementById('inp-gallery').click();
            }, 300);
            break;
        case 'camera': 
            document.getElementById('compression-options').classList.remove('active');
            document.getElementById('inp-camera').click(); 
            break;
        case 'video': 
            document.getElementById('compression-options').classList.remove('active');
            document.getElementById('inp-video').click(); 
            break;
        case 'document': 
            document.getElementById('compression-options').classList.remove('active');
            document.getElementById('inp-document').click(); 
            break;
    }
}

// Fix file input handlers to prevent issues
document.getElementById('inp-gallery').addEventListener('change', function(e) {
    document.getElementById('compression-options').classList.remove('active');
    const files = Array.from(e.target.files || []);
    if (!files.length) return;
    
    // Filter only images and videos
    const validFiles = files.filter(f => f.type.startsWith('image/') || f.type.startsWith('video/'));
    if (validFiles.length === 0) {
        showToast('Please select only images or videos');
        return;
    }
    
    selectedFiles = validFiles;
    renderMediaPreviewStrip();
    e.target.value = '';
});

document.getElementById('inp-camera').addEventListener('change', function(e) {
    const file = e.target.files && e.target.files[0];
    if (!file) return;
    if (file.type.startsWith('image/')) {
        showImageEditor(file);
    }
    e.target.value = '';
});

document.getElementById('inp-video').addEventListener('change', function(e) {
    const file = e.target.files && e.target.files[0];
    if (!file) return;
    if (file.type.startsWith('video/')) {
        showVideoPreview(file);
    } else {
        showToast('Please select a video file');
    }
    e.target.value = '';
});

document.getElementById('inp-document').addEventListener('change', function(e) {
    const file = e.target.files && e.target.files[0];
    if (!file) return;
    selectedFiles = [file];
    sendQueuedFiles();
    e.target.value = '';
});

// Compression slider
document.getElementById('compression-slider').addEventListener('input', function() {
    compressionQuality = this.value;
});

function renderMediaPreviewStrip() {
    const strip = document.getElementById('media-preview-strip');
    strip.innerHTML = '';
    strip.classList.remove('hide');

    selectedFiles.forEach((file, i) => {
        const thumb = document.createElement('div');
        thumb.className = 'media-preview-thumb';

        if (file.type.startsWith('video')) {
            thumb.innerHTML = `<video src="${URL.createObjectURL(file)}"></video><div class="play-overlay"><i class="fa-solid fa-play"></i></div><button class="remove-media-btn" onclick="removeMedia(${i})"><i class="fa-solid fa-xmark"></i></button>`;
        } else {
            const reader = new FileReader();
            reader.onload = ev => { 
                thumb.innerHTML = `<img src="${ev.target.result}" alt="preview"><button class="remove-media-btn" onclick="removeMedia(${i})"><i class="fa-solid fa-xmark"></i></button>`; 
            };
            reader.readAsDataURL(file);
        }
        strip.appendChild(thumb);
    });

    updateSendBtn();
}

function removeMedia(index) {
    selectedFiles.splice(index, 1);
    if (!selectedFiles.length) clearMediaPreview();
    else renderMediaPreviewStrip();
}

function clearMediaPreview() {
    selectedFiles = [];
    const strip = document.getElementById('media-preview-strip');
    strip.innerHTML = '';
    strip.classList.add('hide');
    updateSendBtn();
}

function updateSendBtn() {
    const btn = document.getElementById('send-btn');
    // Remove existing badge
    const existingBadge = btn.querySelector('.send-btn-badge');
    if (existingBadge) {
        existingBadge.remove();
    }
    
    if (selectedFiles.length > 0) {
        const badge = document.createElement('span');
        badge.className = 'send-btn-badge';
        badge.textContent = selectedFiles.length;
        btn.appendChild(badge);
        btn.innerHTML = '<i class="fa-solid fa-paper-plane" style="font-size:14px;"></i>';
        btn.appendChild(badge);
    } else {
        btn.innerHTML = '<i class="fa-solid fa-paper-plane" style="font-size:14px;"></i>';
    }
}

function setReply(msg) {
    replyToMsg = msg;
    document.getElementById('reply-bar').classList.remove('hide');
    document.getElementById('reply-user').innerText = 'Replying to ' + msg.username;
    document.getElementById('reply-text').innerText = msg.type === 'text' ? msg.text : '📷 Media';
    document.getElementById('msg-input').focus();
}
function cancelReply() {
    replyToMsg = null;
    document.getElementById('reply-bar').classList.add('hide');
}

function openLightbox(url, type, title) {
    document.getElementById('lightbox').classList.add('active');
    document.getElementById('lightbox-title').innerText = title || 'Image';
    if (type === 'image') {
        document.getElementById('lightbox-img').style.display = 'block';
        document.getElementById('lightbox-img').src = url;
        document.getElementById('lightbox-video').style.display = 'none';
    } else {
        document.getElementById('lightbox-video').style.display = 'block';
        document.getElementById('lightbox-video').src = url;
        document.getElementById('lightbox-img').style.display = 'none';
    }
    document.getElementById('lightbox')._url = url;
    document.getElementById('lightbox')._title = title;
    
    // Remove existing actions if any
    const actions = document.querySelector('.lightbox-actions');
    if (actions) actions.remove();
}
function closeLightbox() {
    document.getElementById('lightbox').classList.remove('active');
}
function downloadLightbox() {
    const url = document.getElementById('lightbox')._url;
    const title = document.getElementById('lightbox')._title || 'file';
    if (url) downloadFile(url, title);
}
function downloadFile(url, name) {
    const a = document.createElement('a');
    a.href = url; 
    a.download = name; 
    a.target = '_blank';
    document.body.appendChild(a); 
    a.click(); 
    document.body.removeChild(a);
    showToast('Download started', 'success');
}

function navBack() {
    document.getElementById('screen-chat').classList.remove('active');
    document.getElementById('screen-dash').classList.add('active');
    currentRoom = null;
    replyToMsg = null;
    clearMediaPreview();
    exitSelectMode();
    if (activeSubscription) { 
        sb.removeChannel(activeSubscription); 
        activeSubscription = null; 
    }
    loadRecentChats();
}

// ============================================================
// TAB SWITCHING - FIXED CLICK ISSUE
// ============================================================
function switchTab(btn) {
    if (!btn) return;
    
    // Remove active class from all tabs
    document.querySelectorAll('.tab-btn').forEach(b => {
        b.classList.remove('active');
    });
    
    // Add active class to clicked tab
    btn.classList.add('active');
    
    // Hide all tab contents
    document.querySelectorAll('[id^="tab-"]').forEach(el => {
        el.classList.add('hide');
    });
    
    // Show selected tab content
    const tab = btn.getAttribute('data-tab');
    const tabContent = document.getElementById('tab-' + tab);
    if (tabContent) {
        tabContent.classList.remove('hide');
    }
    
    // Load data for the tab if needed
    switch(tab) {
        case 'global':
            loadGlobalUsers();
            break;
        case 'notes':
            loadSecureNotes();
            break;
        case 'friends':
            loadFriends();
            break;
        case 'groups':
            loadGroups();
            break;
        case 'secure-chat':
            loadSecureChats();
            break;
        case 'chats':
            loadRecentChats();
            break;
    }
}

function toggleFavorite() {
    if (!currentRoom) return;
    const idx = favorites.indexOf(currentRoom);
    if (idx === -1) { 
        favorites.push(currentRoom); 
        document.getElementById('fav-btn').innerHTML = '<i class="fa-solid fa-star"></i>'; 
        showToast('Added to favorites', 'success');
    }
    else { 
        favorites.splice(idx, 1); 
        document.getElementById('fav-btn').innerHTML = '<i class="fa-regular fa-star"></i>'; 
        showToast('Removed from favorites', 'success');
    }
    localStorage.setItem('orbit_favorites', JSON.stringify(favorites));
}

// ============================================================
// REALTIME LISTENERS - IMPROVED ONLINE COUNTER
// ============================================================
function setupRealtimeListeners() {
    // Presence channel
    sb.channel('presence_ch')
        .on('postgres_changes', { 
            event: '*', 
            schema: 'public', 
            table: 'user_presence' 
        }, payload => {
            if (payload.new && payload.new.user_id !== currentUser.id) {
                globalUsersCache.set(payload.new.user_id, payload.new);
                updateOnlineCounter();
            }
        }).subscribe();
        
    // Also listen for INSERT and UPDATE separately to catch all changes
    sb.channel('presence_inserts')
        .on('postgres_changes', {
            event: 'INSERT',
            schema: 'public',
            table: 'user_presence'
        }, payload => {
            if (payload.new && payload.new.user_id !== currentUser.id) {
                globalUsersCache.set(payload.new.user_id, payload.new);
                updateOnlineCounter();
            }
        }).subscribe();
}

function setupRoomSubscription(roomId) {
    if (activeSubscription) {
        sb.removeChannel(activeSubscription);
    }

    activeSubscription = sb.channel('room_' + roomId)
        .on('postgres_changes', { 
            event: 'INSERT', 
            schema: 'public', 
            table: 'messages', 
            filter: `room=eq.${roomId}` 
        }, payload => {
            const msg = payload.new;
            if (messageCache.has(msg.id)) return;
            if ((msg.deleted_by || []).includes(currentUser.id)) return;

            messageCache.set(msg.id, msg);
            const node = createMessageNode(msg);
            document.getElementById('chat-feed').appendChild(node);
            const feed = document.getElementById('chat-feed');
            if (feed.scrollHeight - feed.clientHeight - feed.scrollTop < 120) scrollToBottom();
        })
        .on('postgres_changes', { 
            event: 'UPDATE', 
            schema: 'public', 
            table: 'messages', 
            filter: `room=eq.${roomId}` 
        }, payload => {
            const msg = payload.new;
            if ((msg.deleted_by || []).includes(currentUser.id)) {
                const el = document.getElementById('msg-' + msg.id);
                if (el) el.remove();
                messageCache.delete(msg.id);
                selectedMessages.delete(msg.id);
                updateSelectionCount();
            }
        })
        .on('postgres_changes', { 
            event: 'DELETE', 
            schema: 'public', 
            table: 'messages', 
            filter: `room=eq.${roomId}` 
        }, payload => {
            const el = document.getElementById('msg-' + payload.old.id);
            if (el) el.remove();
            messageCache.delete(payload.old.id);
            selectedMessages.delete(payload.old.id);
            updateSelectionCount();
        })
        .on('postgres_changes', { 
            event: 'INSERT', 
            schema: 'public', 
            table: 'pinned_messages', 
            filter: `room_id=eq.${roomId}` 
        }, payload => {
            const pin = payload.new;
            pinnedMessages.set(pin.message_id, pin);
            const msgEl = document.getElementById('msg-' + pin.message_id);
            if (msgEl) {
                msgEl.classList.add('pinned');
            }
        })
        .subscribe();
}

document.getElementById('msg-input').addEventListener('input', function () {
    this.style.height = 'auto';
    this.style.height = this.scrollHeight + 'px';
});

function handleKeyDown(e) {
    if (e.key === 'Enter' && !e.shiftKey) { 
        e.preventDefault(); 
        sendMessage(); 
    }
}

function scrollToBottom() {
    const feed = document.getElementById('chat-feed');
    setTimeout(() => { 
        if (feed) {
            feed.scrollTop = feed.scrollHeight; 
        }
    }, 40);
}

function makeDateBadge(dateStr) {
    const div = document.createElement('div');
    div.className = 'date-badge';
    div.innerHTML = '<span>' + getFriendlyDate(dateStr) + '</span>';
    return div;
}

function getFriendlyDate(s) {
    const d = new Date(s), today = new Date();
    if (d.toDateString() === today.toDateString()) return 'Today';
    const y = new Date(today); y.setDate(y.getDate() - 1);
    if (d.toDateString() === y.toDateString()) return 'Yesterday';
    return d.toLocaleDateString();
}

function timeAgo(ts) {
    const diff = Date.now() - new Date(ts).getTime();
    if (diff < 60000) return 'just now';
    if (diff < 3600000) return Math.floor(diff / 60000) + 'm ago';
    if (diff < 86400000) return Math.floor(diff / 3600000) + 'h ago';
    return Math.floor(diff / 86400000) + 'd ago';
}

function updateOnlineCounter() {
    const onlineUsers = Array.from(globalUsersCache.values()).filter(u => 
        u.is_online && (Date.now() - new Date(u.last_seen).getTime() < 120000)
    );
    const onlineCount = onlineUsers.length;
    
    document.getElementById('online-counter').innerHTML = `<i class="fa-solid fa-circle"></i> <span>${onlineCount} online</span>`;
    document.getElementById('global-online-counter').innerHTML = `<i class="fa-solid fa-circle"></i> <span>${onlineCount} online</span>`;
}

function escapeHtml(str) {
    if (str == null) return '';
    return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}

function contactHTML(avatar, name, sub, statusClass, statusText, onclick) {
    let statusBadge = statusClass ? `<div class="c-status ${statusClass}"></div>` : '';
    let metaHtml = statusText ? `<div class="c-meta"><div class="c-time">${statusText}</div></div>` : '';
    return `<div class="contact-item" onclick="${onclick}">
        <div class="c-avatar"><div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;border-radius:50%;background:#222;color:var(--gold);font-weight:700;">${escapeHtml(avatar)}</div>${statusBadge}</div>
        <div class="c-info"><div class="c-name">${escapeHtml(name)}</div><div class="c-last">${escapeHtml(sub)}</div></div>${metaHtml}</div>`;
}

function emptyState(icon, title, sub) {
    return `<div style="text-align:center;padding:40px 20px;color:var(--text-sec);">
        <i class="fa-solid ${icon}" style="font-size:40px;margin-bottom:15px;opacity:0.3;"></i>
        <div>${title}</div>${sub ? `<div style="font-size:11px;margin-top:8px;">${sub}</div>` : ''}</div>`;
}

// Close compression options when clicking outside
document.addEventListener('click', function(e) {
    const compressionOptions = document.getElementById('compression-options');
    if (compressionOptions.classList.contains('active') && 
        !compressionOptions.contains(e.target) && 
        e.target.id !== 'inp-gallery') {
        compressionOptions.classList.remove('active');
    }
});

// Close media sheet when clicking overlay
document.getElementById('sheet-media').addEventListener('click', function(e) { 
    if (e.target === this) closeMediaSheet(); 
});

// Initialize with better online counter
setTimeout(() => {
    if (currentUser) {
        updateOnlineCounter();
    }
}, 2000);

console.log('%c🚀 Orbit Pro - ALL BUGS FIXED!', 'color: #34C759; font-size: 18px; font-weight: bold;');
console.log('%c✅ Issues Fixed:', 'color: #FFD700; font-size: 14px;');
console.log('%c1. Media selection issue resolved', 'color: #00ff00;');
console.log('%c2. Red badge position fixed', 'color: #00ff00;');
console.log('%c3. Chat opening delay fixed', 'color: #00ff00;');
console.log('%c4. Tab clicking issue fixed', 'color: #00ff00;');
console.log('%c5. Remember login + eye icon added', 'color: #00ff00;');
console.log('%c6. Secure chat opening fixed', 'color: #00ff00;');
console.log('%c7. Online counter improved', 'color: #00ff00;');
</script>
</body>
</html>